AIOHubの「/dashboard/posts を押すとログインに戻る」が f145bcd0 デプロイ後も継続しています。
ErrorBoundary の 401 強制遷移は潰したので、次は middleware 307 が原因かをコード側で確定し、確実に止めてください（ユーザーにDevToolsやVercelログ作業をさせない前提で、アプリ側に診断導線を作って解決する）。

ゴール
 • 「ログインに戻る」が起きたときに、原因が **307（middleware）**か 別の遷移かをアプリ自身が記録・表示できる
 • 307 が原因なら、Cookie判定の問題を確実に潰す（prefetch/edge/cookie属性含め）

Step 1（必須）：原因確定のための“自己診断”を実装
 1. middleware でリダイレクトする直前に、必ずレスポンスヘッダーを付与する
例：

 • x-auth-redirect-reason: soft-auth-no-cookie または strict-auth-getuser-failed
 • x-auth-cookie-names: sb-...（値は禁止、名前だけ）
 • x-request-id（既にあるなら統一して必ず付与）

 2. ダッシュボード側（DashboardPageShell か共通の薄いClient）で

 • 「直前のナビゲーションが 307 を踏んだか」を検出できるようにする
（例：/auth/login に飛ばされた場合、クエリに reason/requestId を付与して、UIに“原因コード”を表示）

ユーザーにログを見させない。UIに「原因コード」と「requestId」を出す。

Step 2（必須）：307の根本対策

以下の順に潰す（推測禁止、Step1の証拠で断定してから）
 • Cookie名パターン漏れ（既に正規表現対応済みだが、実際に matchedCookieNames が空ならここ）
 • prefetch が絡む誤判定（Nextの prefetch/edge の可能性）：prefetch時は“常に通す”など安全側へ倒す
 • Cookie属性（Secure/SameSite/Domain/Path）問題：サーバ側で観測できる Cookie 名が空ならここ

Step 3（再発防止）
 • /dashboard/** 配下では、クライアント側で /auth/login に飛ぶコードを禁止（CI grepでfail）
 • middleware の “soft-auth redirect” が発生したら 必ず reason を残す（観測可能に固定）

Step 4（検証）
 • typecheck/build
 • ローカル→本番で /dashboard → /dashboard/posts を繰り返し、ログイン送還が消えること
 • 消えない場合は、UIに出た reason/requestId を根拠に次の修正に進む

成果物：変更ファイル一覧、原因の断定（reasonベース）、修正内容、再発防止策。

⸻

/o/luxucare の「表示が欠ける」件

DB側は anonで services=3 / posts=1 が安定して取れるところまで確認済みなので、アプリ側（キャッシュ or 条件分岐）の問題です。

この件は「ログイン戻り（幹）」を止めてからやるのが正攻法ですが、並行するなら
 • revalidate tag org:luxucare を叩いてキャッシュを確実に更新
（REVALIDATE_TOKEN が必要）

⸻
