あなたはClaude Codeです。AIOHub本番のログイン問題を最短で収束させます。推測で終わらせず、サーバー側の診断エンドポイントとUI上の判定で「原因がどれか」を確定して直してください。

0) 事実（Supabase SQLで確定済み）

対象user_id: f57ee6af-e55e-4852-87db-d5a2c59f64ac
 • auth.users に存在する
 • email: ggg.golf.66@gmail.com
 • email_confirmed_at あり（メール確認済み）
 • auth.identities.provider = 'email'（= Email/Passwordログイン可能な区分）
 • last_sign_in_at = 2026-01-17 02:53:34+00（最近サインインが記録されている）
→ DBの「ユーザー不在/未確認/OAuth専用」ではない。

従って、現象 invalid_credentials と Cookie=0 の原因候補は次の3つに絞られる：
A. 入力パスワードが違う（UIがエラーでも /dashboard に進んでしまう等のUX不備含む）
B. 本番アプリが別Supabaseプロジェクト/別キー/別URLを向いている（環境変数や参照のズレ）
C. ログイン成功しても Cookie が発行・保存されていない（@supabase/ssrの使い方・SameSite/Domain/Path/secure 等）

1) 完了条件（ここに到達するまで終わらない）
 1. /auth/login で成功ログイン後、GET /api/health/auth-snapshot が
 • hasSbAuthCookie: true
 • totalCookieCount > 0
 • getUserStatus: success
 2. ログイン失敗（invalid_credentials等）では
 • 絶対に /dashboard に遷移しない
 • 画面に code/message を表示する
 3. 本番がどのSupabaseを向いているか、ユーザー作業ゼロで判定できる
 • /api/health/supabase-env でURL/ProjectRef/anonKey先頭/host/protoを返す

2) まず「切り分け」を実装（これが最優先）

Task A: /api/health/supabase-env を追加（必須）
 • NEXT_PUBLIC_SUPABASE_URL の hostname
 • URLから projectRef を抽出して返す（例: chyicolujwhkycpkxbej）
 • NEXT_PUBLIC_SUPABASE_ANON_KEY の先頭8〜12文字だけ返す（漏洩しない）
 • server が見ている host/proto も返す
 • これを本番で叩けば「別プロジェクト参照」が即断定できる

Task B: /api/auth/login のレスポンス契約を固定（必須）

Route Handlerで signInWithPassword を行う。
 • 失敗時：HTTP 401 で { ok:false, code, message, requestId }
 • 成功時：HTTP 200 で { ok:true, requestId }
 • さらにレスポンスヘッダで診断可能にする：
 • x-auth-request-id
 • x-auth-set-cookie-count（Set-Cookieの数）
 • x-auth-cookie-names（名前だけ）
 • x-auth-supabase-ref（envから抽出したprojectRef）
※「手動でaccess_token/refresh_tokenをcookieに直書き」しているなら一旦戻してよい。
　最初は @supabase/ssr公式パターンでcookiesに確実に反映することを最優先。

Task C: LoginForm の挙動を必ず修正（必須）
 • /api/auth/login が 401 を返したら router.push/replace を絶対にしない
 • 401時は画面に code/message を表示
 • 200 のときだけ /dashboard へ遷移

3) 追加で「ログイン成功なのにCookieが0」を潰す

Task D: Cookieがセットされているかをサーバーで断定できるようにする
 • /api/auth/login 成功時に cookies().getAll() を見て
 • sb--auth-token / refresh-token が存在しているかをログに出す
 • /api/health/auth-snapshot は既にあるので、
 • cookieHeaderPresent
 • allCookieNames
 • matchedCookieNames
を必ず返して「ブラウザから送られてきているか」を確定できるようにする

4) 期待する検証フロー（ユーザー作業最小）
 1. GET /api/health/supabase-env をブラウザで開くだけで「向いてるSupabase」が分かる
 2. /auth/login でログイン → DevToolsで /api/auth/login を見る
 • 401なら code/message が画面に出て終わり（/dashboardに行かない）
 • 200なら x-auth-set-cookie-count>=1 が見える
 3. 直後に /api/health/auth-snapshot
 • hasSbAuthCookie:true / getUserStatus:success で合格

5) 実装後の報告フォーマット（必須）
 • デプロイSHA
 • /api/health/supabase-env の返却例
 • /api/auth/login 成功時のレスポンスヘッダ例（x-auth-set-cookie-count等）
 • auth-snapshot 成功例（hasSbAuthCookie:true）

以上。
