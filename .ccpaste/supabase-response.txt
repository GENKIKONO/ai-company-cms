あなたはClaude Code。AIOHubの「幹」を固定するために、DashboardPageShell を useAuthState()/determineAuthState に完全統合して、認証状態の判定ロジックを一箇所に集約し、二重実装を排除して収束させてください。

ゴール（完了条件）
 1. /dashboard と /dashboard/posts が、AuthState に従って必ず同じ挙動になる（ズレない）
 2. Cookieが無い/壊れている時に DB fetch を走らせない（無駄な401/UNAUTHORIZED連発を止める）
 3. 画面に出るエラーは必ず authState と whyBlocked と requestId で説明できる
 4. リリース前ゲートとして、最低限の自動テスト（orスモーク）を追加して再発を防ぐ

⸻

Task 1: DashboardPageShell を完全統合（最優先）

対象: src/components/dashboard/DashboardPageShell.tsx

要件
 • 既存の「独自判定ロジック」を削除し、useAuthState() の戻り値のみで分岐する
 • 分岐はこの4状態に限定する（それ以外の判定は禁止）
 • UNAUTHENTICATED: ログイン導線（ただし window.location で飛ばさない。UIで案内＋ログインボタン）
 • AUTH_FAILED: ログイン失敗/セッション欠落をUI表示（再ログイン/再試行の導線）
 • AUTHENTICATED_NO_ORG: 組織未設定のUI（作成/参加の導線）
 • AUTHENTICATED_READY: ここで初めて dashboard のデータ取得を開始してよい
 • Cookieなし or AUTH_FAILED の時は、organization_members / organizations / v_dashboard_ を一切叩かない*
 • UIに必ず以下を表示できるようにする（開発用でもOK）
 • authState
 • whyBlocked
 • requestId（既存のID利用）

⸻

Task 2: useAuthState の責務を確定（ブレ禁止）

対象: src/lib/auth/use-auth-state.ts と src/lib/auth/determine-auth-state.ts

要件
 • whyBlocked は必ず機械的に決まるようにする（曖昧文言禁止）
 • AUTH判定の順序を固定する
 1. Cookie有無
 2. getUser 成否
 3. membership 有無
 4. ready
 • どこで membership を取るか（APIか直接か）を統一する
 • DashboardPageShell側で勝手に membership を取りに行かない（Hook側に寄せる）

⸻

Task 3: API/ログの収束（ユーザー確認を最小化）

対象: /api/health/auth-snapshot

要件
 • authState, whyBlocked, requestId を常に返す
 • 可能なら cookieHeaderPresent, totalCookieCount も返す（既にあれば維持）
 • 401が出る場合は「どの段階で詰まったか」を whyBlocked に固定文言で出す

⸻

Task 4: 再発防止ゲート（最低限でいい）
 • 既存のCIチェック（forbiddenLoginRedirect）に加えて、
 • DashboardPageShell 内に createClient().from('organization_members') などが残っていないことを grep で検査（Hook以外からの直叩きを禁止）
 • 可能なら Playwright で
 • 未ログイン → authState=UNAUTHENTICATED を確認
 • （E2E用アカウントが無理なら）少なくとも auth-snapshot のフォーマット検査だけでも入れる

⸻

禁止事項
 • “進めますか？”の確認で止めない。統合してPR/commitまで完了させる
 • 追加の大型設計（別StateMachine拡張など）に広げない。今回の目的は「幹の統一」だけ
 • /auth/login への強制リダイレクト復活は禁止（CIで落ちるようにする）

⸻

成果物（出力して）
 • 変更ファイル一覧
 • DashboardPageShell の分岐が AuthState だけになったことの証拠（抜粋でOK）
 • 「UNAUTHENTICATED / AUTH_FAILED の時にDB fetchが走らない」ことの確認（ログ or grep）

⸻

これで「診断の幹」と「表示の幹」が一致し、同じ問題をぐるぐるしなくなります。
