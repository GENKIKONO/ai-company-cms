あなたはAIOHubリポジトリの「監査・設計準拠チェック担当」です。
憶測・ハルシネーション禁止。必ずコード根拠（ファイルパス・行番号・実際の設定値/SQL）を添えて報告してください。
このStepでは「修正はしない」。報告と修正計画（実装順序）までを作成してください。

⸻

目的
 1. 既存の コアアーキテクチャ/ルールに対して、現状がどこまで準拠しているかを棚卸し
 2. **ギャップ（違反/例外/未定義/二重実装/技術負債）**を「影響度×再発性×修正コスト」で分類
 3. 世界商用レベルに向けて、最短で収束する修正ロードマップ（小さいPR単位）を提示
 4. 不足している前提条件（DB定義/環境変数/運用仕様）があれば、“何を確認すべきか” を明文化（必要なら次にDBへ聞く）

⸻

前提（守ること）
 • 既存の機能・データ・コアアーキテクチャは破壊しない
 • “推測で直す”のは禁止（例：「多分env」などNG）
 • ルール違反を見つけたら、**「どのルールのどの条項に抵触」**まで書く
 • ただし、ルール自体が曖昧なら「ルール側の未定義」として指摘する

⸻

監査対象（必須）

A) 認証・ログイン戻り問題の根本原因の棚卸し（修正なし）
 • 症状：/dashboard/posts 等でログイン画面へ戻る、Vercel Logsで401が多発、ブラウザで No API key found in request が出た
 • 期待：**「どの経路で apikey が欠落しているか」**を断定（どの supabase client / fetch / env を使っているか）
 • 出力：発火点（ファイル:行）、欠落要因（env名/参照方法/クライアント生成）、再発条件、影響範囲

B) コアアーキテクチャ準拠チェック（Shell/Contract/IA/ルート）
 • Shell境界：DashboardPageShell / InfoPageShell / AdminPageShell / UserShell / ops例外…の実態と準拠
 • ReadContract / WriteContract：secure view経由、直テーブル参照例外、/manageの扱い、例外の文書化状況
 • IA単一ソース：nav.ts / routes.ts の単一性、ハードコード残存、重複定義
 • middleware設計：soft/strictの方針、cookie判定、supabase authとの整合、redirect loopの可能性

C) 公開ページとダッシュボードのデータ整合性
 • /o/[slug] の公開データ取得（RLS依存・明示フィルタ・cache/ISR/revalidate）
 • ダッシュボードCRUDと公開表示で「件数が変動」「紐づきが変わる」原因候補を、DB設計/クエリ/ポリシーの観点で列挙
 • status と is_published の二重基準、RLSポリシー乱立の実態（ただし“DB側の事実”が必要なら次Stepで質問事項に落とす）

D) 品質ゲート（世界商用レベルの最低条件）
 • 無限リトライ/無限fetch/無限リロードの芽
 • ログのPII混入、warnスパム
 • env未設定/欠落時に即座に検知できる仕組み（起動時チェック等）
 • CI（既にある check:tailwind 等）に、今の問題を再発させないための最小のチェック案（追加するとしたら何か）

⸻

出力形式（この順番で）
 1. 現状準拠サマリ（✅/🟡/❌の3段階）
 2. ギャップ一覧表
 • ルール名 / 事実（file:line） / 影響（ユーザー/セキュリティ/運用） / 再発性 / 修正方針（最小差分） / 依存（DB確認が必要か）
 3. 最短収束ロードマップ（PR分割）
 • PR#1: ログイン戻り・apikey欠落の再発防止（※修正案は“計画”として）
 • PR#2: 認証/ミドルウェア/クライアント生成の統一
 • PR#3: 公開データ整合（公開判定・RLS整理の準備）
 • …のように、必ず「先に直すべき順」で
 4. 次にDB（Supabase）へ確認すべき質問セット（必要な場合のみ）
 • “何をSQLで確認するか”を箇条書き（このStepではまだSQLを書かなくていい。次のプロンプトで書く）

⸻

まずこの監査レポートを作成してください。修正は行わず、報告と修正計画までで止めてください。
