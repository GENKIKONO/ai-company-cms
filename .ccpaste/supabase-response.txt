あなたは “修正して本番ビルドが通る状態にする” のがゴールです。推測は禁止、証拠（grep結果/ビルド結果）で進めてください。まず原因特定→最小差分修正→再発防止の順でやってください。

⸻

目的

Vercel の npm run build で落ちている以下エラーを確実に解消する：
 • src/lib/supabase.ts の import 'server-only' が原因で Failed to compile
 • 追加で next.config.js の turbopack が invalid option と警告

⸻

Phase 1: 事実確認（必須：どこが supabase.ts を読んでいるか断定）
 1. import 参照の全棚卸し（行番号付き）

 • src/lib/supabase.ts を import している箇所を全部列挙し、ファイルパス + 行番号 + import文を報告
 • 検索対象: src/** と ルート直下の **/*.ts(x)
 • キーワード例：@/lib/supabase, ../lib/supabase, from 'src/lib/supabase'

 2. そのうち **「pages 互換文脈」または「Client Component」**に入っている import を特定

 • 具体例："use client" のあるファイル、middleware.ts、app/**/page.tsx でもクライアント境界になっているもの、components/** など
 • ここで “Vercel が pages/ と言っているが実際に pages がない” 問題の説明は要らない。
Vercel がそう判断する import 経路（import chain）を必ず出すこと。

⸻

Phase 2: 最小差分で直す（server-only を「正しく置く」）

方針：server-only を消して誤魔化すのは禁止。
server-only を “サーバー専用モジュール” に隔離し、クライアント側から絶対に辿れない import 構造にする。

2-1) ファイル分割（これを正にする）
 • src/lib/supabase/server.ts を新設し、ここに server-only + server client を置く
 • ここだけが import 'server-only' を持つ
 • createClient（@supabase/supabase-js）や server用 helper もここ
 • src/lib/supabase.ts は 廃止 or client-safe にする
 • 推奨：src/lib/supabase.ts を 互換の薄い barrel にしない（クライアントが誤って掴むため）
 • どうしても残すなら：export * from './supabase/server' のような “危険な再export” は禁止
 • 既存の src/lib/supabase/client.ts（browser用）はそのまま使う

2-2) import を一括置換（壊さず）
 • サーバーで使う箇所は @/lib/supabase/server へ
 • **クライアント（hooks/components）**は @/lib/supabase/client へ
 • “どっちか分からない” ものは、そのファイルが server component か client component かを判定してから置換する（推測禁止）

2-3) 再発防止（どっちか必須）

どちらか片方は必ず入れる：

A) eslint / tsconfig の import 制約（推奨）
 • client 側から @/lib/supabase/server を import したら CI で落ちるルール

または

B) src/lib/supabase/server.ts の先頭に明確なコメント + 名前で誤用を防ぐ（最低限）

⸻

Phase 3: next.config.js 警告を止める（確実に）

Vercel の警告：
Unrecognized key(s) in object: 'turbopack'

対応：
 • next.config.js から turbopack キーを削除して警告をゼロにする
（Next のバージョン差でまた燃えるので、今は余計なキーを持たない方針）

⸻

Phase 4: 検証（ここまでやって初めて「直った」と言える）
 1. ローカルで：

 • npm run build が PASS
 • npm run typecheck が PASS

 2. 変更後に以下を grep で保証：

 • import 'server-only' が src/lib/supabase/server.ts 以外に存在しない
 • @/lib/supabase.ts が client から import されていない（0件）

⸻

出力フォーマット（守って）
 • (1) どの import chain が原因だったか（ファイル→ファイルの順で）
 • (2) 変更ファイル一覧（最小差分）
 • (3) npm run build / typecheck の結果
 • (4) Vercel が通る見込みの説明（短く、断定は build 成功後のみ）

⸻

注意
 • “直ったはず” は禁止。build が通った事実が出るまで完了宣言しない
 • コードの挙動変更は最小限。今回は ビルドを通すことが最優先

⸻

これで進めてください。

⸻
