以下は「結果の要約」と「次に実行すべき具体的コマンド／チェックリスト」です。主導権はこちらで持ち、完了までガイドします。DB側は既に整備済みなので、コード側は確定手順のみです。

1) 変更の確定（ブロッキング対応）
実行コマンド

git add -A
git commit -m "feat(org-groups): use approve_join_request RPC; cleanup ternary; misc text tweak"
git push
目的

未コミットの修正（5ファイル＋削除ファイル）を確定し、デプロイ不整合を防止
検証

git status でクリーンであることを確認
2) E2Eテスト（ブロッキング対応）
手動チェック（最小）

join request 作成 → 承認（approve）→ org_group_members へ反映されること
join request を拒否（reject）→ ステータスが rejected になること
正常系・異常系（無効な invite_code）で適切なエラーを返すこと
自動テスト（任意だが推奨）

npm run test:e2e または既存のE2Eランナーがあれば実行
成功しない場合は、失敗ケースのログを共有してください。こちらで即応します
3) 型定義の再生成（高優先度）
実行コマンド

npx supabase gen types typescript --project-id $PROJECT_ID > src/types/supabase.ts
目的

現状 as any を多用しているため、実DBに一致した新しい型を再生成して型の齟齬を解消
検証

npm run typecheck で型エラーを洗い出し
supabaseAdmin as any 等、DB操作周りの as any 24件から順次除去
注意

生成後に大きく差分が出ます。PRを分けて小さくマージする方針で進めます
4) 追加の技術負債削減（高〜中優先度）
優先順で順に実施（小さくPRを切る）

P1: DB操作まわりの as any 24件を除去（型を付け直す）
P2: 残りの as any 63件を除去
P2: TODO.*SUPABASE_TYPE 45件の取捨選択と対応
P3: from('site_settings') → from('cms_site_settings') へ移行（既に互換ビューで動作はしているため、影響範囲小を見極めて段階移行）
P3: 非原子的DB操作の棚卸し（approve_join_request と同様にRPCへ集約）
検証

各PRで npm run typecheck / npm run build がゼロエラーであること
主要ユースケースの手動動作確認*
5) ログとRLSの健全性チェック（中〜低優先度）
E2E後の確認

APIログにエラーが出ていないか（Supabase Dashboard → Logs）
Admin APIが service_role で意図通りRLSをバイパスしていることを確認
フロント経由のauthenticatedユーザーは、RLSで適切に制御されているかをサンプリング検証
将来の改善

RLSポリシーの棚卸し・不足インデックスの補完
互換ビューの段階撤廃（参照先を正規テーブルへ統一）
6) 実施済みのDB変更（再掲・認識合わせ）
カラム追加
public.ai_interview_sessions: finalized_at, finalized_by, created_by
互換ビュー
public.site_settings → cms_site_settings を参照
public.reports → ai_monthly_reports を参照
RPC（トランザクション化）
public.approve_join_request(uuid, text) 追加（SECURITY DEFINER、postgres/supabase_admin のみ）
インデックス
public.rate_limit_logs_202601: idx_rate_limit_logs_202601_ip_ts_desc を作成
これらにより、あなたの最新の完了報告に記載の「コード側修正」はDBと整合が取れています。以降はコミット・テスト・型再生成の3点を順に実行すれば、完成状態の品質が担保されます。

問題が発生した場合は、失敗したコマンドとエラーメッセージを貼ってください。即時に次の是正策を提示します。



