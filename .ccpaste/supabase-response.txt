あなたはClaude Code。AIOHub本番の最優先バグは「ログイン後もCookieが0で、ダッシュボードが未認証扱いになる」こと。DB側（RLS/権限/ビュー）はOK、supabaseプロジェクト参照も一致（supabase-envで projectRef=chyicolujwhkycpkxbej / projectMismatch=false）。
**“Claude側でできる検証はClaudeが完結させ、ユーザー確認はClaudeだけでは不可能な箇所に限定する”**方針で収束させる。

完了条件（Definition of Done）
 1. 自動テスト or 自動検証ログで「ログイン成功→Cookie発行→auth-snapshot success」まで確認できる
 2. 失敗時はログイン画面で理由が確定表示され、ダッシュボードへ遷移しない
 3. ユーザーがやる確認は「ブラウザの実ユーザー環境でしか起きない差分（Cookie保存/拡張機能/ブラウザ設定）」の確認だけ

⸻

Phase 1（Claudeだけで完結させる：自動検証の整備）

Task A: サーバー側で100%確定できるログを揃える（必須）
 • /api/auth/login（Email/Password）成功時・失敗時の両方で、必ず以下をVercel Logsに出す（requestId付き）
 • result: success/fail
 • errorCode / errorMessage（failのみ）
 • setCookieHeaderPresent（true/false）
 • setCookieCount（数だけ。cookieの中身は出さない）
 • cookieNames（安全な範囲：sb-***-auth-token, refresh-token の名称だけ）
 • response status
 • /api/health/auth-snapshot はすでにあるので、cookieHeaderPresentも返す（なければ追加）

Task B: “200なのにCookie=0”を成功扱いしない（必須）

LoginFormの契約を固定：
 • /api/auth/login が 401 → 絶対に遷移しない（画面に code/message 表示）
 • /api/auth/login が 200 → 直後に /api/health/auth-snapshot を fetch
 • hasSbAuthCookie=true & getUserStatus=success になった場合のみ /dashboard へ遷移
 • 200なのに Cookie=0 のままなら「Cookie保存/送信失敗」として画面に確定表示し、遷移しない

Task C: Claudeが自動で動作確認できる“E2E(ヘッドレス)”を入れる（必須）
 • Playwrightで /auth/login → ログイン → /api/health/auth-snapshot の success を確認するテストを追加
 • 認証情報は Vercel/Supabase の環境変数（E2E専用アカウント）で注入できるようにする
 • もし本番でE2Eアカウントが用意できないなら、Preview環境で必ず通す（Productionはユーザー確認へ）
 • テストは「ログイン成功後に sb-*-auth-token がブラウザCookieに存在する」まで確認する

Task D: パスワード要因を切り離す（高レバレッジ）
 • Magic Link（OTP）ログインを追加（/api/auth/magiclink）
 • 目的：password起因かCookie起因かを即切り分け
 • 成功/失敗をログイン画面に表示（ユーザーが迷わない）

⸻

Phase 2（ユーザー確認が必要な部分：Claudeだけでは確定できない）

※ここは「ユーザーにやらせる」ではなく、「ユーザー環境でしか起きない差分を確認」するために最小限依頼する。

ユーザーに依頼するのは次の2点だけ：
 1. ブラウザで /auth/login 実行後、Networkで /api/auth/login のレスポンスヘッダを確認
 • x-auth-set-cookie-count が 2 以上か
 • Set-Cookie が返っているか（ヘッダが返ってるのに保存されないならブラウザ要因が濃厚）
 2. 直後に /api/health/auth-snapshot を開き、hasSbAuthCookie/totalCookieCount を確認
→ この2点だけで「サーバーはCookieを返してるのに保存されない」か「そもそも返してない」かが確定する

⸻

禁止事項（ループ防止）
 • “ユーザーが試すまで分からない”を理由に実装を止めない
 • 状態機械などの大規模リファクタは、Cookie問題の収束後
 • 401/200の契約が曖昧なまま遷移させない（200+Cookie0は失敗扱い）
