あなたの要望どおり、調査→証拠→最小修正→再発防止を一気通貫でやらせるプロンプトを作りました。
（SQL実行はあなたがSupabaseに投げる段取り、という条件も入れています）

⸻

✅ Claude Code 用プロンプト（これをそのまま貼って実行）

目的
本番で発生している以下2点を「推測なし」で原因確定し、最小修正で解消し、再発防止まで入れる。
 • (A) /dashboard/posts を押すとログイン画面へ戻る
 • (B) Dashboardで「メンバーシップは確認できるが、組織詳細取得中にエラー」が出る
 • (C) /o/luxucare で services/posts 等が消えて基本情報しか出ない（表示が揺れる/欠ける）

制約
 • 憶測で修正しない。必ず「本番の証拠（Status code / ログ / エラー文字列）」→「原因断定」→「修正」
 • SQLは私がSupabaseに投げる。あなたは「投げるべきSQL」を作るだけ
 • 直せたと言うのは「本番で確認できる手順」と「確認ポイント」を提示できた時だけ

⸻

Phase 1：本番で“何が起きているか”を確定（最優先）
 1. /dashboard/posts クリック時の実態を確定

 • ブラウザで発生するリクエストのうち「最初に失敗したもの」を特定できるように、以下を用意：
 • middleware：リダイレクト時に x-request-id を付与（既にあるなら確認）
 • 307の場合：レスポンスヘッダの Location と x-request-id を記録できるようにする
 • 401/403/500の場合：Dashboard側で “原因エラー本文（supabase error code/message）” を画面に表示できるようにする（PIIは出さない）

 2. /api/health/deployment と /api/health/auth-snapshot を本番で使って、証拠を揃える

 • ここは私がcurlできる前提で、返却JSONに以下を含める：
 • sha（コミット）
 • requestPath
 • hasSbAuthCookie / matchedCookieNames（値ではなくcookie名のみ）
 • middlewareWouldRedirect（true/false）
 • 可能なら supabase側 getUser 成否（成功/失敗のみ、PIIなし）

→ ここまでで「ログイン戻り」が 307（cookie判定）なのか、401/403（API権限）なのかを確定する。

⸻

Phase 2：症状B（組織詳細取得エラー）の原因断定
 3. DashboardPageShell（組織取得処理）で以下を “ログ＋UI” に出す（開発者向け表示でOK、PII禁止）

 • memberships 取得：成功/失敗、件数、organization_id一覧（idのみ）
 • organizations 詳細取得：成功/失敗、Supabase errorの code/message/details/hint を表示
 • 失敗時にログインへ飛ばさない（今の設計維持）

 4. 原因がDB/RLSなら、Supabaseに投げるSQLを作る（私は実行する）

 • organizations取得が失敗する場合の最小確認SQL：
 • select ... from organizations where id in (...)
 • select has_org_role(<id>, array['owner','admin','member','viewer']) が期待通りか
 • pg_policies で organizations の authenticated SELECT policy を確認
 • エラーコードが 42501/permission denied 系ならRLS、22P02/invalid input ならid/型、PGRST 系ならselect列 等

⸻

Phase 3：症状A（ログイン戻り）の最小修正
 5. 307（middleware）だった場合

 • hasAuthCookie 判定が本当に正しいか、本番ログの cookie名（名だけ）で照合し、パターン修正
 • 併せて “ソフト認証” の判定条件を sb cookie だけに頼り切らない 安全な形にする（例：supabase-auth-token等も含む）
 • 修正後、/api/health/auth-snapshot で middlewareWouldRedirect=false を確認できる状態にする

 6. 401/403（API）だった場合

 • /dashboard/posts が呼ぶAPI・view（v_dashboard_posts_secure等）が 401/403 になる理由を特定
 • それが「apikey欠落」なのか「RLS拒否」なのかを error code で断定
 • クライアント作成経路（supabase/client）とcookie連携が正しいか再確認
 • 最小修正を実施して再発防止（誤import防止/ガード/CI）を入れる

⸻

Phase 4：症状C（公開ページで項目が欠ける）の原因断定と止血
 7. /o/[slug] の欠ける条件を証拠で切り分け

 • DBは is_published=true になっている前提
 • それでも欠けるなら「キャッシュが古い」「show_services等フラグで抑制」「RLSでanonが取れてない」のどれか
 • “今そのページがどのsha/どのキャッシュ状態で描画されたか” が分かる軽量診断を入れる（例：レスポンスヘッダに sha / cache-hit など）

 8. キャッシュ原因なら

 • revalidate API を使って org:${slug} と各タグを叩く手順を提示
 • 恒久的には「ダッシュボードで公開更新したらrevalidateを呼ぶ」導線を提案（実装は別PRでもOK）

⸻

出力（必須）
 • (1) 症状A：307/401/403/500のどれか、証拠（ログ or status）付きで断定
 • (2) 症状B：organizations詳細取得失敗の Supabase error code/message を提示し、原因を断定
 • (3) 症状C：欠ける原因を cache/RLS/flag のどれかに断定し、再現/回避手順を出す
 • (4) 変更ファイル一覧（最小差分）
 • (5) 私がSupabaseに投げるべきSQL（必要なら）を1セット提示

⸻

これを実行して。

⸻

補足（あなたにとっての“無駄な作業”を止めるための約束）

今後は 「何が起きてるか（307/401/403/500）」を確定してからしか直さない 形に切り替えるのが一番効きます。
今の状況は、たぶん「ログインに戻る」の中身が “認証が切れた” ではなく “組織詳細取得が落ちた/権限拒否” の可能性が高いので、そこをまず証拠で固定します。
