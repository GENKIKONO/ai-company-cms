目的：refresh-token しか残らない状態を終わらせて、auth-token（chunk含む）が必ず保存されるようにする。
これが直れば /api/dashboard/init は ok:true になり、ダッシュボードのDBエラーも消えます。

以下をそのままコピペして投げてください。

⸻

あなたはClaude Code。AIOHub本番で refresh-token cookie だけが残り、auth-token cookie が存在しないため getUser() が常に “Auth session missing!” になる問題を収束させる。推測で終わらせず、Cookie発行の事実（Set-Cookieの中身）で完了判定すること。

事実（ユーザー報告）

/api/dashboard/init の diagnostics が常に:
 • cookieNames: [“sb--refresh-token”] のみ
 • hasAuthTokenCookie: false
 • hasRefreshTokenCookie: true
 • whichStep: “refreshSession”
 • sessionRecovered: false
 • error: “Auth session missing!”

→ refresh-tokenだけではセッション復旧できていない。auth-token cookie（またはchunk）がブラウザに保存されていない。

⸻

ゴール（完了条件）
 1. ログイン成功後、ブラウザが以下のCookieを保持する（最低条件）

 • sb-<projectRef>-auth-token または sb-<projectRef>-auth-token.0 等の chunk 群
 • sb-<projectRef>-refresh-token（あってもよい）

 2. ログイン成功直後の GET /api/health/auth-snapshot と GET /api/dashboard/init が

 • authState: AUTHENTICATED_READY
 • getUserStatus: success
になる

 3. 失敗時は 401 + {ok:false, code, message} で LoginForm が遷移しない

⸻

Task A: /api/auth/login のCookie発行を「公式chunk方式」に統一

手動で auth-token / refresh-token を cookies.set する実装が残っているなら削除 or 完全に無効化して、
Next.js App Router + @supabase/ssr の 公式パターン(setAll) のみで Set-Cookie を生成する。

必須条件:
 • setAll で渡される cookie 群を、必ず NextResponse に反映する（response.cookies.set）
 • response.headers.getSetCookie() を使って、実際にどの Set-Cookie が返っているかをログに出す

ログに必ず出す:
 • requestId
 • setCookieCount
 • setCookieNames（sb-xxx-auth-token.0 等の名前一覧）
 • それぞれの cookie value length（サイズ超過検知）

⸻

Task B: 「ブラウザが保存できているか」を機械的に検証する診断APIを追加

新規: GET /api/health/login-cookie-contract
 • リクエストCookieから auth-token の prefix一致（auth-token または auth-token.\d+）を検出
 • refresh-token も検出
 • JSONで返す:
{ hasAuthTokenCookie, hasAuthTokenChunkCookies, authTokenCookieNames, hasRefreshTokenCookie, cookieNames, sha, requestId }

これで「サーバーがSet-Cookie出してるのにブラウザが保存してない」も即判定できる。

⸻

Task C: 404/401時に遷移しない（LoginFormの契約固定）
 • /api/auth/login が 200 の時だけ /dashboard へ遷移
 • 401/404/500 はエラー表示のみ（router.push/replace禁止）

⸻

Task D: smokeテストを「auth-token存在」まで上げる（ユーザーに依存しない）

npm run smoke:auth で以下を必ず検証:
 1. GET /api/auth/login が 200
 2. POST /api/auth/login（正しいSMOKE_EMAIL/SMOKE_PASSWORD）で
 • レスポンスヘッダに Set-Cookie が含まれ、
 • その中に sb-<ref>-auth-token か sb-<ref>-auth-token.0 が存在すること（refresh-tokenのみはFAIL）
 3. その後 cookie を付けて GET /api/dashboard/init が ok:true になること

⸻

期待する納品
 • 「refresh-tokenだけ残る原因」の断定（サイズ超過 / 手動cookie / chunk未対応 など）をログ根拠付きで明記
 • commit + push + 本番sha提示
 • 上記 smoke が PASS
