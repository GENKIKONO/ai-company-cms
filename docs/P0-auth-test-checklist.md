# P0最小スコープ安定版 - 認証テストチェックリスト

## 🎯 テスト目標
- P0要件に沿った「最小スコープ安定版」の認証フローを本番環境で再現
- /api/auth/sync 非依存での一発安定稼働を確認

## 📋 事前準備

### SQLトリガー設定
- [ ] `sql/auth-trigger-setup.sql` を Supabase Dashboard → SQL Editor で実行完了
- [ ] トリガー確認: `select tgname from pg_trigger where tgname = 'on_auth_user_created';` で1件取得
- [ ] RLSポリシー確認: `select policyname from pg_policies where tablename = 'app_users';` で3件取得

### Supabase設定確認
- [ ] Site URL: `https://aiohub.jp` に設定
- [ ] Redirect URLs: `https://aiohub.jp/*` に設定
- [ ] Email Templates: 日本語メッセージに設定

---

## ✅ Test Case 1: 新規ユーザー登録フロー

### 手順1: 新規登録
- [ ] `https://aiohub.jp/auth/signup` にアクセス
- [ ] 未使用のメールアドレスとパスワードを入力
- [ ] 「新規登録」ボタンクリック
- [ ] **期待結果**: 「確認メールを送信しました」メッセージ表示

### 手順2: メール確認
- [ ] 受信箱で確認メール受信確認
- [ ] **期待結果**: Subject「AIO Hubへようこそ」
- [ ] メール内のリンクをクリック
- [ ] **期待結果**: `https://aiohub.jp/auth/confirm` にリダイレクト
- [ ] **期待結果**: 「メールアドレスが確認されました」表示

### 手順3: ログイン
- [ ] `https://aiohub.jp/auth/login` にアクセス
- [ ] 登録したメールアドレスとパスワードでログイン
- [ ] **期待結果**: `/dashboard` に自動リダイレクト
- [ ] **期待結果**: ダッシュボードが正常表示

### 手順4: データベース確認
```sql
-- app_usersテーブルにレコードが自動作成されているか確認
SELECT id, email, role, created_at, updated_at 
FROM public.app_users 
WHERE email = 'YOUR_TEST_EMAIL@example.com';
```
- [ ] **期待結果**: 1件のレコードが存在
- [ ] **期待結果**: `role = 'org_owner'`
- [ ] **期待結果**: `email` が正しく設定されている

### 手順5: Developer Tools確認
- [ ] F12 → Network タブで `/api/auth/sync` へのリクエストが**発生しないこと**
- [ ] Console にエラーログが出力されないこと

---

## ✅ Test Case 2: 既存ユーザー（重複登録）

### 手順1: 重複登録試行
- [ ] `https://aiohub.jp/auth/signup` にアクセス  
- [ ] Test Case 1で使用したメールアドレスを再入力
- [ ] 「新規登録」ボタンクリック
- [ ] **期待結果**: 「このメールアドレスは既に登録されています」エラー表示

### 手順2: ログイン導線確認
- [ ] **期待結果**: 「ログインはこちら」リンクが表示される
- [ ] リンクをクリック
- [ ] **期待結果**: `/auth/login` にリダイレクト

### 手順3: 通常ログイン
- [ ] 既存のメールアドレスとパスワードでログイン
- [ ] **期待結果**: `/dashboard` に自動リダイレクト
- [ ] **期待結果**: セッションが正常に保持されている

---

## ✅ Test Case 3: メール期限切れ・再送信

### 手順1: 期限切れユーザーでログイン
- [ ] 24時間以上前に登録したが未確認のメールアドレスでログイン試行
- [ ] **期待結果**: 「メールアドレスが確認されていません」エラー表示
- [ ] **期待結果**: 「確認メールを再送信」ボタンが表示される

### 手順2: 再送信実行
- [ ] 「確認メールを再送信」ボタンをクリック
- [ ] **期待結果**: 「確認メールを再送信しました」成功メッセージ表示

### 手順3: 新しいメール確認
- [ ] 受信箱で新しい確認メール受信確認
- [ ] メール内のリンクをクリック
- [ ] **期待結果**: `https://aiohub.jp/auth/confirm` で確認完了

### 手順4: ログイン完了
- [ ] `/auth/login` でログイン
- [ ] **期待結果**: `/dashboard` に自動リダイレクト

---

## 🔍 共通確認事項

### ブラウザセッション
- [ ] ページリロード後もログイン状態が保持される
- [ ] ブラウザを閉じて再アクセスしてもセッション保持（Remember Me有効時）

### パフォーマンス
- [ ] ログイン → ダッシュボード遷移が **2秒以内** で完了
- [ ] `/api/auth/sync` 呼び出しがないため高速

### エラーハンドリング
- [ ] 無効なパスワードで「パスワードが正しくありません」日本語表示
- [ ] ネットワークエラー時に適切なエラーメッセージ

---

## 🚨 NGパターン（これが発生したら失敗）

### 絶対に発生してはいけない事象
- [ ] ❌ `/api/auth/sync` へのリクエストが発生する
- [ ] ❌ 「Auth session missing」エラーが表示される  
- [ ] ❌ ログイン後にリダイレクトループが発生する
- [ ] ❌ ダッシュボードから強制ログアウトされる
- [ ] ❌ `app_users` テーブルにレコードが作成されない

---

## 📊 成功基準

### 全テストケース完了条件
- [ ] **Test Case 1, 2, 3 すべて完了**
- [ ] **全パターンでダッシュボード表示まで到達**
- [ ] **DBトリガーでプロフィール自動作成確認**
- [ ] **日本語エラーメッセージ適切表示**
- [ ] **/api/auth/sync 完全非依存で動作**

### 🎯 P0最小スコープ達成
✅ **「一発で安定稼働」状態 = 上記チェックリスト全項目クリア**