# E2E認証テスト：3シナリオ完全版

## 🎯 概要

商用レベル認証システムの3つの主要シナリオをE2Eテストで検証する手順書です。
本番環境（https://aiohub.jp）での実際のユーザー体験を確認します。

**実行環境**: 本番環境 (https://aiohub.jp)  
**想定時間**: 20-30分  
**前提条件**: 
- Supabase設定完了
- Vercel環境変数設定完了
- クリーンデプロイ完了

**テスト用データ**:
```
テストメールアドレス: test-e2e-[YYYYMMDD]@example.com
例: test-e2e-20250101@example.com

パスワード: SecureTest123!
```

---

## 🧪 Test Case A: 新規ユーザー登録フロー

### A1. 初期アクセス・サインアップページ

**操作**:
1. ブラウザでシークレットモードを開く
2. https://aiohub.jp にアクセス
3. 「サインアップ」または「新規登録」リンクをクリック
4. `/auth/signup` ページに遷移

**期待結果**:
- [ ] ページが3秒以内に読み込まれる
- [ ] サインアップフォームが正常に表示される
- [ ] メールアドレス・パスワード入力フィールドが機能する
- [ ] 「既にアカウントをお持ちの方」リンクが表示される

**DevTools確認（Network タブ）**:
- [ ] GET /auth/signup → Status: 200 OK
- [ ] 必要なCSS/JSリソースが全て200で読み込み成功
- [ ] コンソールエラーなし

### A2. ユーザー情報入力・送信

**操作**:
1. メールアドレス: `test-e2e-[YYYYMMDD]@example.com`
2. パスワード: `SecureTest123!`
3. 「登録」ボタンをクリック

**期待結果**:
- [ ] 「確認メールを送信しました」メッセージ表示
- [ ] エラーメッセージが表示されない
- [ ] フォームが適切に無効化される

**DevTools確認（Network タブ）**:
- [ ] POST /auth/v1/signup → Status: 200 OK
- [ ] Response Bodyに user オブジェクト含有
- [ ] Set-Cookie ヘッダー存在 (`sb-*-auth-token`)

**DevTools確認（Application → Cookies）**:
- [ ] 認証Cookieが設定される
- [ ] HttpOnly: true, Secure: true 確認

### A3. 確認メール受信・リンクアクセス

**操作**:
1. メールボックスで確認メールを受信（通常1-2分以内）
2. メール内容を確認
3. 確認リンクをクリック

**期待結果（メール内容）**:
- [ ] 送信者: AIO Hub または Supabase
- [ ] 件名: 「【AIO Hub】メールアドレスの確認をお願いします」
- [ ] 本文に日本語メッセージ
- [ ] 確認リンクが `https://aiohub.jp/auth/confirm?token=` で始まる

**🚨 重要**: 以下のリンクは**NG**（設定ミス）:
```
❌ NG例:
https://localhost:3000/auth/confirm...
https://chyicolujwhkycpkxbej.supabase.co/auth/confirm...
https://aiohub.jp/auth/callback... (callbackはNG)

✅ OK例:
https://aiohub.jp/auth/confirm?token=eyJ...&type=signup&redirect_to=...
```

**期待結果（リンククリック）**:
- [ ] 確認ページが表示される
- [ ] 成功メッセージまたは自動ダッシュボード遷移

**DevTools確認（Network タブ）**:
- [ ] GET /auth/confirm?token=... → Status: 200 OK
- [ ] POST /auth/v1/verify → Status: 200 OK
- [ ] 最終的にダッシュボードにリダイレクト（302）

### A4. ダッシュボード表示確認

**操作**:
1. ダッシュボード画面の表示確認
2. ユーザー情報表示確認

**期待結果**:
- [ ] ダッシュボードが正常に表示される
- [ ] ユーザーのメールアドレスが表示される
- [ ] ログアウト機能が利用可能
- [ ] ナビゲーションメニューが認証状態に対応

### A5. プロフィール自動作成確認（DB）

**操作**（Supabase SQL Editorで実行）:
```sql
SELECT 
    u.email,
    u.email_confirmed_at,
    au.role,
    au.created_at
FROM auth.users u
JOIN app_users au ON u.id = au.id
WHERE u.email = 'test-e2e-[YYYYMMDD]@example.com';
```

**期待結果**:
- [ ] 1件のレコードが存在
- [ ] email_confirmed_at が設定されている
- [ ] role = 'org_owner'
- [ ] created_at がサインアップ時刻と一致

### A6. セッション永続性確認

**操作**:
1. ブラウザをリロード（F5）
2. 別タブでサイトにアクセス

**期待結果**:
- [ ] ログイン状態が保持される
- [ ] ダッシュボードが即座に表示される
- [ ] 再認証プロセスが不要

---

## 🧪 Test Case B: 既存ユーザーエラー処理

### B1. 重複登録試行

**操作**:
1. 新しいシークレットモードタブを開く
2. https://aiohub.jp/auth/signup にアクセス
3. Test Case Aと同じメールアドレスで登録試行

**期待結果**:
- [ ] 「このメールアドレスは既に登録されています」日本語エラー表示
- [ ] または「User already registered」エラー表示
- [ ] フォームが操作可能状態を維持

**DevTools確認（Network タブ）**:
- [ ] POST /auth/v1/signup → Status: 422 (Unprocessable Entity)
- [ ] Response Body に適切なエラーメッセージ

### B2. ログインページ導線確認

**操作**:
1. エラーメッセージ内または近くの「ログイン」リンクをクリック
2. ログインページに遷移

**期待結果**:
- [ ] `/auth/login` ページに正常に遷移
- [ ] ログインフォームが表示される
- [ ] 「パスワードを忘れた方」リンク存在

### B3. 既存ユーザーログイン

**操作**:
1. メールアドレス: Test Case Aと同じ
2. パスワード: Test Case Aと同じ
3. 「ログイン」ボタンをクリック

**期待結果**:
- [ ] ログイン成功
- [ ] ダッシュボードに遷移
- [ ] ユーザー情報が正常に表示

**DevTools確認（Network タブ）**:
- [ ] POST /auth/v1/token → Status: 200 OK
- [ ] 認証Cookieが更新される

---

## 🧪 Test Case C: パスワードリセットフロー

### C1. パスワードリセット要求

**操作**:
1. 新しいシークレットモードタブを開く
2. https://aiohub.jp/auth/forgot-password にアクセス
3. Test Case Aで使用したメールアドレスを入力
4. 「パスワードリセットメールを送信」ボタンをクリック

**期待結果**:
- [ ] 「パスワードリセットメールを送信しました」メッセージ表示
- [ ] エラーメッセージが表示されない
- [ ] フォームが適切に処理される

**DevTools確認（Network タブ）**:
- [ ] POST /auth/v1/recover → Status: 200 OK

### C2. リセットメール受信・確認

**操作**:
1. メールボックスでリセットメールを受信（通常1-2分以内）
2. メール内容を確認
3. リセットリンクをクリック

**期待結果（メール内容）**:
- [ ] 送信者: AIO Hub または Supabase
- [ ] 件名: 「【AIO Hub】パスワードリセットのご案内」
- [ ] 本文に日本語メッセージ
- [ ] リセットリンクが `https://aiohub.jp/auth/update-password?` で始まる

**🚨 重要**: リンク形式確認
```
✅ OK例:
https://aiohub.jp/auth/update-password?access_token=eyJ...
https://aiohub.jp/auth/reset-password?access_token=eyJ...

❌ NG例:
https://localhost:3000/auth/...
https://chyicolujwhkycpkxbej.supabase.co/auth/...
```

**期待結果（リンククリック）**:
- [ ] パスワードリセットページが表示される
- [ ] 新しいパスワード入力フィールドが表示される

### C3. 新しいパスワード設定

**操作**:
1. 新しいパスワード: `NewSecurePass456!`
2. パスワード確認: `NewSecurePass456!`
3. 「パスワードを更新」ボタンをクリック

**期待結果**:
- [ ] 「パスワードが正常に更新されました」メッセージ表示
- [ ] 自動的にログイン状態になる、またはログインページに遷移

**DevTools確認（Network タブ）**:
- [ ] POST /auth/v1/user → Status: 200 OK
- [ ] 認証Cookieが設定される（自動ログインの場合）

### C4. 新しいパスワードでログイン確認

**操作**:
1. いったんログアウト（必要に応じて）
2. ログインページで新しいパスワードでログイン試行
3. メールアドレス: Test Case Aと同じ
4. パスワード: `NewSecurePass456!`

**期待結果**:
- [ ] 新しいパスワードでログイン成功
- [ ] 古いパスワードではログイン失敗することを確認
- [ ] ダッシュボードに正常にアクセス可能

---

## 📊 テスト結果記録

### 実行情報
- **実行日時**: _______________
- **実行者**: _______________
- **ブラウザ**: Chrome/Edge/Safari Version: _______
- **テストデータ**: test-e2e-[YYYYMMDD]@example.com

### Test Case A: 新規ユーザー登録
- [ ] A1. 初期アクセス・サインアップページ ✅/❌
- [ ] A2. ユーザー情報入力・送信 ✅/❌
- [ ] A3. 確認メール受信・リンクアクセス ✅/❌
- [ ] A4. ダッシュボード表示確認 ✅/❌
- [ ] A5. プロフィール自動作成確認（DB） ✅/❌
- [ ] A6. セッション永続性確認 ✅/❌

**所要時間**: ____分  
**問題・備考**: ________________

### Test Case B: 既存ユーザーエラー処理
- [ ] B1. 重複登録試行 ✅/❌
- [ ] B2. ログインページ導線確認 ✅/❌
- [ ] B3. 既存ユーザーログイン ✅/❌

**所要時間**: ____分  
**問題・備考**: ________________

### Test Case C: パスワードリセットフロー
- [ ] C1. パスワードリセット要求 ✅/❌
- [ ] C2. リセットメール受信・確認 ✅/❌
- [ ] C3. 新しいパスワード設定 ✅/❌
- [ ] C4. 新しいパスワードでログイン確認 ✅/❌

**所要時間**: ____分  
**問題・備考**: ________________

### パフォーマンス測定
- [ ] 初回ページ読み込み: ____秒 (< 3秒が目標)
- [ ] 認証完了まで: ____秒 (< 30秒が目標)
- [ ] メール受信時間: ____分 (< 2分が目標)

### ネットワーク・DevTools確認
- [ ] JavaScriptエラーなし
- [ ] 404エラーなし
- [ ] 適切なHTTPステータスコード
- [ ] セキュリティ設定（HttpOnly Cookie等）正常

---

## 📝 判定基準

### ✅ PASS判定条件
- [ ] Test Case A, B, C 全ての項目が成功
- [ ] パフォーマンス基準をクリア
- [ ] DevTools確認で異常なし
- [ ] データベース確認で期待結果

### ❌ FAIL時の対処手順

**優先度 High（即対応）**
1. 認証フロー完全停止 → Supabase設定再確認
2. メール送信失敗 → Email Templates設定再確認
3. データベースエラー → SQL設定再実行

**優先度 Medium（調査・改善）**
1. パフォーマンス基準未達 → リソース最適化検討
2. エラーメッセージ不適切 → UI改善検討

**再テスト実行**
- 問題修正後は必ず全シナリオを再実行
- 部分修正でも影響範囲を考慮した範囲テスト実施

---

## 🗂️ テスト成果物

### テスト完了後の提出物
1. **このテスト結果記録** (記入完了版)
2. **Supabaseデータベース確認結果** (SQLクエリ結果のスクリーンショット)
3. **DevTools Network/Console スクリーンショット** (各主要ステップ)
4. **問題・改善点の一覧** (該当する場合)

### 結果ファイル保存先
`docs/e2e/results/auth-run-[YYYYMMDD].md` に保存

---

## 🚨 緊急時の連絡・対応

### テスト中断が必要なケース
- 本番サイトが完全に利用不可
- データベースへの書き込みエラー
- セキュリティ関連の警告

### エスカレーション基準
- **15分以上**メール受信されない
- **複数の Test Case** で同様のエラー
- **本番ユーザー影響**の可能性

---

**🎯 この3シナリオテストの完全クリアにより、商用レベル認証システムの品質が保証されます** ✅