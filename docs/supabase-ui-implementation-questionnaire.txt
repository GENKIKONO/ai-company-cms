================================================================================
SUPABASE → UI 実装 100% 移行質問票
================================================================================
作成日: 2024-12-22
目的: DB側全機能をUIに100%反映するための現状認識と詳細質問
================================================================================

【本ドキュメントの使い方】
1. Supabaseアシスタントに各セクションの質問を回答してもらう
2. 回答に基づき、実装優先度を決定
3. 分割実装計画を策定

================================================================================
セクション1: 現状認識（コード側から確認済み）
================================================================================

## 1.1 テーブル一覧（src/types/supabase.ts より抽出）

### コアビジネステーブル
- organizations: 組織管理
- org_memberships: 組織メンバーシップ
- org_roles: 組織ロール
- profiles: ユーザープロファイル
- customers: 顧客情報

### AI/コンテンツ系テーブル
- ai_monthly_reports: AI月次レポート ★スキーマ不一致あり
- ai_interview_sessions: AIインタビューセッション
- ai_interview_messages: インタビューメッセージ
- ai_interview_questions: インタビュー質問
- ai_interview_axes: インタビュー軸
- ai_citations_responses: 引用レスポンス
- ai_citations_items: 引用アイテム
- ai_content_units: コンテンツユニット
- ai_bot_logs: ボットログ（パーティション分割）
- ai_visibility_scores: AI可視性スコア
- ai_visibility_config: 可視性設定
- ai_generated_drafts: 生成済みドラフト
- ai_answers: AI回答
- ai_queries: AIクエリ
- ai_feedback: AIフィードバック
- ai_conversations: AI会話
- ai_sources: AIソース
- ai_sections: セクション
- ai_chunks: チャンク
- ai_jsonld_versions: JSON-LDバージョン
- ai_hreflang: hreflang設定
- ai_sites: サイト設定
- ai_site_url_rules: URL規則
- ai_exports: エクスポート
- ai_disclosure_documents: 開示文書
- ai_manifest_settings: マニフェスト設定
- ai_usage_events: 使用イベント（パーティション分割）

### CMS系テーブル
- case_studies: 事例
- case_study_translations: 事例翻訳
- faqs: FAQ
- faq_translations: FAQ翻訳
- posts: 投稿
- post_translations: 投稿翻訳
- news: ニュース
- news_translations: ニュース翻訳
- products: 製品
- product_translations: 製品翻訳
- services: サービス（型定義では未確認）

### レポート系テーブル ★要確認
- monthly_reports: 月次レポート（旧形式？）
- monthly_report_jobs: レポートジョブ
- monthly_report_sections: レポートセクション
- report_regeneration_logs: 再生成ログ（型定義では未確認）

### 課金・注文系テーブル
- orders: 注文
- order_items: 注文アイテム
- billing_checkout_links: チェックアウトリンク
- billing_checkout_link_activations: チェックアウトアクティベーション
- plan_features: プラン機能

### セキュリティ系テーブル
- blocked_ips: ブロックIP
- ip_blocklist: IPブロックリスト
- ip_reports: IPレポート
- ip_report_actions: IPレポートアクション
- intrusion_detection_alerts: 侵入検知アラート
- intrusion_detection_rules: 侵入検知ルール

### 監査・ログ系テーブル
- activities: アクティビティ（パーティション分割）
- audit_logs: 監査ログ
- ops_audit: 運用監査
- enforcement_actions: 強制アクション
- enforcement_audit: 強制監査
- contract_violations: 契約違反

### その他テーブル
- partners: パートナー
- projects: プロジェクト
- comments: コメント
- designs: デザイン
- design_versions: デザインバージョン
- embeddings: 埋め込み
- embedding_jobs: 埋め込みジョブ
- cache_invalidation_queue: キャッシュ無効化キュー
- content_refresh_queue: コンテンツ更新キュー
- idempotency_keys: 冪等性キー
- job_runs: ジョブ実行
- alert_events: アラートイベント
- alert_thresholds: アラート閾値
- alert_sources: アラートソース
- chatbots: チャットボット
- chatbot_interactions: チャットボット対話
- file_metadata: ファイルメタデータ
- feature_registry: 機能レジストリ
- organization_addons: 組織アドオン
- organization_ai_usage: 組織AI使用量
- organization_keywords: 組織キーワード
- organization_verifications: 組織認証
- crawler_policies: クローラーポリシー
- supported_languages: サポート言語
- analytics_events: 分析イベント

## 1.2 Edge Functions（26個確認済み）

### レポート系（8個）
- monthly-report-generate: レポート生成
- monthly-report-scheduler: レポートスケジューラー
- monthly-reports: レポート一覧
- reports: レポートAPI
- reports-api: レポートAPI（別実装）
- reports-worker: レポートワーカー
- reports-cron: レポートcron
- reports-get-current: 現在レポート取得
- reports-list: レポート一覧
- reports-regenerate: レポート再生成
- reports-jobs: レポートジョブ
- reports-job-detail: ジョブ詳細
- ai_monthly_report_upsert: レポートupsert

### AI処理系
- ai-interview-finalize: インタビュー終了処理
- ghostwriter: ゴーストライター
- embedding-runner: 埋め込み処理
- translation-runner: 翻訳処理
- org-docs-ingest: 組織ドキュメント取り込み

### 管理系
- partition-maintenance: パーティション管理
- partition-maintenance-cron-trigger: パーティションcronトリガー
- cache-purge: キャッシュパージ
- content-refresh-orchestrator: コンテンツ更新オーケストレーター
- nightly-schema-diff: 夜間スキーマ差分
- rls-tester: RLSテスター

### サンプル
- example-function: サンプル関数
- example-finalize: サンプル終了処理

## 1.3 確認済みスキーマ不一致（docs/schema-diff-report.md より）

### 🔴 重大
1. cron/monthly-report/route.ts が存在しないカラム参照
   - year, month, format, data_summary は存在しない
   - 実テーブル: ai_monthly_reports は period_start/period_end 形式

2. テーブル二重管理
   - monthly_reports テーブル と ai_monthly_reports テーブル並存
   - コードによって使用テーブルが異なる

### 🟡 中
3. month_bucket カラム
   - ai_monthly_reports には存在しない
   - report_regeneration_logs にのみ存在

4. ユニーク制約の不一致
   - コード想定: (org_id, month_bucket, plan_id, level)
   - 実際: (org_id, period_start) 推定

================================================================================
セクション2: Supabaseアシスタントへの質問
================================================================================

【質問への回答形式】
各質問に対して以下の形式で回答してください：
- 状態: [実装済み/部分実装/未実装/不要]
- 詳細: 具体的な実装状況
- UI反映必要度: [必須/推奨/任意/不要]
- 補足: 追加情報

================================================================================
## 2.1 レポート機能に関する質問（優先度: 最高）
================================================================================

Q2.1.1: ai_monthly_reports テーブルの正式なスキーマ定義を教えてください
- 全カラム名、型、制約（PK/UK/FK/CHECK）
- 特にperiod_start/period_endの型と用途
- status カラムの許容値（enum/CHECK）

Q2.1.2: monthly_reports テーブルは廃止予定ですか？
- ai_monthly_reports との役割分担の意図
- 移行計画の有無
- 互換ビュー ai_monthly_reports_compat の定義

Q2.1.3: monthly_report_sections テーブルのスキーマを教えてください
- report_id の参照先（monthly_reports or ai_monthly_reports）
- section_key の許容値一覧

Q2.1.4: monthly_report_jobs テーブルのスキーマを教えてください
- status カラムの許容値
- 関連インデックスの定義

Q2.1.5: report_regeneration_logs テーブルのスキーマを教えてください
- month_bucket カラムの型（DATE or TEXT）
- ユニーク制約の定義

Q2.1.6: レポート生成フローの全体像を教えてください
- どのEdge Functionがどの順序で呼ばれるか
- cronジョブの設定（スケジュール、実行Function）
- 非同期処理のキュー管理方法

Q2.1.7: プラン別レポート機能の制限を教えてください
- get_plan_features RPC の返り値
- monthlyReport, advancedAnalytics 等の機能フラグ
- 再生成回数制限のカウント方法

================================================================================
## 2.2 AIインタビュー機能に関する質問（優先度: 高）
================================================================================

Q2.2.1: ai_interview_sessions.answers カラムのJSON構造を教えてください
- 新形式: {questionId: {question, answer}} なのか
- 旧形式との互換性対応

Q2.2.2: ai_interview_sessions.status の状態遷移を教えてください
- draft → in_progress → completed の遷移条件
- 各状態でのUI表示要件

Q2.2.3: ai_interview_sessions.generated_content_json の構造を教えてください
- 生成されたコンテンツの保存形式
- UIでの表示方法

Q2.2.4: ai_interview_axes と ai_interview_questions の関係を教えてください
- 軸（axis）ごとの質問管理方法
- i18n対応（label_ja, label_en等）の仕組み

Q2.2.5: ai_generated_drafts テーブルの用途と運用を教えてください
- session_id との関係
- adopted フラグの意味と更新タイミング

Q2.2.6: ai-interview-finalize Edge Function の処理内容を教えてください
- 呼び出しタイミング
- 生成されるコンテンツの種類
- エラーハンドリング

================================================================================
## 2.3 AI引用・分析機能に関する質問（優先度: 高）
================================================================================

Q2.3.1: ai_citations_responses と ai_citations_items の関係を教えてください
- response と item の1:N関係の詳細
- organization_id によるRLSの設定

Q2.3.2: ai_citations_summary_v1 RPC の用途を教えてください
- 返り値の解釈
- UIでの表示方法

Q2.3.3: v_ai_citations_aggregates ビューの定義を教えてください
- 集計ロジック
- パフォーマンス考慮事項

Q2.3.4: ai_visibility_scores テーブルの運用を教えてください
- スコア計算のタイミング
- cleanup_old_visibility_scores の実行条件

Q2.3.5: ai_bot_logs テーブルのパーティション戦略を教えてください
- パーティション期間（月次？）
- admin_create_next_month_partitions の実行方法

================================================================================
## 2.4 CMS・コンテンツ管理に関する質問（優先度: 中）
================================================================================

Q2.4.1: CMSコンテンツテーブル（case_studies, faqs, posts, news, products）の共通構造を教えてください
- status カラムの許容値（draft/published/archived）
- deleted_at によるソフトデリート対応
- 翻訳テーブルとの関係

Q2.4.2: public_* テーブル群の用途を教えてください
- public_case_studies, public_faqs 等
- sync_public_* 関数の役割
- パブリック公開の仕組み

Q2.4.3: content_search_i18n_v2 RPC の使用方法を教えてください
- 引数の意味
- 返り値のUIへのマッピング

Q2.4.4: cms_site_settings テーブルの役割を教えてください
- ai_sites との関係
- サイト設定のUI管理方法

Q2.4.5: ai_hreflang テーブルの運用方法を教えてください
- group_key の生成ルール
- is_canonical フラグの意味

================================================================================
## 2.5 課金・プラン管理に関する質問（優先度: 中）
================================================================================

Q2.5.1: plan_features テーブルの全プランと機能一覧を教えてください
- プランID一覧（free, pro, enterprise等）
- 各機能フラグの意味

Q2.5.2: organization_addons テーブルの運用を教えてください
- アドオンの種類
- 課金連携（Stripe）との関係

Q2.5.3: billing_checkout_links テーブルの用途を教えてください
- チェックアウトフローの全体像
- activations との関係

Q2.5.4: orders と order_items テーブルのスキーマを教えてください
- 注文ステータスの遷移
- UIでの表示要件

================================================================================
## 2.6 セキュリティ・監査機能に関する質問（優先度: 中）
================================================================================

Q2.6.1: RLSポリシーの全体設計を教えてください
- 組織分離の仕組み
- 管理者権限の付与方法
- サービスロールのバイパス条件

Q2.6.2: audit_logs テーブルのパーティション戦略を教えてください
- 保持期間
- 古いパーティションの削除ポリシー

Q2.6.3: enforcement_actions テーブルの用途を教えてください
- アクション種類（warn, freeze, suspend, delete）
- UIでの管理画面要件

Q2.6.4: intrusion_detection_* テーブルの運用を教えてください
- ルールの管理方法
- アラートの通知先

Q2.6.5: blocked_ips と ip_blocklist の違いを教えてください
- 使い分け
- auto_block_ip 関数の動作

================================================================================
## 2.7 Realtime・通知機能に関する質問（優先度: 高）
================================================================================

Q2.7.1: Realtime Broadcast の設計を教えてください
- 使用しているチャンネル名パターン（org:${orgId}:* 等）
- private: true の設定箇所
- RLSとの連携

Q2.7.2: Realtime Presence の使用箇所を教えてください
- オンラインユーザー表示等
- 状態管理方法

Q2.7.3: 通知テーブル（notifications等）の有無を教えてください
- ユーザー通知の仕組み
- 未読管理

Q2.7.4: alert_events テーブルの用途を教えてください
- アラート種類
- 通知フロー

================================================================================
## 2.8 RPC関数に関する質問（優先度: 高）
================================================================================

Q2.8.1: get_plan_features RPC の完全な仕様を教えてください
- 引数
- 返り値の全フィールド
- キャッシュ戦略

Q2.8.2: count_report_regenerations RPC の仕様を教えてください
- 引数
- カウント対象期間

Q2.8.3: upsert_monthly_report RPC の仕様を教えてください
- 引数
- 冪等性の保証方法

Q2.8.4: aiis_save_answers_with_version RPC の仕様を教えてください
- 楽観的ロックの仕組み
- バージョン競合時の挙動

Q2.8.5: 管理者専用RPC一覧を教えてください
- admin_* 系関数の用途
- 権限チェック方法

================================================================================
## 2.9 ビュー定義に関する質問（優先度: 中）
================================================================================

Q2.9.1: v_org_feature_flags ビューの定義を教えてください
- 結合元テーブル
- フラグ計算ロジック

Q2.9.2: organizations_overview_v2 ビューの定義を教えてください
- 集計内容
- パフォーマンス考慮事項

Q2.9.3: view_report_regen_limit_current ビューの定義を教えてください
- 再生成制限の計算ロジック
- UIでの表示方法

Q2.9.4: v_ai_interview_session_metrics ビューの定義を教えてください
- メトリクス内容
- ダッシュボード表示要件

Q2.9.5: v_ai_response_groups_v2 ビューの定義を教えてください
- グルーピングロジック
- 分析画面での活用方法

================================================================================
## 2.10 Edge Functions詳細質問（優先度: 高）
================================================================================

Q2.10.1: ghostwriter Edge Function の仕様を教えてください
- 入力パラメータ
- 生成コンテンツの種類
- 呼び出し元UI

Q2.10.2: embedding-runner Edge Function の仕様を教えてください
- 処理対象データ
- embedding_jobs テーブルとの連携
- ベクトルDB（pgvector）との連携

Q2.10.3: translation-runner Edge Function の仕様を教えてください
- 対応言語
- 翻訳テーブルへの保存方法

Q2.10.4: content-refresh-orchestrator Edge Function の仕様を教えてください
- 更新対象コンテンツ
- content_refresh_queue との連携

Q2.10.5: partition-maintenance Edge Function の仕様を教えてください
- 管理対象テーブル
- 実行スケジュール

================================================================================
セクション3: UI実装ギャップ確認
================================================================================

## 3.1 現在のUI実装状況（コード側から確認済み）

### 実装済みと推定される機能
- ダッシュボード基本表示
- 組織管理基本機能
- ユーザー管理基本機能
- CMS基本CRUD
- AIインタビュー基本フロー

### 部分実装と推定される機能
- 月次レポート表示（テーブル不一致あり）
- AI引用分析（RPC連携要確認）
- プラン管理

### 未実装と推定される機能（要確認）
- パーティション管理UI
- 侵入検知管理UI
- 詳細監査ログビューア
- レポート再生成管理UI

================================================================================
## 3.2 DBにあるがUIに反映されていない可能性のある機能

Q3.2.1: 以下の機能についてUI実装状況を教えてください

1. ai_visibility_config の管理UI
2. ai_manifest_settings の管理UI
3. ai_site_url_rules の管理UI
4. crawler_policies の管理UI
5. alert_thresholds の管理UI
6. intrusion_detection_rules の管理UI
7. organization_verifications の管理UI
8. feature_registry の管理UI
9. organization_addons の管理UI
10. billing_checkout_links の管理UI

================================================================================
セクション4: DB側に不足している可能性のある機能
================================================================================

## 4.1 コード分析から推測される不足機能

Q4.1.1: 以下の機能についてDB側のサポート状況を教えてください

1. ユーザー設定保存テーブル（user_preferences等）
2. 通知設定テーブル（notification_settings等）
3. ダッシュボードウィジェット設定テーブル
4. エクスポート履歴テーブル
5. 定期レポート配信設定テーブル
6. APIキー管理テーブル（oem_keys以外）
7. Webhook設定テーブル
8. カスタムフィールド定義テーブル

================================================================================
セクション5: 実装分割計画
================================================================================

## 5.1 推奨実装フェーズ

### フェーズ1: 重大不一致の修正（即時対応）
- cron/monthly-report/route.ts のスキーマ修正
- ai_monthly_reports への統一
- Edge Functions の動作確認

### フェーズ2: コア機能のUI反映
- 月次レポート完全表示
- AI引用分析ダッシュボード
- プラン管理画面

### フェーズ3: 管理機能のUI反映
- 監査ログビューア
- セキュリティ設定画面
- パーティション管理

### フェーズ4: 拡張機能のUI反映
- 高度な分析機能
- カスタマイズ設定
- 外部連携設定

================================================================================
セクション6: 追加確認事項
================================================================================

Q6.1: マイグレーション履歴を教えてください
- 直近3ヶ月の主要変更
- 今後予定されている変更

Q6.2: 本番環境でのcronジョブ設定を教えてください
- pg_cron の設定内容
- Edge Functions の定期実行設定

Q6.3: バックアップ・リストア戦略を教えてください
- バックアップ頻度
- リストア手順

Q6.4: 環境間のスキーマ同期方法を教えてください
- 開発 → ステージング → 本番のデプロイフロー
- マイグレーション管理方法

Q6.5: パフォーマンス監視の仕組みを教えてください
- スロークエリログ
- インデックス使用状況

================================================================================
回答完了後の次ステップ
================================================================================

1. 回答内容を本ドキュメントに追記
2. 実装優先度の最終決定
3. 各フェーズのチケット作成
4. 分割実装の開始

================================================================================
