# 要件定義（ビジネス要件）

## ゴール・範囲

### プロジェクトゴール
企業の構造化データ（JSON-LD）と公開ページ生成を**セルフサーブ**と**代理店**の両導線で提供し、最短60分で公開完了を実現する。

### 対象ユーザー

#### セルフサーブユーザー（企業直接利用）
- **企業の担当者**: 自社情報の入力・編集・即時公開
- **利用シーン**: 自社でWebマーケティングを内製化している企業
- **権限**: 1ユーザー = 1組織の紐付け（created_by 1:1）
- **承認フロー**: なし（即座に公開可能）

#### 代理店ユーザー（partner ロール）
- **印刷会社・制作会社**: 顧客企業を代理管理
- **利用シーン**: 複数の顧客企業の案内サイトを一元管理
- **権限**: 1つのpartnerアカウントで複数組織を作成・管理
- **承認フロー**: 既存機能を維持（代理店判断）

#### 管理者（admin）
- **システム管理**: 全データへのアクセス・診断・監視
- **代理店管理**: partner権限の付与・管理
- **課金管理**: Stripe設定・監視

### ビジネスモデル

#### 課金体系
- **基本料金**: ¥5,000/月/組織（Stripe基本プラン）
- **対象**: セルフサーブで作成された組織
- **支払い**: クレジットカード（Stripe Checkout）
- **Degraded運用**: 未設定時も基本機能は利用可能

#### 代理店収益モデル
- 代理店は顧客企業から別途料金徴収
- システム利用料は代理店負担なし（既存維持）
- 将来的にcommission設定を検討

## ユースケース・受け入れ条件

### セルフサーブフロー

#### 新規登録〜公開フロー
1. **アカウント作成**: メール認証
2. **組織作成**: 企業情報の基本入力（/organizations/new）
3. **情報充実**: サービス・事例・FAQ追加
4. **即時公開**: is_published=true で即座に公開

#### 継続利用フロー
1. **ダッシュボード**: /dashboard でデータ管理
2. **編集・更新**: リアルタイム反映
3. **公開管理**: 公開/非公開の切り替え
4. **課金管理**: /dashboard/billing でStripe管理

### 代理店フロー

#### 顧客管理フロー
1. **ログイン**: partner権限でアクセス
2. **組織作成**: /api/organizations で顧客企業作成
3. **顧客情報入力**: 代理での情報登録・更新
4. **公開判断**: 代理店の裁量で公開タイミング決定

#### 複数組織管理
1. **組織一覧**: partner権限で管理中組織を表示
2. **切り替え**: 組織間での作業切り替え
3. **権限管理**: 各組織への適切なアクセス制御

### 管理者フロー

#### システム診断
1. **総合チェック**: /ops/verify で両モードの健全性確認
2. **個別診断**: /ops/probe で詳細診断
3. **監視**: Slack通知での異常検知

#### データ管理
1. **全組織アクセス**: admin権限での全データ参照
2. **権限付与**: partner権限の管理
3. **問題解決**: 技術的問題のトラブルシューティング

## 受け入れ条件（必須）

### 技術要件
- **JSON-LD検証**: エラー0（Organization/Service/FAQ/CaseStudy/Article）
- **レスポンス安定性**: APIで500エラーを出さない
- **エラーハンドリング**: 4xx/5xxの責務分離、詳細はdetailsに記載
- **データ整合性**: Zod検証、空文字→null正規化

### UX要件
- **ロゴクリック**: 常に / へ遷移
- **CTA分岐**: 
  - 未ログイン時「無料で始める」→ 登録
  - ログイン済み「無料で始める」→ /dashboard
- **レスポンシブ**: 320px〜2560px対応
- **メール表示**: 狭幅で崩れない（省略＋メニュー格納）

### セキュリティ要件
- **RLS適用**: セルフサーブはcreated_by 1:1、代理店はpartner権限
- **認証分離**: /api/my/* はセルフサーブ専用、/api/organizations* はpartner専用
- **権限チェック**: すべてのAPI操作で適切な権限確認

### 運用要件
- **診断機能**: /ops/verify でALL GREEN達成
- **課金連携**: Stripe設定時はcheckout→webhook→portal完全動作
- **Degraded運用**: Stripe未設定でも基本機能は正常動作

## KPI・成功指標

### 運用KPI
- **初回セットアップ**: ≤ 60分（セルフサーブ）
- **JSON-LD検証**: エラー率 0%
- **システム稼働率**: 99.5%以上
- **課金成功率**: 98%以上（Stripe設定時）

### ビジネスKPI
- **セルフサーブ導入**: 月10社（3ヶ月目標）
- **継続率**: ≥ 90%（月次）
- **代理店機能**: 既存機能100%維持

### 非ゴール（後回し）
- AIエージェントAPI提供
- 多段承認ワークフロー
- フルCMS化
- マルチテナント課金（代理店別料金設定）

---

**重要**: この要件に反する実装・変更は一切受け入れ不可。PRレビューで必ず準拠確認を実施してください。