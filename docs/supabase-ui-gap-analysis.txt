================================================================================
SUPABASE → UI 実装ギャップ分析
================================================================================
作成日: 2024-12-22
================================================================================

【本ドキュメントの目的】
DB側の機能とUI側の実装状況を比較し、
実装が必要な箇所を特定する。

================================================================================
1. 機能別ギャップマトリクス
================================================================================

凡例:
  ✅ = 実装済み
  ⚠️ = 部分実装/要修正
  ❌ = 未実装
  ❓ = 要確認

================================================================================
## 1.1 レポート機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| ai_monthly_reports CRUD         | ⚠️     | テーブル不一致あり             |
| レポート一覧表示                | ❓     | period_start形式への修正必要   |
| レポート詳細表示                | ❓     | sections, suggestions対応      |
| レポート生成トリガー            | ❓     | Edge Function連携             |
| レポート再生成                  | ⚠️     | 回数制限UIあるか要確認         |
| 再生成回数表示                  | ❓     | view_report_regen_limit_current |
| プラン別機能制限                | ❓     | get_plan_features連携          |
| 月別ナビゲーション              | ⚠️     | year/month → period_start変換  |

必要なUI変更:
1. src/app/api/cron/monthly-report/route.ts のスキーマ修正
2. レポート一覧コンポーネントの period_start 対応
3. 再生成ボタンと回数制限表示
4. プラン制限時のアップグレード誘導

================================================================================
## 1.2 AIインタビュー機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| セッション作成                  | ✅     | 実装済み                       |
| 質問表示                        | ✅     | ai_interview_questions対応     |
| 回答保存                        | ⚠️     | 新形式{questionId:{q,a}}対応   |
| バージョン競合処理              | ⚠️     | aiis_save_answers_with_version |
| セッション完了                  | ⚠️     | ai-interview-finalize連携      |
| 生成コンテンツ表示              | ❓     | generated_content_json対応     |
| ドラフト管理                    | ❓     | ai_generated_drafts対応        |
| メッセージ履歴                  | ❓     | ai_interview_messages表示      |
| 軸別質問管理                    | ❓     | ai_interview_axes対応          |

必要なUI変更:
1. 回答フォーマットの toNewAnswersFormat() 適用（一部完了）
2. バージョン競合時のリトライUI
3. 生成コンテンツプレビュー画面
4. ドラフト一覧・採用機能

================================================================================
## 1.3 AI引用分析機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 引用レスポンス一覧              | ❓     | ai_citations_responses         |
| 引用アイテム詳細                | ❓     | ai_citations_items             |
| 引用サマリー                    | ❓     | ai_citations_summary_v1 RPC    |
| 集計ビュー                      | ❓     | v_ai_citations_aggregates      |
| レスポンスグループ              | ❓     | v_ai_response_groups_v2        |
| コンテンツユニット関連          | ❓     | ai_content_units連携           |

必要なUI変更:
1. 引用分析ダッシュボード新規作成
2. コンテンツ別引用回数グラフ
3. トークン使用量表示
4. 期間別トレンド表示

================================================================================
## 1.4 AI可視性機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 可視性スコア一覧                | ❓     | ai_visibility_scores           |
| スコア設定                      | ❓     | ai_visibility_config           |
| ボットログ分析                  | ❓     | ai_bot_logs                    |
| 7日間トレンド                   | ❓     | ai_bot_daily_7d RPC            |
| URL別分析                       | ❓     | ai_content_units連携           |

必要なUI変更:
1. AI可視性ダッシュボード
2. ボット別アクセス統計
3. URL別パフォーマンス表示
4. 改善提案表示

================================================================================
## 1.5 CMS機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 事例 CRUD                       | ✅     | case_studies                   |
| FAQ CRUD                        | ✅     | faqs                           |
| 投稿 CRUD                       | ✅     | posts                          |
| ニュース CRUD                   | ✅     | news                           |
| 製品 CRUD                       | ✅     | products                       |
| 翻訳管理                        | ⚠️     | *_translations対応             |
| 公開設定                        | ⚠️     | sync_to_public連携             |
| コンテンツ検索                  | ❓     | content_search_i18n_v2 RPC     |
| hreflang設定                    | ❓     | ai_hreflang対応                |
| サイト設定                      | ❓     | ai_sites/cms_site_settings     |

必要なUI変更:
1. 翻訳管理画面の改善
2. 公開プレビュー機能
3. 多言語コンテンツ検索UI
4. hreflang設定画面

================================================================================
## 1.6 組織・ユーザー管理
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 組織作成・編集                  | ✅     | organizations                  |
| メンバー管理                    | ✅     | org_memberships                |
| ロール管理                      | ⚠️     | org_roles対応                  |
| プロファイル編集                | ✅     | profiles                       |
| 組織概要ビュー                  | ❓     | organizations_overview_v2      |
| 機能フラグ表示                  | ❓     | v_org_feature_flags            |
| 認証状態                        | ❓     | organization_verifications     |
| AI使用量                        | ❓     | organization_ai_usage          |

必要なUI変更:
1. ロール詳細設定画面
2. 組織ダッシュボードの拡充
3. 機能利用状況表示
4. AI使用量メーター

================================================================================
## 1.7 課金・プラン管理
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| プラン一覧                      | ⚠️     | plan_features                  |
| 機能比較                        | ❓     | get_plan_features RPC          |
| 注文履歴                        | ❓     | orders/order_items             |
| チェックアウト                  | ⚠️     | billing_checkout_links         |
| アドオン管理                    | ❓     | organization_addons            |
| Stripeポータル                  | ✅     | /api/billing/portal            |

必要なUI変更:
1. プラン比較ページ
2. 注文履歴ページ
3. アドオン購入UI
4. 請求詳細ページ

================================================================================
## 1.8 セキュリティ・監査
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 監査ログ閲覧                    | ❓     | admin_get_audit_logs RPC       |
| IPブロック管理                  | ❓     | blocked_ips/ip_blocklist       |
| 侵入検知ルール                  | ❓     | intrusion_detection_rules      |
| 侵入検知アラート                | ❓     | intrusion_detection_alerts     |
| 強制アクション                  | ⚠️     | enforcement_actions            |
| 契約違反管理                    | ❓     | contract_violations            |

必要なUI変更:
1. 監査ログビューア（管理者用）
2. IPブロック管理画面
3. セキュリティアラートダッシュボード
4. 違反管理画面

================================================================================
## 1.9 Realtime機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| 組織チャンネル購読              | ⚠️     | org:${orgId}:* 形式            |
| private: true 設定              | ✅     | 実装済み                       |
| レポート更新通知                | ❓     | ai_monthly_reports broadcast   |
| アクティビティ通知              | ❓     | activities broadcast           |
| Presence                        | ❓     | オンラインユーザー表示         |

必要なUI変更:
1. リアルタイム通知トースト
2. レポート生成完了通知
3. 共同編集インジケーター
4. オンラインユーザー表示

================================================================================
## 1.10 管理者機能
================================================================================

| DB機能                          | UI実装 | 備考                           |
|---------------------------------|--------|--------------------------------|
| パーティション管理              | ❌     | admin_create_month_partition   |
| スキーマ差分確認                | ❌     | nightly-schema-diff連携        |
| RLSテスト                       | ❌     | rls-tester連携                 |
| コンテンツ更新管理              | ❓     | content_refresh_queue          |
| ジョブ実行状況                  | ❓     | job_runs_v2                    |
| エッジ関数失敗統計              | ❓     | admin_get_edge_failure_stats   |

必要なUI変更:
1. 管理者ダッシュボード
2. システム状態モニター
3. ジョブキュー管理画面
4. パーティション状態表示

================================================================================
2. 実装優先度マトリクス
================================================================================

                    │ 影響度: 高 │ 影響度: 中 │ 影響度: 低 │
━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┤
緊急度: 高         │ ★★★       │ ★★        │ ★          │
                    │ レポート   │ インタビュー│ hreflang   │
                    │ スキーマ   │ バージョン │            │
                    │ 修正       │ 競合処理   │            │
━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┤
緊急度: 中         │ ★★        │ ★         │            │
                    │ 引用分析   │ 課金詳細   │            │
                    │ ダッシュ   │ ページ     │            │
━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┤
緊急度: 低         │ ★         │            │            │
                    │ 監査ログ   │            │            │
                    │ ビューア   │            │            │
━━━━━━━━━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┿━━━━━━━━━━━━┘

================================================================================
3. 推奨実装順序
================================================================================

## Phase 1: 重大不一致修正（1-2日）
1. cron/monthly-report/route.ts スキーマ修正
2. ai_monthly_reports への統一
3. Edge Functions動作確認

## Phase 2: コア機能完成（3-5日）
1. 月次レポート一覧・詳細表示
2. レポート再生成UI
3. AIインタビュー生成コンテンツ表示
4. Realtime通知統合

## Phase 3: 分析機能（3-5日）
1. AI引用分析ダッシュボード
2. AI可視性ダッシュボード
3. ボットログ分析画面

## Phase 4: 管理機能（2-3日）
1. 監査ログビューア
2. プラン詳細比較
3. 組織AI使用量表示

## Phase 5: 高度な機能（3-5日）
1. セキュリティ管理画面
2. パーティション管理
3. ジョブ監視ダッシュボード

================================================================================
4. 各フェーズの詳細タスク
================================================================================

## Phase 1 詳細

### Task 1.1: cron/monthly-report/route.ts 修正
ファイル: src/app/api/cron/monthly-report/route.ts
変更内容:
- year/month → period_start への変換
- data_summary → metrics への変更
- format 列参照の削除
- ai_monthly_reports テーブルへの統一

### Task 1.2: Edge Functions確認
対象:
- monthly-report-generate
- monthly-report-scheduler
- reports-api
確認内容:
- ai_monthly_reports への統一確認
- onConflict条件の確認
- status遷移の確認

### Task 1.3: 型定義更新
ファイル: src/types/supabase.ts
確認内容:
- ai_monthly_reports の型が最新か
- 不要な型（monthly_reports）の整理

## Phase 2 詳細

### Task 2.1: レポート一覧コンポーネント
新規/修正ファイル:
- src/components/reports/MonthlyReportList.tsx
- src/hooks/useMonthlyReports.ts
機能:
- period_start でのフィルタリング
- ステータス表示（generating/completed/failed）
- ページネーション

### Task 2.2: レポート詳細コンポーネント
新規/修正ファイル:
- src/components/reports/MonthlyReportDetail.tsx
- src/components/reports/ReportSections.tsx
機能:
- metrics 表示
- sections 展開表示
- suggestions 表示

### Task 2.3: レポート再生成UI
新規/修正ファイル:
- src/components/reports/RegenerateButton.tsx
- src/hooks/useReportRegeneration.ts
機能:
- 残り回数表示
- 確認ダイアログ
- 進捗表示

### Task 2.4: Realtime通知
新規/修正ファイル:
- src/hooks/useReportNotifications.ts
- src/components/notifications/ReportToast.tsx
機能:
- 生成完了通知
- エラー通知
- 自動リフレッシュ

================================================================================
5. DB側に不足している可能性のある機能
================================================================================

コード分析から、以下のDB機能が不足している可能性があります：

1. user_preferences テーブル
   - ユーザー個別設定の保存
   - 通知設定、表示設定等

2. notification_settings テーブル
   - 通知チャンネル設定
   - 頻度設定

3. dashboard_widgets テーブル
   - ダッシュボードカスタマイズ
   - ウィジェット配置設定

4. scheduled_reports テーブル
   - 定期レポート配信設定
   - 配信先、スケジュール

5. api_keys テーブル
   - ユーザーAPIキー管理
   - レート制限設定

6. webhooks テーブル
   - Webhook設定
   - イベント購読設定

Supabaseアシスタントに上記の存在有無を確認してください。

================================================================================
