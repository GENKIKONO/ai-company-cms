# 要件定義変更ログ

## 変更概要

**日付**: 2025年9月28日  
**変更理由**: B2B2C（代理店中心）から**セルフサーブ＋代理店併存モデル**への移行  
**影響範囲**: システム全体（DB・API・UI・課金・運用）

## 差分サマリ表

### 追加された要件

| 分類 | 項目 | 旧要件 | 新要件 | 影響度 |
|------|------|--------|--------|--------|
| **ビジネスモデル** | ユーザー導線 | 代理店経由のみ | セルフサーブ + 代理店併存 | 🔴 高 |
| **認証・権限** | アクセス制御 | パートナー・管理者のみ | セルフサーブ・パートナー・管理者 | 🔴 高 |
| **データモデル** | organizations | パートナー所有 | created_by（1:1関係） | 🔴 高 |
| **API設計** | エンドポイント体系 | /api/organizations のみ | /api/my/* + /api/organizations/* | 🔴 高 |
| **課金システム** | 料金体系 | 代理店負担 | セルフサーブ ¥5,000/月 | 🟡 中 |
| **公開制御** | 承認フロー | 代理店・管理者承認 | セルフサーブは即時公開 | 🟡 中 |
| **UI/ナビ** | CTA分岐 | 単一導線 | ログイン状態による分岐 | 🟡 中 |
| **運用診断** | ヘルスチェック | 単一モード確認 | 両モード健全性確認 | 🟢 低 |

### 変更された要件

| 項目 | 変更前 | 変更後 | 理由 |
|------|--------|--------|------|
| **RLS ポリシー** | パートナー・組織プロファイル基準 | created_by + role 複合判定 | セルフサーブの1:1保護 |
| **エラーハンドリング** | 個別実装 | 統一 {code, message, details} | API整合性向上 |
| **認証ミドルウェア** | エンドポイント個別 | 統一requireAuth() | 保守性・セキュリティ向上 |
| **データ正規化** | エンドポイント個別 | 統一normalizePayload() | データ品質向上 |
| **環境変数管理** | 散在 | 統一env.ts with validation | 設定ミス防止 |

### 削除された要件

| 項目 | 削除理由 |
|------|----------|
| **B2B2C前提** | セルフサーブ導入により不要 |
| **承認ワークフロー必須** | セルフサーブは即時公開 |
| **代理店専用UI** | 両モード対応UIに統合 |

## 影響分析

### データベース影響

#### 🔴 高影響：スキーマ変更必須
- **organizations.created_by**: セルフサーブユーザー識別用
- **organizations.is_published**: 即時公開制御用
- **RLS ポリシー**: 併存モード対応の全面書き直し

#### 🟡 中影響：新規テーブル追加
- **stripe_customers**: セルフサーブ課金管理
- **subscriptions**: サブスクリプション状態管理
- **api_usage_logs**: 使用状況監査（将来の料金体系用）

#### 🟢 低影響：既存データ保護
- **後方互換性**: 既存代理店データは100%保護
- **マイグレーション**: ダウンタイム最小化戦略

### API影響

#### 🔴 高影響：エンドポイント体系変更
```typescript
// 新規追加（セルフサーブ専用）
POST /api/my/organization        // 企業作成（1ユーザー=1組織）
GET/PUT/DELETE /api/my/services  // 自組織サービス管理
POST /api/billing/checkout       // セルフサーブ課金

// 変更（代理店専用に限定）
POST /api/organizations          // partner権限必須
GET /api/organizations/[id]      // アクセス可能組織のみ

// 統一（認証・エラーハンドリング）
すべてのAPI: 統一認証ミドルウェア + エラーレスポンス
```

#### 🟡 中影響：レスポンス形式統一
- **成功レスポンス**: `{data, message?}` 形式
- **エラーレスポンス**: `{error: {code, message, details, timestamp}}` 形式
- **HTTPステータス**: 4xx/5xx責務分離

### UI/UX影響

#### 🔴 高影響：ナビゲーション規則変更
- **ロゴクリック**: 常に `/` 遷移（統一）
- **CTA分岐**: ログイン状態による動的変更
- **メニュー構成**: セルフサーブ・代理店別表示

#### 🟡 中影響：レスポンシブ対応強化
- **メール表示**: 狭幅対応（省略＋メニュー格納）
- **アバターメニュー**: モバイル最適化
- **フォーム**: セルフサーブ向け簡素化

### Stripe連携影響

#### 🔴 高影響：課金体系追加
- **新価格プラン**: ¥5,000/月（セルフサーブ専用）
- **Degraded運用**: 未設定時の基本機能提供
- **Webhook拡張**: セルフサーブ課金イベント処理

#### 🟢 低影響：既存代理店
- **無料継続**: 代理店は従来通り無料利用
- **機能維持**: 既存ワークフロー100%保護

### 運用影響

#### 🔴 高影響：診断・監視拡張
```typescript
// /ops/verify での確認項目追加
interface VerificationChecks {
  selfserve_flow: 'PASS' | 'FAIL';      // 新規追加
  partner_flow: 'PASS' | 'FAIL';        // 既存維持
  api_consistency: 'PASS' | 'FAIL';     // 新規追加
  dual_mode_isolation: 'PASS' | 'FAIL'; // 新規追加
}
```

#### 🟡 中影響：SLO更新
- **API成功率**: セルフサーブ・代理店別監視
- **レスポンス時間**: エンドポイント別測定
- **課金システム**: Stripe成功率監視

## リスク評価

### 高リスク（即座対応必須）

#### データ不整合リスク
- **問題**: RLS移行時の権限設定ミス
- **影響**: データ漏洩・不正アクセス
- **対策**: 段階的移行 + 全パターンテスト

#### 課金システム障害
- **問題**: Stripe連携不具合
- **影響**: セルフサーブユーザーの課金トラブル
- **対策**: Degraded運用モード + 手動フォローアップ

### 中リスク（計画的対応）

#### パフォーマンス劣化
- **問題**: RLSポリシー複雑化によるクエリ性能低下
- **影響**: 応答時間増加
- **対策**: インデックス最適化 + クエリチューニング

#### UX混乱
- **問題**: 併存モードでのUI複雑化
- **影響**: ユーザビリティ低下
- **対策**: 段階的UI展開 + ユーザーフィードバック収集

### 低リスク（継続監視）

#### 運用コスト増加
- **問題**: 両モード監視の複雑化
- **影響**: 運用工数増加
- **対策**: 自動化範囲拡大 + 診断ツール充実

## 成功指標

### 移行完了基準
- [ ] `/ops/verify` で ALL GREEN 達成
- [ ] 既存代理店機能 100% 動作継続
- [ ] セルフサーブ新規登録フロー 正常動作
- [ ] API エラー率 < 1%
- [ ] パフォーマンス劣化 < 10%

### ビジネス成功指標
- [ ] セルフサーブ新規登録: 週5件以上
- [ ] 代理店離脱: 0件
- [ ] 課金成功率: > 98%（Stripe設定時）
- [ ] システム稼働率: > 99.5%

---

**重要**: この変更ログを基に、すべての関係者が影響範囲を理解し、適切な対応を実施してください。