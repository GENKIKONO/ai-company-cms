# 🏗️ AIOHub プロジェクト機能棚卸しドキュメント

> **生成日時**: 2024年11月20日  
> **分析範囲**: 640 TypeScriptファイル、106 ページルート、171 APIルート  
> **棚卸し完了度**: 70% (コンテキスト限界により一部未解析)

---

## 📊 プロジェクト概要

### システム構成
- **フレームワーク**: Next.js 15 (App Router)
- **データベース**: Supabase (PostgreSQL + RLS)
- **認証**: Supabase Auth
- **決済**: Stripe (セグメント別価格体系)
- **デプロイ**: Vercel
- **コードベース規模**: 640ファイル、約200MB

### 主要機能カテゴリ
1. 🔐 **認証・ユーザー管理**
2. 🏢 **組織・代理店管理** 
3. 📝 **コンテンツ管理システム**
4. 💳 **決済・サブスクリプション**
5. 📊 **AI可視性・アナリティクス**
6. 🎯 **埋め込みWidget・公開API**
7. 👑 **管理・監査機能**
8. 📱 **モニタリング・診断**

---

## 🔐 認証・ユーザー管理

### ✅ **実装済み機能**
| 機能 | ページ/API | テスト状況 | 備考 |
|------|-----------|-----------|------|
| ログイン | `/auth/login` | ✅ E2E完備 | Supabase Auth |
| サインアップ | `/auth/signup` | ✅ E2E完備 | |
| パスワードリセット | `/auth/forgot-password` | 🟡 基本確認のみ | |
| セッション管理 | `/api/me` | ✅ スモークテスト済み | |
| ログアウト | N/A | ✅ E2E完備 | |

### 🟡 **部分実装・要調査**
- **Multi-factor Authentication**: 未解析
- **OAuth プロバイダー**: Google/GitHub統合の詳細未確認
- **セッション永続化**: Cookie設定・セキュリティポリシー未検証

### API一覧
```
/api/auth/
├── session (GET) - セッション確認
├── sync (POST) - 認証同期
└── callback/* - OAuth コールバック
```

---

## 🏢 組織・代理店管理

### ✅ **実装済み機能**
| 機能 | ページ/API | テスト状況 | セグメント対応 |
|------|-----------|-----------|--------------|
| 組織作成 | `/organizations/new` | ✅ E2E完備 | ✅ |
| 組織詳細 | `/organizations/[id]` | ✅ E2E完備 | ✅ |
| 組織公開ページ | `/o/[slug]` | 🟡 表示確認のみ | ✅ |
| 代理店管理 | `/agency/*` | ❌ 未テスト | **未解析** |
| 組織グループ | `/admin/org-groups` | ✅ 管理画面テスト済み | ✅ |

### 🔴 **高リスク未テスト領域**
- **代理店クライアント管理** (`/agency/[agencyId]/clients`)
- **組織間の権限継承**
- **請求権限の委譲**

### API一覧
```
/api/organizations/
├── [GET] - 組織一覧
├── [POST] - 組織作成
└── [slug]/ - 組織固有API

/api/my/organization/
├── [GET] - 自組織情報
└── publish [POST] - 公開設定

/api/public/organizations/
├── [GET] - 公開組織一覧
└── [slug] [GET] - 公開組織詳細
```

---

## 📝 コンテンツ管理システム (CMS)

### ✅ **実装済み機能**
| コンテンツタイプ | ページ | API | テスト状況 |
|------------------|--------|-----|-----------|
| **投稿 (Posts)** | `/dashboard/posts` | `/api/my/posts` | ✅ E2E完備 |
| **サービス** | `/dashboard/services` | `/api/my/services` | 🟡 基本確認 |
| **FAQ** | `/my/faqs` | `/api/my/faqs` | 🟡 基本確認 |
| **ケーススタディ** | `/organizations/[id]/case-studies` | `/api/my/case-studies` | 🟡 基本確認 |
| **素材管理** | `/dashboard/materials` | `/api/my/materials` | 🟡 基本確認 |

### 📋 **コンテンツ機能詳細**
- **公開/非公開切替**: ✅ テスト済み
- **リッチテキストエディタ**: 実装済み（詳細未解析）
- **画像アップロード**: 実装済み（Supabase Storage）
- **SEO メタデータ**: 実装済み（JSON-LD対応）
- **多言語対応**: 6言語対応 (en/ja/ko/zh/es/fr/de)

### 🔴 **未テスト高リスク領域**
- **一括編集・インポート機能**
- **バージョン管理・履歴**
- **コンテンツ承認ワークフロー**

---

## 💳 決済・サブスクリプション

### ✅ **セグメント別価格体系** (重要実装)
| ユーザーセグメント | 割引率 | 対象プラン | テスト状況 |
|-------------------|--------|-----------|-----------|
| `test_user` | 30%割引 | 全プラン | ✅ E2E完備 |
| `early_user` | 20%割引 | 全プラン | ✅ E2E完備 |
| `normal_user` | 割引なし | 全プラン | ✅ E2E完備 |

### 📊 **プラン構造**
- **Starter/Basic**: 基本機能
- **Pro**: AI レポート・高度アナリティクス
- **Business**: エンタープライズ機能  
- **Enterprise**: カスタム機能（未解析詳細）

### API一覧
```
/api/billing/
├── checkout [POST] - レガシー決済
├── checkout-segmented [POST] - セグメント別決済 ✅
├── portal [GET] - 顧客ポータル
└── webhook - Stripe Webhook

/api/stripe/
├── customer-portal [POST]
└── webhook [POST] - Stripe イベント処理
```

### 🟡 **要調査領域**
- **請求書生成・管理**
- **使用量ベース課金**
- **企業契約・年間契約**

---

## 📊 AI可視性・アナリティクス

### 🔴 **高リスク領域** (重要度最高)
| 機能 | API | テスト状況 | ビジネス影響 |
|------|-----|-----------|-------------|
| **AI可視性スコア計算** | `/api/analytics/ai/recalculate` | ❌ 未テスト | 🔴 売上直結 |
| **可視性データ取得** | `/api/analytics/ai/visibility` | ❌ 未テスト | 🔴 顧客体験 |
| **統合レポート** | `/api/analytics/ai/combined` | ❌ 未テスト | 🔴 競合差別化 |
| **ボットログ分析** | `/api/analytics/ai/bot-logs` | ❌ 未テスト | 🟡 運用監視 |
| **SEO連携** | `/api/analytics/seo/gsc` | ❌ 未テスト | 🟡 マーケ支援 |

### 📈 **ダッシュボード機能**
- **AI可視性カード**: 実装済み（useEffect警告あり）
- **パフォーマンスメトリクス**: 実装済み
- **アナリティクスグラフ**: 実装済み（詳細未解析）

### ⚠️ **技術的負債**
- **TODO/FIXME**: 6ファイルに技術的課題あり
- **パフォーマンス最適化**: 未実装
- **エラーハンドリング**: 不完全

---

## 🎯 埋め込みWidget・公開API

### 🔴 **高リスク未テスト領域** 
| Widget種類 | API | 公開影響度 | テスト状況 |
|------------|-----|-----------|-----------|
| **iframe埋め込み** | `/api/public/embed/[slug]/iframe` | 🔴 高 | ❌ 未テスト |
| **Widget埋め込み** | `/api/public/embed/[slug]/widget` | 🔴 高 | ❌ 未テスト |
| **レガシーiframe** | `/api/public/embed/iframe/[slug]` | 🟡 中 | ❌ 未テスト |
| **レガシーWidget** | `/api/public/embed/widget/[slug]` | 🟡 中 | ❌ 未テスト |

### 📡 **公開API**
```
/api/public/
├── organizations/ - 組織情報API
├── posts/ - 公開投稿API  
├── faqs/ - 公開FAQ API
├── case-studies/ - ケーススタディAPI
├── services/ - サービスAPI
├── stats/ - 統計API
├── sitemap/ - サイトマップ
└── openapi.json/ - API仕様書
```

### 🔗 **SEO・構造化データ**
- **JSON-LD**: `/api/public/[slug]/jsonld` - 実装済み
- **サイトマップ**: 自動生成機能あり
- **RSS フィード**: 実装確認済み

---

## 👑 管理・監査機能

### ✅ **管理コンソール** (`/management-console/`)
| 機能 | テスト状況 | 権限レベル |
|------|-----------|-----------|
| レポート管理 | ✅ 基本確認 | 組織管理者 |
| ユーザー管理 | ✅ 基本確認 | 組織管理者 |
| 設定管理 | ✅ 基本確認 | 組織管理者 |
| 連絡先管理 | ✅ 基本確認 | 組織管理者 |
| ヒアリング管理 | ✅ 基本確認 | 組織管理者 |
| 埋め込みダッシュボード | ✅ 基本確認 | 組織管理者 |

### 👨‍💼 **システム管理** (`/admin/`)
| 機能 | API | テスト状況 | 権限レベル |
|------|-----|-----------|-----------|
| **AI可視性管理** | `/api/admin/ai-visibility/*` | ✅ 基本確認 | システム管理者 |
| **素材統計** | `/api/admin/material-stats` | ✅ 基本確認 | システム管理者 |
| **Q&A統計** | `/api/admin/qna-stats` | ✅ 基本確認 | システム管理者 |
| **請求分析** | `/api/admin/billing-analytics/*` | 🟡 未詳細確認 | システム管理者 |
| **機能管理** | `/api/admin/feature-management` | 🟡 未詳細確認 | システム管理者 |

### 🔴 **Enforcement (監査・執行)** - 高リスク未テスト
| 機能 | API | 潜在リスク |
|------|-----|-----------|
| **違反検出** | `/api/enforcement/violations` | アカウント誤停止 |
| **警告処理** | `/api/enforcement/actions/warn` | 顧客関係悪化 |
| **アカウント停止** | `/api/enforcement/actions/suspend` | 売上損失 |
| **アカウント凍結** | `/api/enforcement/actions/freeze` | 法的問題 |
| **復帰処理** | `/api/enforcement/actions/reinstate` | 運用混乱 |

---

## 📱 モニタリング・診断

### ✅ **診断エンドポイント**
| エンドポイント | 機能 | テスト状況 |
|---------------|------|-----------|
| `/api/diag/echo` | リクエスト解析 | ✅ スモークテスト済み |
| `/api/diag/env` | 環境変数確認 | ✅ スモークテスト済み |
| `/api/diag/database` | DB接続確認 | 🟡 基本確認 |
| `/api/diag/auth-context` | 認証状態確認 | 🟡 基本確認 |
| `/api/diag/security` | セキュリティ確認 | 🟡 基本確認 |
| `/api/diag/comprehensive` | 統合診断 | 🟡 基本確認 |

### 📊 **メトリクス・監視**
- **`/api/monitoring/metrics`**: システムメトリクス（未詳細確認）
- **`/api/health/*`**: ヘルスチェック（未詳細確認）
- **Sentry統合**: エラー監視実装済み

---

## 🗂️ データベーススキーマ (推定)

### 主要テーブル構造
```sql
-- 推定スキーマ（実際の確認未実施）
users                   -- ユーザー情報
organizations          -- 組織情報  
posts                  -- 投稿
services               -- サービス
faqs                   -- FAQ
case_studies          -- ケーススタディ
materials             -- 素材
subscriptions         -- サブスクリプション
ai_visibility_scores  -- AI可視性スコア
violations            -- 違反記録
audit_logs            -- 監査ログ
```

### 🔐 **RLSポリシー**
- **実装確認済み**: 基本的なRLSポリシー存在
- **詳細未解析**: 具体的なポリシー内容・テスト状況

---

## 🚨 リスク評価・優先対応事項

### 🔴 **緊急度: 高** (今週対応)
1. **AI Analytics APIテスト不足** - 売上直結機能
2. **Enforcement APIテスト不足** - アカウント制御リスク  
3. **埋め込みWidgetテスト不足** - 公開機能の品質問題
4. **useEffect警告40件** - パフォーマンス・バグリスク

### 🟡 **緊急度: 中** (今月対応)  
1. **代理店機能の未検証** - B2B展開への影響
2. **包括的APIテスト戦略** - 運用品質向上
3. **パフォーマンステスト** - ユーザー体験向上
4. **セキュリティテスト** - 情報セキュリティ

### 🟢 **緊急度: 低** (来月以降)
1. **レガシー機能の整理** - 技術的負債削減
2. **ドキュメント整備** - 開発効率向上  
3. **監視・アラート強化** - 運用自動化

---

## 📈 テストカバレッジ現状

### ✅ **高カバレッジ領域** (70%+)
- 認証フロー (ログイン・ログアウト・セッション)
- 基本的な投稿管理 (CRUD・公開切替)
- セグメント別決済フロー
- 管理画面基本アクセス

### 🟡 **中カバレッジ領域** (30-70%)
- 組織管理機能
- コンテンツ管理詳細機能
- 診断・モニタリング機能

### 🔴 **低カバレッジ領域** (0-30%)
- AI Analytics 機能群 
- 埋め込みWidget機能群
- Enforcement 機能群  
- 代理店管理機能群
- パフォーマンス・セキュリティ側面

---

## 🔧 技術的負債・改善事項

### 📊 **コード品質**
- **ESLint警告**: 40件（うち95%がuseEffect依存配列）
- **TypeScriptエラー**: 0件（良好）
- **バックアップファイル**: 10+件（要削除）
- **TODO/FIXME**: 10ファイル（技術的負債あり）

### ⚡ **パフォーマンス**
- **バンドルサイズ**: ~200MB（要最適化検討）
- **画像最適化**: 一部でNext.js Image未使用
- **依存配列問題**: 不要な再レンダリング発生リスク

### 🔒 **セキュリティ**
- **基本対策**: ESLintルールで基本的なセキュリティ対策
- **RLS実装**: 基本的なRow Level Security実装済み
- **詳細検証**: 包括的セキュリティテスト未実施

---

## 🎯 今後の開発ロードマップ

### Phase 1: 品質安定化 (2-3週間)
1. AI Analytics API群のテスト実装
2. Enforcement機能の包括テスト
3. useEffect警告の段階的修正
4. 埋め込みWidget E2E実装

### Phase 2: 機能完成度向上 (1-2ヶ月)  
1. 代理店機能の検証・強化
2. パフォーマンス最適化
3. セキュリティテスト導入
4. 監視・アラート強化

### Phase 3: スケール対応 (3-6ヶ月)
1. 負荷テスト・キャパシティプランニング
2. マルチリージョン対応
3. 高可用性アーキテクチャ
4. 自動運用・DevOps強化

---

## 📝 付録

### 🔍 **分析の限界・未解析範囲**

#### **コンテキスト制約により未解析**
- **動的コンテンツ**: データベース内容・本番環境固有設定
- **外部連携**: Google Analytics/Search Console詳細設定
- **運用プロセス**: デプロイメント・監視・バックアップ手順
- **パフォーマンス指標**: 実際のレスポンス時間・負荷特性

#### **今回確認できなかった重要事項**  
- **本番環境の動作状況**: 開発環境とのギャップ
- **実際のユーザー行動**: アクセスパターン・利用状況  
- **外部サービス依存**: Stripe/Supabase/Vercel制限・障害対応
- **災害復旧**: バックアップ・復旧手順・RPO/RTO

### 🛠️ **生成スクリプト一覧**
- `scripts/api-smoke-test-critical.js` - 危険領域APIスモークテスト  
- `scripts/fix-useeffect-warnings.js` - useEffect警告修正パッチ
- `.github/workflows/mandatory-pr-checks.yml` - 必須CI GitHub Actions

### 📚 **参考資料**
- [要件定義（ビジネス視点）](requirements_business.md)
- [要件定義（システム/技術視点）](requirements_system.md)  
- [実装ガイドライン](implementation.md)
- [DESIGN_SYSTEM.md](../DESIGN_SYSTEM.md)

---

*📅 最終更新: 2024年11月20日*  
*🤖 生成者: Claude Code AI Assistant*  
*📊 分析対象: 640ファイル、106ページ、171API*