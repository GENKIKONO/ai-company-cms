# 🔴 クリティカルテスト チェックリスト（必須）

> **⚠️ これらが全て成功するまで本番リリース禁止**

## 🚨 【実行前必読】やってはいけないこと

```
❌ 本番データに影響する操作は絶対禁止:
- データベースでのDELETE/UPDATE文実行
- 実在顧客情報でのテスト（架空データのみ使用）
- 本番Stripe（sk_live_）での決済実行
- 実在メールアドレスへのテスト送信
- 認証情報・機微情報をログに記録

✅ 安全なテスト実行:
- テストカード: 4242 4242 4242 4242 のみ使用
- テストメール: test-uat@luxucare.jp など専用アドレス
- ログは認証情報をマスキング（****）
- 疑問時は実行前に開発チームに確認
```

**所要時間**: 約40分  
**実行者**: ________________  
**実行日時**: ________________

---

## 🚨 重要：最低限自動化とセキュリティ注意事項

### 認証テストの半自動化
認証テストは**手動操作が前提**ですが、テスト完了時に状態証跡を残すため、以下の手順を推奨：

```bash
# 手動テスト完了後、認証状態を確認（セルフテストAPI使用）
curl -X GET "https://aiohub.jp/api/selftest/auth" \
  -H "Authorization: Bearer YOUR_SUPABASE_TOKEN" \
  -H "Accept: application/json"

# 期待レスポンス: {"ok": true, "user": {"id": "redacted"}, "timestamp": "..."}
# このレスponseをログに記録することで、認証テスト完了の証跡とする
```

### Stripe/Resendテストの安全設定

⚠️ **絶対に守ること:**
- **Stripe**: テストモードのみ使用。本番キー（`sk_live_`）は絶対に使用禁止
- **Resend**: テスト宛先のみ送信。大量送信や本番リスト送信禁止
- **テストカード**: `4242 4242 4242 4242` 以外の実際のカード情報は使用禁止

```bash
# テストモード確認
echo "Stripe Dashboard > 左上で 'テストデータを表示' が選択されていることを確認"
echo "環境変数 STRIPE_SECRET_KEY が sk_test_ で始まることを確認（本番では sk_live_）"

# Resend安全確認
echo "送信先メールアドレスは critical-test+*@luxucare.jp のみ使用"
echo "大量送信（1時間に10通以上）は禁止"
```

### 本番データ保護
- 既存の本番企業データを**変更・削除しない**
- テスト用データには必ず「テスト」「critical-test」等の識別子を含める
- テスト完了後、作成したテストデータは**必ず削除**

---

## 📋 テスト準備

### テスト用データ準備
```bash
# テスト用メールアドレス（実際に受信可能なもの）
TEST_EMAIL="critical-test-$(date +%s)@luxucare.jp"
TEST_PASSWORD="CriticalTest123!"

# 企業情報
ORG_NAME="クリティカルテスト株式会社"
ORG_DESC="本番環境での基本動作確認用企業"
ORG_URL="https://critical-test.example.com"
ORG_TEL="03-0000-0000"

# Stripe テストカード
CARD_NUMBER="4242 4242 4242 4242"
CARD_EXPIRY="12/34"
CARD_CVC="123"
```

### 実行環境確認
- [ ] 事前チェック: 全て完了済み
- [ ] ブラウザ: Chrome/Firefox（開発者ツール使用）
- [ ] ネットワーク: 安定した接続
- [ ] スクリーンショット保存準備: `docs/uat/logs/$(date +%Y%m%d)/screenshots/`

---

## 🔴 テスト1: 基本認証フロー（10分）

### 1-1: 新規登録
**実行手順**:
1. ブラウザで https://aiohub.jp/auth/signup を開く
2. 上記テストメール・パスワードで新規登録実行
3. 「アカウント作成」ボタンクリック

**確認項目**:
- [ ] ✅ フォーム送信: エラーなし
- [ ] ✅ 完了メッセージ: 「確認メールを送信しました」表示
- [ ] ✅ リダイレクト: 適切なページ遷移

**証跡**:
- [ ] スクリーンショット: `auth-flow/signup-completed.png`
- [ ] 実行時刻: ________________

### 1-2: メール確認
**実行手順**:
1. テストメールアドレスの受信ボックスを確認
2. Supabase からの確認メール受信待ち（最大5分）
3. メール内の確認リンクをクリック

**確認項目**:
- [ ] ✅ メール受信: 5分以内に受信
- [ ] ✅ 送信者: Supabase または設定された送信者
- [ ] ✅ 件名: 適切なメール確認件名
- [ ] ✅ リンク: https://aiohub.jp/auth/confirm?... 形式

**証跡**:
- [ ] スクリーンショット: `auth-flow/email-received.png`
- [ ] 受信時刻: ________________

### 1-3: メール確認完了
**実行手順**:
1. 確認リンククリック
2. /auth/confirm ページ表示確認
3. 自動リダイレクト待ち

**確認項目**:
- [ ] ✅ 確認ページ表示: 「確認完了」メッセージ
- [ ] ✅ ダッシュボードリダイレクト: 3秒以内に自動遷移
- [ ] ✅ ダッシュボード表示: 「ようこそ」などのウェルカムメッセージ
- [ ] ✅ ナビゲーション: 適切なメニュー表示

**証跡**:
- [ ] スクリーンショット: `auth-flow/confirmation-completed.png`
- [ ] スクリーンショット: `auth-flow/dashboard-landing.png`

### 1-4: ログイン・ログアウト確認
**実行手順**:
1. ログアウト実行
2. /auth/login でログイン実行
3. ダッシュボードアクセス確認

**確認項目**:
- [ ] ✅ ログアウト: 正常にトップページにリダイレクト
- [ ] ✅ ログイン: 同一認証情報で正常ログイン
- [ ] ✅ セッション維持: ページリロードでもログイン状態維持
- [ ] ✅ 認証要求: 未ログイン時に /dashboard アクセス → ログインページリダイレクト

**成功基準**:
- メール送信: 30秒以内
- ページ遷移: 3秒以内
- セッション維持: 24時間有効

---

## 🔴 テスト2: 企業作成→公開フロー（15分）

### 2-1: 企業作成
**実行手順**:
1. ダッシュボードで「新規企業追加」または類似ボタンをクリック
2. 上記企業データを入力
3. 「保存」ボタンクリック

**確認項目**:
- [ ] ✅ フォーム表示: 全項目が適切に表示
- [ ] ✅ データ入力: エラーなく入力可能
- [ ] ✅ バリデーション: 適切な入力チェック
- [ ] ✅ 保存成功: 「保存しました」等の成功メッセージ

**証跡**:
- [ ] スクリーンショット: `company-flow/create-form.png`
- [ ] スクリーンショット: `company-flow/save-success.png`

### 2-2: 企業詳細確認
**実行手順**:
1. 作成した企業の詳細ページに遷移
2. 入力したデータが正しく表示されることを確認
3. 編集機能の動作確認

**確認項目**:
- [ ] ✅ データ表示: 入力した全データが正確に表示
- [ ] ✅ レイアウト: 適切なデザインで表示
- [ ] ✅ 編集ボタン: 編集画面に遷移可能
- [ ] ✅ ナビゲーション: 他ページへの移動可能

**証跡**:
- [ ] スクリーンショット: `company-flow/detail-page.png`

### 2-3: 公開設定
**実行手順**:
1. 「公開管理」タブまたは類似機能にアクセス
2. 法的同意事項にチェック
3. 「公開する」ボタンクリック

**確認項目**:
- [ ] ✅ 公開管理画面: 適切に表示
- [ ] ✅ 法的同意: 利用規約・プライバシーポリシー等のチェックボックス
- [ ] ✅ 公開前チェック: 必要データの事前検証
- [ ] ✅ 公開実行: 「公開しました」等の完了メッセージ

**証跡**:
- [ ] スクリーンショット: `company-flow/publish-settings.png`
- [ ] スクリーンショット: `company-flow/publish-success.png`

### 2-4: 公開ページ確認
**実行手順**:
1. 公開されたページのURL取得（/o/[slug] 形式）
2. 新しいタブで公開ページにアクセス
3. JSON-LD構造化データの確認

**確認項目**:
- [ ] ✅ 公開ページアクセス: エラーなくページ表示
- [ ] ✅ 表示速度: 3秒以内での完全読み込み
- [ ] ✅ デザイン: 適切なレイアウトとスタイル
- [ ] ✅ データ表示: 企業情報が正確に表示

**JSON-LD確認**:
```javascript
// ブラウザ開発者ツール > Console で実行
document.querySelectorAll('script[type="application/ld+json"]').forEach((script, index) => {
  console.log(`Schema ${index + 1}:`, JSON.parse(script.textContent));
});
```

**確認項目**:
- [ ] ✅ JSON-LD存在: `<script type="application/ld+json">` タグ確認
- [ ] ✅ Organization schema: @type="Organization" データ存在
- [ ] ✅ 必須プロパティ: name, url, description 存在
- [ ] ✅ 構文正確性: JSONパースエラーなし

**証跡**:
- [ ] スクリーンショット: `company-flow/public-page.png`
- [ ] 公開URL記録: ________________

**成功基準**:
- データ保存: エラーなし
- 公開ページ: 3秒以内表示
- SEO: JSON-LD正常出力

---

## 🔴 テスト3: 決済→サブスクリプション（10分）

### 3-1: プラン選択
**実行手順**:
1. 企業詳細ページの「サブスクリプション管理」にアクセス
2. 「初期費用なしプラン」を選択
3. Stripe Checkout への遷移確認

**確認項目**:
- [ ] ✅ サブスクリプション画面: 適切に表示
- [ ] ✅ プラン表示: 価格・内容が正確
- [ ] ✅ 選択ボタン: 正常に動作
- [ ] ✅ Stripe遷移: https://checkout.stripe.com/ への正常遷移

**証跡**:
- [ ] スクリーンショット: `payment-flow/plan-selection.png`
- [ ] スクリーンショット: `payment-flow/stripe-checkout.png`

### 3-2: 決済処理
**実行手順**:
1. Stripe Checkout でテストカード情報を入力
2. 支払い実行
3. 完了後の画面確認

**入力データ**:
- カード番号: `4242 4242 4242 4242`
- 有効期限: `12/34`
- CVC: `123`
- 名前: `Test User`

**確認項目**:
- [ ] ✅ カード情報入力: エラーなく入力可能
- [ ] ✅ 決済処理: 60秒以内で完了
- [ ] ✅ 処理結果: 成功メッセージ表示
- [ ] ✅ リダイレクト: ダッシュボードに正常復帰

**証跡**:
- [ ] スクリーンショット: `payment-flow/payment-success.png`
- [ ] スクリーンショット: `payment-flow/dashboard-return.png`

### 3-3: サブスクリプション状態確認
**実行手順**:
1. ダッシュボードでサブスクリプション状態確認
2. Supabase SQLエディタでDB確認

**DB確認クエリ**:
```sql
-- ユーザーのサブスクリプション状態確認
SELECT 
  u.email,
  u.subscription_status,
  u.stripe_customer_id,
  u.updated_at
FROM users u 
WHERE u.email = '[テストメールアドレス]';

-- 組織のサブスクリプション確認
SELECT 
  o.name,
  o.subscription_status,
  o.stripe_subscription_id,
  o.updated_at
FROM organizations o
JOIN users u ON o.user_id = u.id
WHERE u.email = '[テストメールアドレス]';
```

**確認項目**:
- [ ] ✅ 画面表示: 「アクティブ」等の状態表示
- [ ] ✅ DB更新: subscription_status = 'active'
- [ ] ✅ Stripe ID: stripe_customer_id 設定済み
- [ ] ✅ 更新時刻: 決済後30秒以内のupdated_at

**証跡**:
- [ ] スクリーンショット: `payment-flow/subscription-active.png`
- [ ] DB確認結果: ________________

**成功基準**:
- 決済処理: 60秒以内完了
- Webhook: 30秒以内にDB更新
- ステータス: 'active'に変更

---

## 🔴 テスト4: セキュリティ基本確認（5分）

### 4-1: RLS動作確認
**実行手順**:
1. Supabase SQLエディタで他社データアクセス試行
2. 結果確認

**実行クエリ**:
```sql
-- 他のユーザーの企業データにアクセス試行
SELECT * FROM organizations WHERE user_id != auth.uid();

-- 権限外操作の試行
DELETE FROM organizations WHERE user_id != auth.uid();
```

**確認項目**:
- [ ] ✅ SELECT結果: 0 rows（他社データアクセス拒否）
- [ ] ✅ DELETE結果: エラーまたは0 rows affected
- [ ] ✅ エラーメッセージ: 適切な権限エラー表示

**証跡**:
- [ ] スクリーンショット: `security-checks/rls-test.png`

### 4-2: URL改ざん確認
**実行手順**:
1. 他社の企業IDで直接URLアクセス試行
2. 権限エラーの確認

**テストURL**:
- `/dashboard/organizations/[他社ID]`
- `/dashboard/organizations/999999`

**確認項目**:
- [ ] ✅ アクセス拒否: 403エラーまたはリダイレクト
- [ ] ✅ エラーページ: 適切なエラー画面表示
- [ ] ✅ 情報漏洩なし: 他社データが表示されない

**証跡**:
- [ ] スクリーンショット: `security-checks/url-manipulation.png`

### 4-3: XSS防止確認
**実行手順**:
1. 企業作成フォームで悪意あるスクリプト入力
2. エスケープ処理の確認

**テスト入力**:
- 企業名: `<script>alert('XSS')</script>`
- 説明: `<img src="x" onerror="alert('XSS')">`

**確認項目**:
- [ ] ✅ スクリプト実行なし: alert等が実行されない
- [ ] ✅ 適切エスケープ: HTMLタグが文字列として表示
- [ ] ✅ 保存処理: エラーまたは適切なバリデーション

**証跡**:
- [ ] スクリーンショット: `security-checks/xss-prevention.png`

### 4-4: 認証要求確認
**実行手順**:
1. ログアウト状態で保護されたページにアクセス
2. リダイレクト動作確認

**テストURL**:
- `/dashboard`
- `/dashboard/organizations/new`

**確認項目**:
- [ ] ✅ リダイレクト: /auth/login への自動リダイレクト
- [ ] ✅ 元URL保持: ログイン後に元URLに復帰
- [ ] ✅ セッション管理: 適切なセッション処理

**成功基準**:
- 他社データ: 完全アクセス拒否
- XSS防止: スクリプト実行なし
- 認証要求: 未ログイン時適切リダイレクト

---

## ✅ クリティカルテスト完了判定

### 必須項目チェック
- [ ] 🔴 基本認証フロー: 全手順成功
- [ ] 🔴 企業作成→公開: 全手順成功
- [ ] 🔴 決済→サブスクリプション: 全手順成功
- [ ] 🔴 セキュリティ基本確認: 全手順成功

### 証跡ファイル確認
- [ ] スクリーンショット: 全て保存済み
- [ ] 実行ログ: エラーなし
- [ ] DB確認: 期待通りの結果

### 判定基準
```bash
if [ 全4項目が成功 ]; then
  echo "✅ クリティカルテスト完了 - 本番リリース可能"
  RELEASE_STATUS="APPROVED"
else
  echo "❌ クリティカルテスト失敗 - 本番リリース禁止"
  RELEASE_STATUS="BLOCKED"
fi
```

### 最終判定
**[ ] ✅ 全テスト成功 → 本番リリース可能**  
**[ ] ❌ 一部失敗 → 問題修正まで本番リリース禁止**

### 実行結果記録
```
実行日時: ________________
実行者: ________________
成功項目: _/4
総所要時間: ________________
最終判定: ________________
```

---

## 🚨 失敗時の対応

### 即座に実行すべきアクション
1. **テスト停止**: これ以降のテスト実行停止
2. **問題記録**: 詳細なエラー内容・スクリーンショット保存
3. **関係者連絡**: 技術責任者・開発チーム・QA担当に即座に連絡
4. **修正対応**: 問題修正後、クリティカルテスト全体を再実行

### エスカレーション連絡先
```markdown
🔴 緊急（認証・決済・セキュリティ問題）: [技術責任者]
🟡 重要（機能問題）: [開発チーム]
🟢 軽微（UI問題）: [QA担当]
```

---

**🎯 全クリティカルテストが成功したら、次のステップ『重要テスト』に進んでください。失敗した場合は問題修正まで本番リリースを延期してください。**