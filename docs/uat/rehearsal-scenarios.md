# 🎭 UATリハーサル実行シナリオ

本番環境でのUAT実行前に、安全にシステムを検証するためのリハーサルシナリオ集です。

## 📋 リハーサル実施計画

### 📅 推奨スケジュール

| リハーサル | 本番日からの逆算 | 所要時間 | 目的 |
|------------|------------------|----------|------|
| **第1回リハーサル** | 本番1週間前 | 60分 | 基本機能確認・手順習得 |
| **第2回リハーサル** | 本番3日前 | 180分 | 本番想定フルフロー |

### 👥 参加者

**第1回リハーサル**: QA担当者2名、開発者1名  
**第2回リハーサル**: QA担当者、開発者、PM、ステークホルダー

---

## 🎯 シナリオ1: 基本機能確認リハーサル（60分）

### 目的
- UATツールの動作確認
- 基本手順の習得
- 問題発見と解決方法の確認

### 📝 実行チェックリスト

#### ✅ 事前準備（10分）

- [ ] **環境確認完了**
  ```bash
  # リポジトリ確認
  pwd
  # 期待値: /Users/.../LuxuCare株式会社/開発
  
  # ブランチ確認
  git branch --show-current
  # 期待値: main または development
  
  # Node.js確認
  node --version
  # 期待値: v18.x.x 以上
  ```

- [ ] **依存関係インストール完了**
  ```bash
  npm install
  # 期待値: エラーなし、package-lock.json更新
  ```

#### ⚡ GitHub Actions手動実行テスト（20分）

- [ ] **手動実行開始**
  1. GitHub > Actions > "UAT Preflight Checks" 選択
  2. "Run workflow" クリック
  3. Branch: `main` 選択
  4. "Run workflow" 実行

**期待される出力（成功時）**:
```
✅ Environment Variables Check: PASS
✅ DNS/SSL Verification: PASS  
✅ API Endpoint Verification: PASS
🎉 All preflight checks passed!
```

**期待される出力（失敗時）**:
```
❌ Environment Variables Check: FAIL
⚠️ 2 項目で問題が検出されました
```

- [ ] **Artifacts確認**
  - [ ] "uat-preflight-logs" アーティファクトのダウンロード
  - [ ] ログファイル内容確認（execution.log, env-check.log等）

- [ ] **PR自動コメント確認**（PR作成時）
  - [ ] 事前チェック結果テーブル表示
  - [ ] リリース判定表示
  - [ ] 次のアクション表示

#### 💻 ローカル実行テスト（20分）

- [ ] **事前チェック実行**
  ```bash
  npm run uat:preflight
  ```

**成功時の期待出力**:
```
🔧 環境変数検証開始
✅ NEXTAUTH_URL: OK
✅ STRIPE_SECRET_KEY: OK
📊 検証結果サマリー: ✅ 正常: 7件 ❌ エラー: 0件

🌐 DNS/SSL検証開始
✅ aiohub.jp DNS解決: OK
✅ SSL証明書: 有効
📊 検証結果: 全て正常

🔌 APIエンドポイント検証開始
✅ /api/health: 200 OK
✅ /api/auth: 200 OK
📊 検証結果: 全エンドポイント疎通
```

**失敗時の典型的出力**:
```
❌ NEXTAUTH_URL: 未設定
❌ DNS解決失敗: aiohub.jp
❌ /api/stripe/webhook: 404 Not Found
🚨 環境変数に問題があります
```

- [ ] **個別チェック実行**
  ```bash
  npm run uat:env-check
  npm run uat:dns-check  
  npm run uat:endpoint-check
  ```

- [ ] **レポート生成テスト**
  ```bash
  npm run uat:report
  ```

**期待出力**:
```
📊 UAT結果レポートを生成中...
✅ テスト結果収集完了
✅ レポート生成完了: docs/uat/logs/YYYYMMDD/uat-report.md
🎯 リリース判定: 事前チェック完了
```

#### 📊 結果記録（10分）

- [ ] **生成されたファイル確認**
  ```bash
  ls docs/uat/logs/$(date +%Y%m%d)/
  # 期待値: uat-report.md が存在
  ```

- [ ] **レポート内容確認**
  - [ ] 実行情報（日時、実行者、環境、コミット）
  - [ ] リリース判定（🟢/🟡/🔴）
  - [ ] テスト結果詳細（事前チェック結果）
  - [ ] 次のアクション

---

## 🚀 シナリオ2: 本番想定フルフローリハーサル（180分）

### 目的
- 本番と同じ流れでの完全検証
- 想定される問題への対応確認
- チーム連携の確認

### 📝 実行チェックリスト

#### 🏗️ 事前準備（30分）

- [ ] **チーム参集確認**
  - [ ] QA担当者: リード、サブ
  - [ ] 開発者: フロントエンド、バックエンド
  - [ ] PM: プロジェクトマネージャー
  - [ ] 連絡体制確認（Slack/Discord等）

- [ ] **テスト環境セットアップ**
  - [ ] 本番環境 https://aiohub.jp アクセス確認
  - [ ] 管理画面アクセス権限確認
  - [ ] テスト用データ準備
    - [ ] テスト用メールアドレス: `rehearsal-test@luxucare.jp`
    - [ ] Stripeテストカード: `4242 4242 4242 4242`
    - [ ] テスト企業情報準備

#### ⚡ Phase 1: 自動化検証（30分）

- [ ] **GitHub Actions実行**
  ```
  実行者: ________
  開始時刻: ____時____分
  終了時刻: ____時____分
  ```

- [ ] **結果記録**
  - [ ] 環境変数チェック: ✅ PASS / ❌ FAIL
  - [ ] DNS/SSL検証: ✅ PASS / ❌ FAIL
  - [ ] APIエンドポイント確認: ✅ PASS / ❌ FAIL
  - [ ] 総合判定: ✅ PASS / ❌ FAIL

**失敗時の対応手順**:
```
1. Artifactsダウンロード
2. ログファイル分析
3. 問題特定・開発チームエスカレーション
4. 修正後再実行
```

#### 🔴 Phase 2: クリティカルテスト（40分）

- [ ] **基本認証フロー（10分）**
  - [ ] 新規登録: `rehearsal-user@luxucare.jp`
  - [ ] メール認証確認
  - [ ] ログイン成功確認
  - [ ] ダッシュボードアクセス確認

- [ ] **企業作成→公開フロー（15分）**
  - [ ] 企業情報入力: "リハーサル株式会社"
  - [ ] 画像アップロード
  - [ ] プレビュー確認
  - [ ] 公開実行
  - [ ] 公開ページ表示確認

- [ ] **決済→サブスクリプションフロー（10分）**
  - [ ] プラン選択画面
  - [ ] Stripeテストカード入力
  - [ ] 決済処理完了
  - [ ] subscription_status = 'active' 確認

- [ ] **セキュリティ基本確認（5分）**
  - [ ] 不正アクセス防止確認
  - [ ] CSRF保護確認
  - [ ] XSS対策確認

**各テスト記録フォーマット**:
```
テスト項目: _________________
実行者: ___________________
開始時刻: _____時_____分
終了時刻: _____時_____分
結果: ✅ PASS / ❌ FAIL
スクリーンショット: □ 取得済み
備考: ____________________
```

#### 🟡 Phase 3: 重要テスト（60分）

- [ ] **全CRUD操作確認（25分）**
  - [ ] 企業情報作成・読取・更新・削除
  - [ ] 記事作成・公開・編集・削除
  - [ ] ユーザー管理・権限変更

- [ ] **権限別アクセス制御（15分）**
  - [ ] Admin権限: 全機能アクセス可能
  - [ ] Editor権限: 編集機能のみ
  - [ ] Viewer権限: 閲覧のみ

- [ ] **メール通知パターン（15分）**
  - [ ] 新規登録通知
  - [ ] パスワードリセット
  - [ ] 企業公開通知
  - [ ] サブスクリプション変更

- [ ] **データ整合性確認（5分）**
  - [ ] データベース整合性
  - [ ] 関連データ一致確認

#### 📊 Phase 4: レポート生成・判定（20分）

- [ ] **自動レポート生成**
  ```bash
  npm run uat:report
  ```

- [ ] **レポート内容確認**
  - [ ] 実行情報正確性
  - [ ] テスト結果反映
  - [ ] リリース判定適切性
  - [ ] 次のアクション明確性

- [ ] **チーム判定会議**
  - [ ] 各フェーズ結果共有
  - [ ] 問題点・改善点議論
  - [ ] 最終判定合意
  - [ ] 本番実行Go/No-Go決定

---

## 🚨 想定される問題と対応

### 1️⃣ 環境変数関連

**問題**: `❌ NEXTAUTH_URL: 未設定`
```bash
# 確認コマンド
cat .env.local | grep NEXTAUTH_URL
vercel env list
```
**対応**: 
1. .env.localファイル確認
2. Vercel Dashboard > Settings > Environment Variables確認
3. 開発チームに設定依頼

### 2️⃣ DNS/SSL関連

**問題**: `❌ DNS解決失敗: aiohub.jp`
```bash
# 確認コマンド
nslookup aiohub.jp
dig aiohub.jp
curl -I https://aiohub.jp
```
**対応**:
1. ネットワーク接続確認
2. DNS設定確認
3. インフラチームエスカレーション

### 3️⃣ API疎通関連

**問題**: `❌ /api/stripe/webhook: 404 Not Found`
```bash
# 確認コマンド
curl -X POST https://aiohub.jp/api/stripe/webhook
vercel logs
```
**対応**:
1. デプロイ状況確認
2. ルーティング設定確認
3. バックエンド開発者に連絡

### 4️⃣ 決済テスト関連

**問題**: `Stripe: Your card was declined`
**対応**:
1. テストカード番号確認 (`4242 4242 4242 4242`)
2. Stripeダッシュボードでテストモード確認
3. 有効期限・CVCの正確性確認

### 5️⃣ メール送信関連

**問題**: メール未受信
**対応**:
1. スパムフォルダ確認
2. Resendダッシュボード確認
3. テストメールアドレス形式確認

---

## 📋 リハーサル記録テンプレート

### 基本情報
```
実施日: ____年____月____日
開始時刻: ____時____分
終了時刻: ____時____分
実施者: ________________
参加者: ________________
```

### Phase1: 自動化検証結果
```
□ GitHub Actions実行: PASS / FAIL
□ 環境変数チェック: PASS / FAIL
□ DNS/SSL検証: PASS / FAIL  
□ APIエンドポイント: PASS / FAIL
□ 自動レポート生成: PASS / FAIL

問題発生時:
対応内容: ________________
解決時間: ____分
エスカレーション: 有 / 無
```

### Phase2: クリティカルテスト結果
```
□ 基本認証フロー (10分): PASS / FAIL
□ 企業作成→公開 (15分): PASS / FAIL
□ 決済→サブスクリプション (10分): PASS / FAIL
□ セキュリティ基本確認 (5分): PASS / FAIL

スクリーンショット取得: □ 認証フロー □ 企業公開 □ 決済完了 □ セキュリティ

問題発生時:
テスト項目: ________________
症状: ____________________
対応時間: ____分
```

### Phase3: 重要テスト結果
```
□ 全CRUD操作 (25分): PASS / FAIL  
□ 権限別アクセス制御 (15分): PASS / FAIL
□ メール通知全パターン (15分): PASS / FAIL
□ データ整合性確認 (5分): PASS / FAIL

実行スキップ項目: ________________
スキップ理由: ____________________
```

### 総合判定
```
□ 全項目PASS - 本番実行準備完了
□ 一部FAIL - 修正後再リハーサル必要
□ 重大問題 - 本番実行延期検討

次回アクション:
1. ____________________________
2. ____________________________
3. ____________________________

本番実行判定: GO / NO-GO
判定理由: ________________________
```

---

## 🔗 関連ドキュメント

- [📋 UAT README](./README.md) - 全体概要
- [🚀 本番UAT実行ガイド](./uat_execution.md) - 本番環境での公式実行手順
- [🎯 QA担当者向けガイド](./qa-guide.md) - 詳細手順とトラブルシューティング
- [📊 レポートサンプル](./examples/) - 成功・失敗レポート例
- [🚀 実行ガイド](./runner.md) - コピペ実行マニュアル

---

> 🎭 **リハーサルの心得**: 「失敗を歓迎し、本番の成功を目指す」  
> リハーサルで発見された問題は、本番での致命的エラーを防ぐ貴重な発見です。遠慮なく問題を報告し、チーム全体で解決に取り組みましょう。