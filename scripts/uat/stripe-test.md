# 🔧 Stripe テスト実行ガイド

> **⚠️ 重要**: このテストはStripe **テストモード** でのみ実行してください。本番データに影響を与えません。

## 📋 事前準備

### 1. Stripeダッシュボード設定確認
```bash
# Stripe Dashboard確認手順:
# 1. https://dashboard.stripe.com/ にアクセス
# 2. 左上で "テストデータを表示" が選択されていることを確認
# 3. 開発者 > Webhook で aiohub.jp エンドポイントが設定済み確認
```

### 2. テストカード情報
```javascript
// 成功ケース
const TEST_CARDS_SUCCESS = {
  visa: "4242 4242 4242 4242",
  visaDebit: "4000 0566 5566 5556", 
  mastercard: "5555 5555 5555 4444",
  amex: "3782 822463 10005",
  // CVC: 任意の3桁（Amexは4桁）
  // 有効期限: 未来の任意の日付（例：12/34）
  // ZIP: 任意の郵便番号
};

// 失敗ケース
const TEST_CARDS_FAILURE = {
  declined: "4000 0000 0000 0002",           // 一般的な拒否
  insufficientFunds: "4000 0000 0000 9995",  // 残高不足
  lostCard: "4000 0000 0000 9987",           // 紛失カード
  stolenCard: "4000 0000 0000 9979",         // 盗難カード
  expiredCard: "4000 0000 0000 0069",        // 期限切れ
  incorrectCvc: "4000 0000 0000 0127",       // CVC不正
  processingError: "4000 0000 0000 0119",    // 処理エラー
  incorrectNumber: "4242 4242 4242 4241"     // カード番号不正
};
```

### 3. テスト用顧客データ
```javascript
const TEST_CUSTOMER_DATA = {
  email: "uat-test+stripe@luxucare.jp",
  name: "UAT テストユーザー",
  address: {
    line1: "1-1-1 テスト町",
    city: "東京都",
    postal_code: "100-0001",
    country: "JP"
  }
};
```

## 🧪 テストシナリオ実行

### 1. 成功フロー確認（15分）

#### a) 新規サブスクリプション作成
```bash
# 実行手順:
# 1. https://aiohub.jp/pricing にアクセス
# 2. 任意のプランで「今すぐ始める」クリック
# 3. テストカード 4242 4242 4242 4242 を使用
# 4. CVC: 123, 有効期限: 12/34, ZIP: 100-0001
# 5. 支払い完了まで進行

# 確認項目:
[ ] 決済画面が正常表示
[ ] カード情報入力エラーなし
[ ] 支払い処理が完了（成功メッセージ表示）
[ ] ユーザーダッシュボードにサブスクリプション反映
[ ] メール通知が送信される
```

#### b) Stripe Dashboard確認
```bash
# Stripe Dashboard > 支払い で確認:
[ ] 新しい支払い記録が作成されている
[ ] ステータスが "成功" になっている
[ ] 金額・通貨が正しい
[ ] 顧客情報が正確に記録されている
[ ] Webhook配信が成功している（Webhook履歴確認）
```

#### c) データベース確認
```sql
-- Supabase SQLエディタで実行
SELECT 
  u.email,
  u.subscription_status,
  u.stripe_customer_id,
  u.subscription_id,
  u.current_period_end
FROM users u
WHERE u.email = 'uat-test+stripe@luxucare.jp'
ORDER BY u.created_at DESC
LIMIT 1;

-- 期待結果: subscription_status = 'active'
```

### 2. 失敗フロー確認（10分）

#### a) カード拒否テスト
```bash
# 実行手順:
# 1. 新しいプラン申し込み画面にアクセス
# 2. 拒否テストカード 4000 0000 0000 0002 を使用
# 3. 支払い試行

# 確認項目:
[ ] エラーメッセージが適切に表示
[ ] ユーザーに再試行機会が提供される
[ ] 失敗した決済が記録されていない（DBに不正なレコードなし）
[ ] エラーログが適切に記録されている
```

#### b) 無効カード情報テスト
```bash
# テストケース:
# - 不完全なカード番号: 4242 4242 4242
# - 無効なCVC: 1
# - 期限切れ日付: 01/20
# - 無効なZIP: （空白）

# 確認項目:
[ ] フロントエンドバリデーションが機能
[ ] サーバーサイドバリデーションが機能
[ ] 適切なエラーメッセージ表示
[ ] 不正なデータがデータベースに保存されない
```

### 3. Webhook検証（10分）

#### a) Webhook配信確認
```bash
# Stripe Dashboard > 開発者 > Webhook で確認:
[ ] aiohub.jp エンドポイントが "成功" ステータス
[ ] 必要なイベントが配信されている:
  - customer.subscription.created
  - customer.subscription.updated  
  - invoice.payment_succeeded
  - invoice.payment_failed
[ ] 配信時間が適切（数秒以内）
[ ] エラー率が低い（95%以上成功）
```

#### b) Webhook署名検証
```bash
# アプリケーションログで確認:
[ ] Webhook署名検証が成功している
[ ] 不正なWebhookが拒否されている
[ ] 重複イベントが適切に処理されている
```

### 4. サブスクリプション管理（15分）

#### a) プラン変更テスト
```bash
# 実行手順:
# 1. ユーザーダッシュボードにログイン
# 2. 「プラン変更」機能を実行
# 3. 異なるプランを選択

# 確認項目:
[ ] プラン変更処理が完了
[ ] 請求金額が適切に調整（pro-ration）
[ ] データベースの subscription 情報が更新
[ ] 変更通知メールが送信
```

#### b) サブスクリプション解約テスト
```bash
# 実行手順:
# 1. 「サブスクリプション解約」機能を実行
# 2. 解約理由を選択して解約完了

# 確認項目:
[ ] 解約処理が完了
[ ] 即座に解約 or 期間末で解約が選択可能
[ ] データベースで subscription_status が更新
[ ] 解約確認メールが送信
[ ] Stripe側でもサブスクリプションが解約済み
```

### 5. 請求書・領収書確認（5分）

#### a) 請求書生成確認
```bash
# Stripe Dashboard > 請求で確認:
[ ] 請求書が正しく生成されている
[ ] 項目・金額が正確
[ ] 税金計算が正しい（該当する場合）
[ ] 顧客情報が正確に記載
```

#### b) 領収書ダウンロード
```bash
# ユーザーダッシュボードで確認:
[ ] 領収書ダウンロード機能が動作
[ ] PDF形式で正しく生成
[ ] 会社情報・支払い詳細が正確
[ ] ファイル名が適切（日付・金額等含む）
```

## 🔍 エラーケーステスト

### 1. ネットワークエラー対応
```bash
# ブラウザ開発者ツールで Network タブを開き:
# 1. "Offline" モードに設定
# 2. 決済処理を試行
# 3. 適切なエラーハンドリングが動作するか確認

# 確認項目:
[ ] オフライン時の適切なエラーメッセージ
[ ] リトライ機能の動作
[ ] データ整合性の保持
```

### 2. Webhook配信失敗対応
```bash
# Stripe Dashboard > Webhook設定で:
# 1. 一時的にエンドポイントURLを無効なものに変更
# 2. テスト決済を実行
# 3. Webhook配信失敗を確認
# 4. URLを正しいものに戻す
# 5. 手動再送機能をテスト

# 確認項目:
[ ] Webhook失敗時のログ記録
[ ] 手動再送機能の動作
[ ] データ整合性確保メカニズム
```

## 📊 テスト結果記録

### 成功基準
- [ ] ✅ 正常な決済フローが100%動作
- [ ] ✅ エラーハンドリングが適切
- [ ] ✅ Webhook配信成功率 > 95%
- [ ] ✅ データ整合性が保たれている
- [ ] ✅ メール通知が正常に送信
- [ ] ✅ 請求書・領収書生成が正常

### よくある問題と対処法

#### Webhook配信失敗
```bash
❌ 問題: Webhook endpoints returning 500 errors
✅ 対処: 
1. アプリケーションログでエラー内容確認
2. 環境変数 STRIPE_WEBHOOK_SECRET 確認
3. エンドポイントURL設定確認
4. セキュリティグループ・ファイアウォール確認
```

#### 決済処理エラー
```bash
❌ 問題: Payment processing fails unexpectedly
✅ 対処:
1. Stripe API キーが正しく設定されているか確認
2. テストモード/本番モード設定確認
3. 通貨・金額設定の妥当性確認
4. ブラウザコンソールでJavaScriptエラー確認
```

#### データ同期問題
```bash
❌ 問題: Database not syncing with Stripe
✅ 対処:
1. Webhook配信履歴確認
2. データベーストランザクション確認
3. 競合状態（race condition）の確認
4. 手動データ同期機能の実装検討
```

## 🚨 緊急時対応

### テスト中に本番データへの影響が疑われる場合
```bash
🔴 即座に実行:
1. Stripe Dashboard でテストモード確認
2. 本番API キーが使用されていないか確認
3. 疑わしい決済があれば即座に返金処理
4. 開発チーム・責任者への連絡
```

### データ整合性に問題が発見された場合
```bash
🟡 対応手順:
1. 影響範囲の特定
2. 一時的な新規決済停止検討
3. データ修復計画の策定
4. 修復完了後の再テスト実施
```

---

**📈 テスト完了後:**
1. 全テストケースの実行状況をチェックリストで確認
2. 問題が発見された場合は修正計画を策定
3. 成功した場合は次のテストフェーズ（Resend）に進行
4. テスト結果をUATレポートに記録