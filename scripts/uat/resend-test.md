# 📧 Resend メール配信テスト実行ガイド

> **⚠️ 重要**: このテストはResend **テストモード** または専用テストアドレスを使用して実行してください。

## 📋 事前準備

### 1. Resendダッシュボード設定確認
```bash
# Resend Dashboard確認手順:
# 1. https://resend.com/dashboard にアクセス
# 2. API Keys でテスト用キーが設定済み確認
# 3. Domains で aiohub.jp または noreply@aiohub.jp が認証済み確認
# 4. Analytics で配信状況確認可能であることを確認
```

### 2. テスト用メールアドレス
```javascript
// テスト用受信アドレス（実際に受信可能なもの）
const TEST_EMAIL_ADDRESSES = {
  primary: "uat-test+resend@luxucare.jp",      // メインテスト用
  secondary: "uat-test+secondary@luxucare.jp", // セカンダリテスト用
  invalid: "invalid-email-format",             // バリデーションテスト用
  bounced: "bounce@example.com",               // バウンステスト用（Resend提供）
  spammed: "spam@example.com"                  // スパムテスト用（Resend提供）
};

// 送信者情報
const SENDER_INFO = {
  from: "noreply@aiohub.jp",
  replyTo: "support@aiohub.jp",
  name: "AIO Hub"
};
```

### 3. メールテンプレート確認
```bash
# アプリケーション内のメールテンプレート確認:
# 1. ウェルカムメール: /emails/welcome.tsx
# 2. 決済完了通知: /emails/payment-success.tsx  
# 3. 決済失敗通知: /emails/payment-failed.tsx
# 4. パスワードリセット: /emails/password-reset.tsx
# 5. サブスクリプション更新: /emails/subscription-update.tsx
```

## 🧪 テストシナリオ実行

### 1. ウェルカムメール配信テスト（10分）

#### a) 新規ユーザー登録でのメール送信
```bash
# 実行手順:
# 1. https://aiohub.jp/auth/register にアクセス
# 2. テストメールアドレスで新規登録
# 3. 登録完了後、ウェルカムメール送信を確認

# 確認項目:
[ ] メール送信処理が正常完了（エラーなし）
[ ] 30秒以内にメール受信
[ ] 件名が正確: "AIO Hubへようこそ"
[ ] 送信者が正確: "AIO Hub <noreply@aiohub.jp>"
[ ] HTMLメールが正しく表示（レイアウト崩れなし）
[ ] テキスト版メールも正常
[ ] リンクが正しく動作（ダッシュボードリンク等）
[ ] 個人化（ユーザー名表示）が正常
```

#### b) Resend Dashboard確認
```bash
# Resend Dashboard > Analytics で確認:
[ ] 送信ログが記録されている
[ ] 配信ステータスが "delivered"
[ ] バウンス・苦情がない
[ ] 配信時間が適切（数秒以内）
```

### 2. 決済関連メール配信テスト（15分）

#### a) 決済成功通知
```bash
# 実行手順:
# 1. テストカード 4242 4242 4242 4242 で決済実行
# 2. 決済完了後のメール配信確認

# 確認項目:
[ ] 決済成功後30秒以内にメール送信
[ ] 件名: "サブスクリプション開始のお知らせ"
[ ] プラン名・金額が正確に表示
[ ] 次回請求日が正確
[ ] 請求書PDFリンクが動作（該当する場合）
[ ] サポート連絡先が記載
```

#### b) 決済失敗通知
```bash
# 実行手順:
# 1. 失敗テストカード 4000 0000 0000 0002 で決済試行
# 2. 決済失敗後のメール配信確認

# 確認項目:
[ ] 決済失敗後30秒以内にメール送信
[ ] 件名: "決済処理に失敗しました【重要】"
[ ] 緊急度が分かるデザイン・文言
[ ] 失敗理由の説明
[ ] 再試行リンクが動作
[ ] サポート連絡先が明記
```

### 3. システム通知メール（10分）

#### a) パスワードリセット
```bash
# 実行手順:
# 1. ログイン画面で「パスワードを忘れた」クリック
# 2. テストメールアドレス入力
# 3. リセットメール配信確認

# 確認項目:
[ ] リセット要求後即座にメール送信
[ ] 件名: "パスワードリセットのご案内"
[ ] セキュリティ注意事項が記載
[ ] リセットリンクが動作
[ ] リンク有効期限が明記（通常24時間）
[ ] 不正要求時の対処法が記載
```

#### b) サブスクリプション変更通知
```bash
# 実行手順:
# 1. ダッシュボードでプラン変更実行
# 2. 変更完了後のメール配信確認

# 確認項目:
[ ] プラン変更後即座にメール送信
[ ] 変更前後のプラン情報が正確
[ ] 料金変更・日割り計算が正確
[ ] 次回請求日が更新されている
```

### 4. 大量配信テスト（10分）

#### a) 複数アドレスへの同時配信
```bash
# テスト用スクリプト実行:
node scripts/uat/test-bulk-email.mjs

# 確認項目:
[ ] 10件の同時配信が成功
[ ] レート制限に引っかからない
[ ] 全メールが10分以内に配信
[ ] 個別化が正しく動作（宛名等）
[ ] 配信失敗がない
```

#### b) 配信制限確認
```bash
# Resend Dashboard > Settings で確認:
[ ] 日次送信制限を確認
[ ] 時間あたり送信制限を確認
[ ] 現在の使用量が制限内
[ ] アラート設定が適切
```

### 5. エラーハンドリングテスト（10分）

#### a) 無効メールアドレス処理
```bash
# 実行手順:
# 1. 不正なメールアドレスでの送信試行
# 2. エラーハンドリング確認

# テストケース:
# - 形式不正: "invalid-email"
# - ドメイン不正: "test@invalid-domain"
# - 特殊文字: "test@#$%.com"

# 確認項目:
[ ] バリデーションエラーが適切に処理
[ ] エラーログが記録されている
[ ] ユーザーに適切なエラーメッセージ
[ ] 送信試行がログに残らない
```

#### b) 配信失敗時の処理
```bash
# 実行手順:
# 1. Resend API キーを一時的に無効化
# 2. メール送信試行
# 3. エラーハンドリング確認
# 4. API キーを元に戻す

# 確認項目:
[ ] API エラーが適切にキャッチされる
[ ] リトライ機能が動作（該当する場合）
[ ] エラーログが詳細に記録
[ ] ユーザー体験が破綻しない
```

### 6. メール内容・デザイン確認（10分）

#### a) レスポンシブデザイン確認
```bash
# 確認環境:
# - Gmail (Web, Mobile App)
# - Outlook (Web, Desktop)
# - Apple Mail (Mac, iPhone)
# - Yahoo Mail

# 確認項目:
[ ] モバイルで正しく表示
[ ] デスクトップで正しく表示
[ ] 画像が適切に表示
[ ] リンクが正しく動作
[ ] フォントが読みやすい
[ ] ブランドカラー・ロゴが正確
```

#### b) アクセシビリティ確認
```bash
# 確認項目:
[ ] alt属性が画像に設定済み
[ ] 十分なコントラスト比
[ ] テキスト版メールが意味を保持
[ ] スクリーンリーダー対応
[ ] リンクテキストが説明的
```

## 📊 Resend Analytics確認

### 1. 配信統計確認
```bash
# Resend Dashboard > Analytics で確認:
[ ] 配信成功率 > 98%
[ ] バウンス率 < 2%
[ ] 苦情率 < 0.1%
[ ] 開封率統計（利用可能な場合）
[ ] クリック率統計（利用可能な場合）
```

### 2. ドメイン評価確認
```bash
# Resend Dashboard > Domains で確認:
[ ] ドメイン認証ステータス: ✅ Verified
[ ] DNS設定: SPF, DKIM, DMARC すべて設定済み
[ ] 送信評価スコア > 80点
[ ] ブラックリスト登録なし
```

## 🚨 エラーケーステスト

### 1. ネットワーク障害対応
```bash
# ブラウザ開発者ツールで Network タブを開き:
# 1. "Offline" モードに設定
# 2. メール送信を試行
# 3. 復旧後の処理確認

# 確認項目:
[ ] オフライン時の適切なエラー処理
[ ] 復旧後の自動送信（キュー機能がある場合）
[ ] ユーザーへの適切なフィードバック
```

### 2. API制限到達時の対応
```bash
# テスト手順:
# 1. 短時間で大量のメール送信を試行
# 2. レート制限に到達
# 3. 制限時の処理確認

# 確認項目:
[ ] レート制限エラーの適切な処理
[ ] 待機・リトライ機能の動作
[ ] ユーザーへの分かりやすい説明
[ ] 管理者への通知（該当する場合）
```

## 📋 チェックリスト

### 成功基準
- [ ] ✅ 全メールタイプが正常配信
- [ ] ✅ 配信成功率 > 98%
- [ ] ✅ バウンス率 < 2%
- [ ] ✅ 苦情率 < 0.1%
- [ ] ✅ デザインが全環境で正常表示
- [ ] ✅ エラーハンドリングが適切
- [ ] ✅ セキュリティ設定が適切

### よくある問題と対処法

#### 配信遅延
```bash
❌ 問題: メール配信が大幅に遅延
✅ 対処:
1. Resend API制限状況確認
2. ネットワーク接続状況確認
3. 送信コードの最適化
4. バッチ処理の実装検討
```

#### デザイン崩れ
```bash
❌ 問題: 特定メールクライアントでレイアウト崩れ
✅ 対処:
1. メールテンプレートのCSS見直し
2. インラインスタイルの使用
3. テーブルレイアウトの採用
4. メールクライアント別テスト強化
```

#### 配信失敗率上昇
```bash
❌ 問題: バウンス率・苦情率が上昇
✅ 対処:
1. メールリストの清掃
2. 配信頻度の調整
3. コンテンツ品質の向上
4. オプトアウト機能の改善
```

#### ドメイン評価低下
```bash
❌ 問題: 送信評価スコアが低下
✅ 対処:
1. DNS設定再確認（SPF, DKIM, DMARC）
2. 配信量の段階的増加
3. エンゲージメント向上策実施
4. 送信者評価回復プログラム実行
```

## 🔧 トラブルシューティングコマンド

### DNS設定確認
```bash
# SPF確認
dig TXT aiohub.jp | grep "v=spf1"

# DKIM確認  
dig TXT default._domainkey.aiohub.jp

# DMARC確認
dig TXT _dmarc.aiohub.jp
```

### API接続テスト
```bash
# Resend API接続確認
curl -X POST 'https://api.resend.com/emails' \
  -H 'Authorization: Bearer YOUR_API_KEY' \
  -H 'Content-Type: application/json' \
  -d '{
    "from": "noreply@aiohub.jp",
    "to": ["test@example.com"],
    "subject": "API Test",
    "text": "Test message"
  }'
```

## 🚨 緊急時対応

### 大量配信失敗時
```bash
🔴 即座に実行:
1. 配信停止（該当する機能があれば）
2. 失敗原因の特定
3. ユーザーへの状況説明
4. 代替配信手段の検討
```

### ドメイン評価急落時
```bash
🟡 対応手順:
1. 送信量の一時削減
2. 高エンゲージメントユーザーのみに絞った配信
3. DNS設定の再確認
4. Resendサポートへの連絡
```

---

**📈 テスト完了後:**
1. 全テストケースの実行状況をチェックリストで確認
2. 問題が発見された場合は修正計画を策定
3. 成功した場合はUATの次フェーズに進行
4. テスト結果をUATレポートに記録
5. 継続的なモニタリング体制の確認