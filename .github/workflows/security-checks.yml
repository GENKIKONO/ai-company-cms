name: Security Validation

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# PRã‚„mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§å®Ÿè¡Œã•ã‚Œã‚‹

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build step (for testing)'
        required: false
        default: 'false'
        type: boolean

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®æ¨©é™ã‚’åˆ¶é™
permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '24'
  NEXT_TELEMETRY_DISABLED: 1

jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ã®ãŸã‚å…¨å±¥æ­´ã‚’å–å¾—
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        env:
          HUSKY: 0
        run: |
          npm ci --omit=dev --ignore-scripts
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»å°‚ç”¨ã®ä¾å­˜é–¢ä¿‚
          npm install --no-save --ignore-scripts audit-ci eslint-plugin-security

      - name: Run npm audit
        run: |
          echo "ğŸ” Running npm security audit..."
          npm audit --audit-level=high --production
          
          # è©³ç´°ãªç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ (CIç”¨)
          npx audit-ci --config audit-ci.json || echo "âš ï¸ Some vulnerabilities found"

      - name: Check for sensitive data
        run: |
          echo "ğŸ” Checking for sensitive data in code..."

          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸèªè¨¼æƒ…å ±ã®æ¤œç´¢ (å®Ÿéš›ã®å€¤ãŒå…¥ã£ã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã¿)
          # ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆå†…ã®20æ–‡å­—ä»¥ä¸Šã®å€¤ã‚’æ¤œå‡º
          secrets=$(grep -rE '(api_key|secret_key|api_secret)\s*[:=]\s*"[a-zA-Z0-9_-]{20,}"' src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v 'process\.env\|example\|placeholder\|test_\|dummy' | head -3 || true)
          if [ -n "$secrets" ]; then
            echo "$secrets"
            echo "âŒ Hardcoded API keys/secrets found"
            exit 1
          fi

          # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®å€¤ãŒä»£å…¥ã•ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
          passwords=$(grep -rE 'password\s*=\s*"[^"]{8,}"' src/ --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v 'process\.env\|example\|placeholder\|test' | head -3 || true)
          if [ -n "$passwords" ]; then
            echo "$passwords"
            echo "âŒ Hardcoded passwords found"
            exit 1
          fi

          echo "âœ… No sensitive data found in code"

      - name: Validate environment configuration
        run: |
          echo "ğŸ” Validating environment configuration..."
          
          # .env.example ã®å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
          required_vars=(
            "CSRF_SECRET"
            "API_SIGNATURE_SECRET"  
            "ADMIN_API_SECRET_KEY"
            "STRIPE_WEBHOOK_SECRET"
            "RESEND_WEBHOOK_SECRET"
          )
          
          missing_vars=()
          for var in "${required_vars[@]}"; do
            if ! grep -q "^${var}=" .env.example; then
              missing_vars+=("$var")
            fi
          done
          
          if [ ${#missing_vars[@]} -ne 0 ]; then
            echo "âŒ Missing required environment variables in .env.example:"
            printf '%s\n' "${missing_vars[@]}"
            exit 1
          fi
          
          echo "âœ… Environment configuration valid"

      - name: Security-focused ESLint
        env:
          ESLINT_USE_FLAT_CONFIG: "false"
        run: |
          echo "ğŸ” Running security-focused ESLint..."

          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç‰¹åŒ–ã®ESLintè¨­å®šã‚’ä½œæˆ
          cat > .eslintrc.security.json << EOF
          {
            "extends": [".eslintrc.json"],
            "plugins": ["security"],
            "rules": {
              "security/detect-object-injection": "error",
              "security/detect-non-literal-regexp": "error",
              "security/detect-unsafe-regex": "error",
              "security/detect-buffer-noassert": "error",
              "security/detect-eval-with-expression": "error",
              "security/detect-no-csrf-before-method-override": "error",
              "security/detect-possible-timing-attacks": "warn",
              "security/detect-pseudoRandomBytes": "error"
            }
          }
          EOF
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
          npx eslint --config .eslintrc.security.json src/ --ext .ts,.tsx,.js,.jsx --max-warnings 0

  dependency-check:
    name: Dependency Security Check  
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Snyk security scan
        # Snyk ã‚’ä½¿ç”¨ã—ãŸä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
        continue-on-error: true
        run: |
          if command -v snyk &> /dev/null; then
            echo "ğŸ” Running Snyk security scan..."
            snyk test --severity-threshold=high
          else
            echo "âš ï¸ Snyk not available, skipping advanced dependency check"
          fi

      - name: Check for known vulnerabilities
        run: |
          echo "ğŸ” Checking for known vulnerabilities..."
          
          # package.json ã®å±é™ºãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
          dangerous_packages=(
            "debug"
            "request"  
            "node-uuid"
            "crypto-js"
          )
          
          for package in "${dangerous_packages[@]}"; do
            if grep -q "\"$package\"" package.json; then
              echo "âš ï¸ Found potentially vulnerable package: $package"
            fi
          done
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®è¨­å®šç¢ºèª
          echo "âœ… Dependency security check completed"

  build-security-validation:
    name: Build & Security Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.skip_build != 'true' }}
    
    strategy:
      matrix:
        security-env: ['development', 'production']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup test environment (${{ matrix.security-env }})
        run: |
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆç”¨ã®ç’°å¢ƒå¤‰æ•°è¨­å®š
          cat > .env.local << EOF
          # Test environment for security validation
          NEXT_PUBLIC_SUPABASE_URL=https://test.supabase.co
          NEXT_PUBLIC_SUPABASE_ANON_KEY=test_anon_key_32_chars_minimum_length
          SUPABASE_SERVICE_ROLE_KEY=test_service_role_key_64_chars_minimum_length_for_security
          
          # Security settings
          CSRF_SECRET=test_csrf_secret_32_chars_minimum
          API_SIGNATURE_SECRET=test_api_signature_secret_32_chars
          ADMIN_API_SECRET_KEY=test_admin_api_secret_key_64_chars_minimum_for_security_validation
          ADMIN_ALLOWED_IPS=127.0.0.1,::1
          
          # Webhook secrets
          STRIPE_WEBHOOK_SECRET=test_stripe_webhook_secret_32_chars
          RESEND_WEBHOOK_SECRET=test_resend_webhook_secret_32_chars
          
          # Force HTTPS in production
          FORCE_HTTPS=${{ matrix.security-env == 'production' && 'true' || 'false' }}
          NODE_ENV=${{ matrix.security-env }}
          EOF

      - name: Build application
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ—ï¸ Building application with security validation..."
          npm run build
          
          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          echo "ğŸ” Checking build artifacts..."
          
          # .next/standalone ã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if find .next -name "*.js" -exec grep -l "secret\|password\|key" {} \; | grep -v node_modules | head -5; then
            echo "âš ï¸ Potential secrets found in build artifacts"
          fi

      - name: Security headers validation
        run: |
          echo "ğŸ” Validating security headers configuration..."
          
          # middleware.ts ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          required_headers=(
            "Content-Security-Policy"
            "X-Frame-Options"  
            "X-Content-Type-Options"
            "Referrer-Policy"
            "Permissions-Policy"
          )
          
          missing_headers=()
          for header in "${required_headers[@]}"; do
            if ! grep -q "$header" src/middleware.ts 2>/dev/null; then
              missing_headers+=("$header")
            fi
          done
          
          if [ ${#missing_headers[@]} -ne 0 ]; then
            echo "âš ï¸ Missing security headers:"
            printf '%s\n' "${missing_headers[@]}"
          else
            echo "âœ… Security headers configuration valid"
          fi

      - name: Database security validation
        run: |
          echo "ğŸ” Validating database security configuration..."
          
          # RLSè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if [ -f "supabase/migrations/20251112_security_hardening.sql" ]; then
            echo "âœ… Security hardening migration found"
            
            # RLS ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if grep -q "ENABLE ROW LEVEL SECURITY" supabase/migrations/20251112_security_hardening.sql; then
              echo "âœ… Row Level Security enabled"
            else
              echo "âŒ Row Level Security not found in migration"
              exit 1
            fi
            
            # ç›£æŸ»ãƒ­ã‚°æ©Ÿèƒ½ã®ãƒã‚§ãƒƒã‚¯
            if grep -q "audit_logs" supabase/migrations/20251112_security_hardening.sql; then
              echo "âœ… Audit logging configured"
            else
              echo "âŒ Audit logging not found"
              exit 1
            fi
          else
            echo "âŒ Security hardening migration not found"
            exit 1
          fi

  security-test:
    name: Security Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Test security functions
        run: |
          echo "ğŸ§ª Testing security functions..."
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
          if [ -f "tests/security.test.js" ]; then
            npm test -- tests/security.test.js
          else
            echo "âš ï¸ Security tests not found, creating basic validation..."
            
            # åŸºæœ¬çš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ
            node -e "
              const crypto = require('crypto');
              
              // HMACæ¤œè¨¼ãƒ†ã‚¹ãƒˆ
              const secret = 'test-secret-key-32-chars-minimum';
              const payload = 'test-payload';
              const signature = crypto.createHmac('sha256', secret).update(payload).digest('hex');
              const isValid = crypto.timingSafeEqual(
                Buffer.from(signature, 'hex'),
                Buffer.from(signature, 'hex')
              );
              
              if (!isValid) {
                console.error('âŒ HMAC validation failed');
                process.exit(1);
              }
              
              console.log('âœ… HMAC validation working');
              
              // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ†ã‚¹ãƒˆ
              const csrfToken = crypto.randomBytes(32).toString('hex');
              if (csrfToken.length !== 64) {
                console.error('âŒ CSRF token generation failed');
                process.exit(1);
              }
              
              console.log('âœ… CSRF token generation working');
            "
          fi

      - name: API security validation
        run: |
          echo "ğŸ§ª Testing API security implementation..."
          
          # admin-protection.ts ã®å­˜åœ¨ã¨è¨­å®šãƒã‚§ãƒƒã‚¯
          if [ -f "src/lib/security/admin-protection.ts" ]; then
            echo "âœ… Admin protection module found"
            
            # withAdminProtectioné–¢æ•°ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
            if grep -q "withAdminProtection" src/lib/security/admin-protection.ts; then
              echo "âœ… Admin protection wrapper found"
            else
              echo "âŒ Admin protection wrapper not found"
              exit 1
            fi
          else
            echo "âŒ Admin protection module not found"
            exit 1
          fi

  security-report:
    name: Security Report
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, build-security-validation, security-test]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Validation Report" > security-report.md
          echo "" >> security-report.md
          echo "## Summary" >> security-report.md
          echo "" >> security-report.md
          
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ã¾ã¨ã‚ã‚‹
          echo "| Check | Status |" >> security-report.md
          echo "|-------|--------|" >> security-report.md
          echo "| Security Audit | ${{ needs.security-audit.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> security-report.md
          echo "| Dependency Check | ${{ needs.dependency-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> security-report.md
          echo "| Build Validation | ${{ needs.build-security-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> security-report.md
          echo "| Security Tests | ${{ needs.security-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> security-report.md
          echo "" >> security-report.md
          echo "## Recommendations" >> security-report.md
          echo "" >> security-report.md
          echo "- ğŸ”’ Ensure all environment variables are properly configured" >> security-report.md
          echo "- ğŸ›¡ï¸ Review admin API protection settings" >> security-report.md
          echo "- ğŸ“Š Monitor security audit logs regularly" >> security-report.md
          echo "- ğŸ”„ Update dependencies regularly" >> security-report.md
          echo "" >> security-report.md
          echo "Generated at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-report.md
          
          cat security-report.md

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md
          retention-days: 30

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å¤±æ•—æ™‚ã®é€šçŸ¥
  notify-security-failure:
    name: Security Failure Notification
    runs-on: ubuntu-latest
    needs: [security-audit, dependency-check, build-security-validation, security-test]
    if: ${{ failure() && github.ref == 'refs/heads/main' }}
    
    steps:
      - name: Notify security team
        run: |
          echo "ğŸš¨ Security validation failed on main branch!"
          echo "Please review the failed checks immediately."
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # å®Ÿéš›ã®æœ¬ç•ªç’°å¢ƒã§ã¯ã€Slack/Teams/Emailé€šçŸ¥ã‚’è¨­å®š
          # ä¾‹: curl -X POST -H 'Content-type: application/json' --data '{"text":"Security check failed!"}' $SLACK_WEBHOOK_URL