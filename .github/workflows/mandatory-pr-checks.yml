name: ğŸ›¡ï¸ Mandatory PR Checks

# PR â†’ main ãƒãƒ¼ã‚¸å‰ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
# lint / typecheck / build / test:e2e ã‚’å¿…ãšé€šã™
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '20'
  # ãƒ†ã‚¹ãƒˆç’°å¢ƒå¤‰æ•°
  TEST_USER_EMAIL: 'test@aiohub.dev'
  TEST_USER_PASSWORD: 'TestPass123!'
  PLAYWRIGHT_BASE_URL: 'http://localhost:3000'

# åŒæ™‚å®Ÿè¡Œåˆ¶é™ï¼ˆåŒã˜PRã§ã®é‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢ï¼‰
concurrency:
  group: pr-checks-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ğŸ“‹ å‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯
  pre-flight:
    name: ğŸ“‹ Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      should-run-tests: ${{ steps.check-changes.outputs.should-run-tests }}
      should-run-e2e: ${{ steps.check-changes.outputs.should-run-e2e }}
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ” Check changed files
        id: check-changes
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "Changed files:" 
          echo "$CHANGED_FILES"
          
          # TypeScript/JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹
          if echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' > /dev/null; then
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
          fi
          
          # é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹ã‹ï¼ˆE2Eãƒ†ã‚¹ãƒˆå¿…è¦ï¼‰
          if echo "$CHANGED_FILES" | grep -E '(pages?|components?|api|auth|billing|admin)' > /dev/null; then
            echo "should-run-e2e=true" >> $GITHUB_OUTPUT
          else
            echo "should-run-e2e=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸš« Check for forbidden patterns
        run: |
          npm run validate:forbidden || {
            echo "âŒ ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "ğŸ’¡ org_id ã®ä½¿ç”¨ã‚„ç¦æ­¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }

      - name: ğŸ“‹ Validate schema consistency
        run: |
          npm run validate:schema || {
            echo "âŒ ã‚¹ã‚­ãƒ¼ãƒã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸ" 
            exit 1
          }

  # ğŸ§¹ ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
  code-quality:
    name: ğŸ§¹ Code Quality (MANDATORY)
    runs-on: ubuntu-latest
    needs: pre-flight
    if: needs.pre-flight.outputs.should-run-tests == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ”¤ TypeScript check (MANDATORY)
        run: |
          npm run typecheck || {
            echo "âŒ TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
            echo "ğŸ’¡ å‹ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
            exit 1
          }

      - name: ğŸ§¹ ESLint check (MANDATORY)
        run: |
          npm run lint -- --max-warnings 0 || {
            echo "âŒ ESLint ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯è­¦å‘ŠãŒã‚ã‚Šã¾ã™"
            echo "ğŸ’¡ ã‚³ãƒ¼ãƒ‰ã®å“è³ªå•é¡Œã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
            exit 1
          }

      - name: ğŸ¨ Prettier format check
        run: |
          npm run format:check || {
            echo "âŒ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™"
            echo "ğŸ’¡ npm run format ã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’æ•´å½¢ã—ã¦ãã ã•ã„"
            exit 1
          }

  # ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆï¼‰
  build-verification:
    name: ğŸ—ï¸ Build Verification (MANDATORY)
    runs-on: ubuntu-latest
    needs: [pre-flight, code-quality]
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ—ï¸ Production build test (MANDATORY)
        run: |
          # Build and capture warnings
          BUILD_OUTPUT=$(npm run build 2>&1) || {
            echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ’¡ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
            exit 1
          }

          # Check for warnings (zero-warning policy)
          WARNING_COUNT=$(echo "$BUILD_OUTPUT" | grep -c "Warning:" || echo "0")
          if [ "$WARNING_COUNT" -gt 0 ]; then
            echo "âŒ ãƒ“ãƒ«ãƒ‰è­¦å‘ŠãŒ $WARNING_COUNT ä»¶ã‚ã‚Šã¾ã™"
            echo "$BUILD_OUTPUT" | grep "Warning:"
            echo "ğŸ’¡ è­¦å‘Šã‚’è§£æ¶ˆã—ã¦ã‹ã‚‰PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
            exit 1
          fi
          echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼ˆè­¦å‘Š0ä»¶ï¼‰"
        env:
          # å¿…é ˆç’°å¢ƒå¤‰æ•°ï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å€¤ï¼‰
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://aiohub.jp' }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_placeholder' }}

      - name: ğŸ“ Bundle size analysis
        run: |
          BUILD_SIZE=$(du -sh .next/ | cut -f1)
          echo "ğŸ“¦ Build size: $BUILD_SIZE"
          
          # å¤§ãã™ãã‚‹ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®è­¦å‘Š
          if [ "$(du -s .next/ | cut -f1)" -gt 200000 ]; then
            echo "âš ï¸ Warning: Build size is large (>200MB). Consider optimization."
          fi

  # ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆ
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [pre-flight, code-quality]
    if: needs.pre-flight.outputs.should-run-tests == 'true'
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: |
          npm run test:unit || {
            echo "âš ï¸ å˜ä½“ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ’¡ ãƒ†ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆãƒãƒ¼ã‚¸ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã›ã‚“ï¼‰"
          }

  # ğŸ­ E2Eãƒ†ã‚¹ãƒˆï¼ˆå¿…é ˆã€é‡è¦ãªå¤‰æ›´ã®ã¿ï¼‰
  e2e-tests:
    name: ğŸ­ E2E Tests (MANDATORY)
    runs-on: ubuntu-latest
    needs: [pre-flight, build-verification]
    if: needs.pre-flight.outputs.should-run-e2e == 'true'
    timeout-minutes: 15
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps chromium

      - name: ğŸš€ Start application
        run: |
          npm run build
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸ­ Run critical E2E tests (MANDATORY)
        run: |
          # é‡è¦ãªE2Eãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
          npx playwright test auth-flow.spec.ts || FAILED_TESTS="$FAILED_TESTS auth-flow"
          npx playwright test posts-management.spec.ts || FAILED_TESTS="$FAILED_TESTS posts-management" 
          npx playwright test admin-console.spec.ts || FAILED_TESTS="$FAILED_TESTS admin-console"
          npx playwright test segment-billing.spec.ts || FAILED_TESTS="$FAILED_TESTS segment-billing"
          
          if [ -n "$FAILED_TESTS" ]; then
            echo "âŒ E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ: $FAILED_TESTS"
            echo "ğŸ’¡ é‡è¦æ©Ÿèƒ½ãŒå£Šã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„"
            exit 1
          fi
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          TEST_USER_EMAIL: ${{ env.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ env.TEST_USER_PASSWORD }}

      - name: ğŸ“ Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 3

  # ğŸŒ¬ï¸ APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆï¼ˆé‡è¦é ˜åŸŸï¼‰
  api-smoke-tests:
    name: ğŸŒ¬ï¸ Critical API Smoke Tests
    runs-on: ubuntu-latest
    needs: [pre-flight, build-verification]
    timeout-minutes: 5
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸš€ Start application for API tests
        run: |
          npm run build
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: ğŸŒ¬ï¸ Run critical API smoke tests
        run: |
          node scripts/api-smoke-test-critical.js || {
            echo "âŒ é‡è¦API ã®ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ"
            echo "ğŸ’¡ AIã‚¢ãƒŠãƒªãƒ†ã‚£ã‚¯ã‚¹ã€åŸ‹ã‚è¾¼ã¿Widgetã€Enforcement APIã‚’ç¢ºèªã—ã¦ãã ã•ã„"
            exit 1
          }

  # âœ… æœ€çµ‚ãƒã‚§ãƒƒã‚¯
  mandatory-checks-summary:
    name: âœ… Mandatory Checks Summary
    runs-on: ubuntu-latest
    needs: [pre-flight, code-quality, build-verification, e2e-tests, api-smoke-tests]
    if: always()
    steps:
      - name: ğŸ“‹ Check all mandatory results
        run: |
          echo "ğŸ“Š Mandatory PR Checks Results:"
          echo "================================"
          
          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ãƒã‚§ãƒƒã‚¯
          CODE_QUALITY="${{ needs.code-quality.result }}"
          BUILD_VERIFICATION="${{ needs.build-verification.result }}"
          E2E_TESTS="${{ needs.e2e-tests.result }}"
          API_SMOKE="${{ needs.api-smoke-tests.result }}"
          
          echo "ğŸ§¹ Code Quality: $CODE_QUALITY"
          echo "ğŸ—ï¸ Build Verification: $BUILD_VERIFICATION"
          echo "ğŸ­ E2E Tests: $E2E_TESTS"
          echo "ğŸŒ¬ï¸ API Smoke Tests: $API_SMOKE"
          
          # ã„ãšã‚Œã‹ãŒå¤±æ•—ã—ã¦ã„ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [[ "$CODE_QUALITY" == "failure" || "$BUILD_VERIFICATION" == "failure" || "$E2E_TESTS" == "failure" || "$API_SMOKE" == "failure" ]]; then
            echo ""
            echo "âŒ å¿…é ˆãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¦ã„ã¾ã™"
            echo "ğŸ’¡ ã“ã®PRã¯ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“"
            echo "ğŸ’¡ ã™ã¹ã¦ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒé€šã‚‹ã¾ã§ä¿®æ­£ã‚’ç¶šã‘ã¦ãã ã•ã„"
            exit 1
          else
            echo ""
            echo "ğŸ‰ ã™ã¹ã¦ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
            echo "âœ… ã“ã®PRã¯ main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸å¯èƒ½ã§ã™"
          fi

  # ğŸš¨ å¤±æ•—é€šçŸ¥
  failure-notification:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [mandatory-checks-summary]
    if: failure()
    steps:
      - name: ğŸ’¬ Comment failure details
        uses: actions/github-script@v7
        continue-on-error: true  # 403 Resource not accessible by integration å›é¿ï¼ˆé€šçŸ¥ã¯éå¿…é ˆï¼‰
        with:
          script: |
            const comment = `## âŒ å¿…é ˆãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ã¾ã—ãŸ
            
            ã“ã®PRã¯ä»¥ä¸‹ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ã‚’é€šéã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
            
            - âœ… **TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«** (npm run typecheck)
            - âœ… **ESLint ãƒã‚§ãƒƒã‚¯** (npm run lint) 
            - âœ… **ãƒ“ãƒ«ãƒ‰æ¤œè¨¼** (npm run build)
            - âœ… **é‡è¦E2Eãƒ†ã‚¹ãƒˆ** (èªè¨¼ãƒ»æŠ•ç¨¿ãƒ»ç®¡ç†ãƒ»æ±ºæ¸ˆ)
            - âœ… **é‡è¦APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ** (AIãƒ»åŸ‹ã‚è¾¼ã¿ãƒ»ç›£æŸ»)
            
            ### ğŸ“‹ ä¿®æ­£æ‰‹é †
            1. \`npm run lint\` ã§ESLintã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªãƒ»ä¿®æ­£
            2. \`npm run typecheck\` ã§TypeScriptã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªãƒ»ä¿®æ­£  
            3. \`npm run build\` ã§ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªãƒ»ä¿®æ­£
            4. \`npm run test:e2e\` ã§E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œãƒ»ä¿®æ­£
            5. ä¿®æ­£å¾Œã«PRã‚’æ›´æ–°ã™ã‚‹ã¨å†åº¦ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
            
            ---
            *ğŸ¤– AIOHub Mandatory CI/CD Pipeline*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });