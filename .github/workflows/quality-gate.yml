name: üö¶ Quality Gate

# „Ç∑„É≥„Éó„É´„Å™ÂìÅË≥™„Ç≤„Éº„ÉàÔºà„Åô„Åπ„Å¶„ÅÆPR„ÅßÂÆüË°åÔºâ
on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

env:
  NODE_VERSION: '20'

concurrency:
  group: quality-gate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality-gate:
    name: üö¶ Quality Gate
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì≤ Install dependencies
        run: npm ci

      - name: üé® Tailwind direct write check
        run: npm run check:tailwind

      - name: üî§ TypeScript (strict)
        run: npm run typecheck

      - name: üßπ ESLint (no warnings)
        run: npm run lint -- --max-warnings 0

      - name: üîê API Auth Pattern Check
        run: |
          OUTPUT=$(npm run check:api-auth 2>&1)
          ERROR_COUNT=$(echo "$OUTPUT" | grep -oP '\d+(?= error\(s\))' | head -1 || echo "0")
          if [ "$ERROR_COUNT" != "0" ] && [ -n "$ERROR_COUNT" ]; then
            echo "‚ùå API Auth violations: $ERROR_COUNT error(s)"
            echo "$OUTPUT" | tail -30
            exit 1
          fi
          echo "‚úÖ API Auth check passed"

      - name: üåê Origin Safety Check
        run: npm run check:origin-safety

      - name: üèóÔ∏è Build (no warnings)
        run: |
          BUILD_OUTPUT=$(npm run build 2>&1) || exit 1
          WARNING_COUNT=$(echo "$BUILD_OUTPUT" | grep -c "Warning:" || echo "0")
          if [ "$WARNING_COUNT" -gt 0 ]; then
            echo "‚ùå Build has $WARNING_COUNT warnings"
            echo "$BUILD_OUTPUT" | grep "Warning:"
            exit 1
          fi
          echo "‚úÖ Build passed with 0 warnings"
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-anon-key' }}
          NEXT_PUBLIC_APP_URL: 'https://aiohub.jp'
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_placeholder' }}

      - name: ‚úÖ Quality Gate Passed
        run: echo "All quality checks passed!"
