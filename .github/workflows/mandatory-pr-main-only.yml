name: ğŸ›¡ï¸ Mandatory PRâ†’Main Checks

# PR â†’ main å°‚ç”¨ã®å¿…é ˆãƒã‚§ãƒƒã‚¯ï¼ˆçµ±åˆç‰ˆï¼‰
# æ—¢å­˜ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®ç«¶åˆå›é¿
on:
  pull_request:
    branches: [main]  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã®ã¿
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '20'
  TEST_USER_EMAIL: 'test@aiohub.dev'
  TEST_USER_PASSWORD: 'TestPass123!'
  PLAYWRIGHT_BASE_URL: 'http://localhost:3000'

# åŒæ™‚å®Ÿè¡Œåˆ¶é™
concurrency:
  group: mandatory-pr-main-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # ğŸ“Š ç«¶åˆå›é¿: é‡è¤‡ãƒã‚§ãƒƒã‚¯åˆ¤å®š
  check-duplicates:
    name: ğŸ“Š Duplicate Check Prevention
    runs-on: ubuntu-latest
    outputs:
      should-skip-enhanced: ${{ steps.check.outputs.should-skip-enhanced }}
      should-skip-precommit: ${{ steps.check.outputs.should-skip-precommit }}
    steps:
      - name: ğŸ” Check running workflows
        id: check
        run: |
          echo "Checking for duplicate workflows..."
          # enhanced-ci.ymlãŒPRå¯¾è±¡ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          echo "should-skip-enhanced=false" >> $GITHUB_OUTPUT
          echo "should-skip-precommit=false" >> $GITHUB_OUTPUT

  # ğŸ”’ å¿…é ˆãƒã‚§ãƒƒã‚¯: TypeScript + ESLint + Build
  mandatory-quality:
    name: ğŸ”’ Mandatory Quality Gates
    runs-on: ubuntu-latest
    needs: check-duplicates
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      # 1ï¸âƒ£ å¿…é ˆ: TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
      - name: ğŸ”¤ TypeScript check (BLOCKING)
        run: |
          npm run typecheck || {
            echo "âŒ BLOCKING: TypeScript errors must be fixed before merge"
            exit 1
          }

      # 2ï¸âƒ£ å¿…é ˆ: ESLint ãƒã‚§ãƒƒã‚¯  
      - name: ğŸ§¹ ESLint check (BLOCKING)
        run: |
          npm run lint || {
            echo "âŒ BLOCKING: ESLint errors must be fixed before merge"
            exit 1
          }

      # 3ï¸âƒ£ å¿…é ˆ: ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      - name: ğŸ—ï¸ Build check (BLOCKING)
        run: |
          npm run build || {
            echo "âŒ BLOCKING: Build errors must be fixed before merge"
            exit 1
          }
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'placeholder-key' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://aiohub.jp' }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || 'sk_test_placeholder' }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET || 'whsec_placeholder' }}

      # 4ï¸âƒ£ ç¦æ­¢ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œæŸ»
      - name: ğŸš« Forbidden patterns check
        run: |
          npm run validate:forbidden || {
            echo "âŒ BLOCKING: Forbidden patterns detected"
            exit 1
          }

  # ğŸ­ å¿…é ˆãƒã‚§ãƒƒã‚¯: é‡è¦E2Eãƒ†ã‚¹ãƒˆ
  mandatory-e2e:
    name: ğŸ­ Mandatory E2E Tests
    runs-on: ubuntu-latest
    needs: mandatory-quality
    timeout-minutes: 20
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ­ Install Playwright
        run: npx playwright install --with-deps chromium

      - name: ğŸš€ Start application
        run: |
          npm run build
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      # 5ï¸âƒ£ å¿…é ˆ: é‡è¦E2Eãƒ†ã‚¹ãƒˆ
      - name: ğŸ­ Critical E2E Tests (BLOCKING)
        run: |
          FAILED_TESTS=""
          
          # èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆå¿…é ˆï¼‰
          npx playwright test auth-flow.spec.ts || FAILED_TESTS="$FAILED_TESTS auth-flow"
          
          # æŠ•ç¨¿ç®¡ç†ï¼ˆå¿…é ˆï¼‰
          npx playwright test posts-management.spec.ts || FAILED_TESTS="$FAILED_TESTS posts-management"
          
          # ç®¡ç†ç”»é¢ï¼ˆå¿…é ˆï¼‰
          npx playwright test admin-console.spec.ts || FAILED_TESTS="$FAILED_TESTS admin-console"
          
          # ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ±ºæ¸ˆï¼ˆå¿…é ˆï¼‰
          npx playwright test segment-billing.spec.ts || FAILED_TESTS="$FAILED_TESTS segment-billing"
          
          if [ -n "$FAILED_TESTS" ]; then
            echo "âŒ BLOCKING: Critical E2E tests failed: $FAILED_TESTS"
            echo "These features are broken and must be fixed before merge to main"
            exit 1
          fi
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          TEST_USER_EMAIL: ${{ env.TEST_USER_EMAIL }}
          TEST_USER_PASSWORD: ${{ env.TEST_USER_PASSWORD }}

      - name: ğŸ“ Upload E2E results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mandatory-e2e-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ğŸŒ¬ï¸ å¿…é ˆãƒã‚§ãƒƒã‚¯: é‡è¦APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
  mandatory-api-smoke:
    name: ğŸŒ¬ï¸ Mandatory API Smoke Tests
    runs-on: ubuntu-latest
    needs: mandatory-quality
    timeout-minutes: 10
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸš€ Start application
        run: |
          npm run build
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      # 6ï¸âƒ£ å¿…é ˆ: é‡è¦APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
      - name: ğŸŒ¬ï¸ Critical API Smoke Tests (BLOCKING)
        run: |
          node scripts/api-smoke-test-critical-verified.js || {
            echo "âŒ BLOCKING: Critical APIs are failing"
            echo "AI Analytics, Embed Widgets, or Enforcement APIs have issues"
            exit 1
          }

  # âœ… æœ€çµ‚åˆ¤å®š
  mandatory-gate:
    name: âœ… Mandatory Gate Summary
    runs-on: ubuntu-latest
    needs: [mandatory-quality, mandatory-e2e, mandatory-api-smoke]
    if: always()
    steps:
      - name: ğŸ Final gate check
        run: |
          QUALITY="${{ needs.mandatory-quality.result }}"
          E2E="${{ needs.mandatory-e2e.result }}"
          API_SMOKE="${{ needs.mandatory-api-smoke.result }}"
          
          echo "ğŸ›¡ï¸ Mandatory PRâ†’Main Gate Results:"
          echo "=================================="
          echo "ğŸ”’ Quality (TS/ESLint/Build): $QUALITY"
          echo "ğŸ­ E2E Tests: $E2E"  
          echo "ğŸŒ¬ï¸ API Smoke Tests: $API_SMOKE"
          
          if [[ "$QUALITY" != "success" || "$E2E" != "success" || "$API_SMOKE" != "success" ]]; then
            echo ""
            echo "âŒ MERGE BLOCKED: One or more mandatory checks failed"
            echo "ğŸš« This PR cannot be merged to main until all issues are resolved"
            echo ""
            echo "ğŸ“‹ Fix the following:"
            [[ "$QUALITY" != "success" ]] && echo "  - Fix TypeScript/ESLint/Build errors"
            [[ "$E2E" != "success" ]] && echo "  - Fix failing E2E tests (critical features broken)"
            [[ "$API_SMOKE" != "success" ]] && echo "  - Fix failing API smoke tests"
            echo ""
            echo "ğŸ’¡ After fixes, push changes to trigger re-check"
            exit 1
          else
            echo ""
            echo "ğŸ‰ ALL MANDATORY CHECKS PASSED!"
            echo "âœ… This PR is approved for merge to main branch"
          fi

  # ğŸš¨ å¤±æ•—é€šçŸ¥ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒPRå°‚ç”¨ï¼‰
  failure-notification:
    name: ğŸš¨ Main Branch Merge Block Notification
    runs-on: ubuntu-latest
    needs: [mandatory-gate]
    if: failure()
    steps:
      - name: ğŸ’¬ Comment merge block details
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ğŸš« MAIN BRANCH MERGE BLOCKED
            
            ã“ã®PRã¯ **main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸å¿…é ˆãƒã‚§ãƒƒã‚¯** ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚
            
            ### âŒ å¤±æ•—ã—ãŸå¿…é ˆãƒã‚§ãƒƒã‚¯
            ä»¥ä¸‹ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼š
            
            - **TypeScript ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«**: \`npm run typecheck\` ãŒæˆåŠŸã™ã‚‹
            - **ESLint ãƒã‚§ãƒƒã‚¯**: \`npm run lint\` ã§ã‚¨ãƒ©ãƒ¼ãªã—
            - **ãƒ“ãƒ«ãƒ‰æ¤œè¨¼**: \`npm run build\` ãŒæˆåŠŸã™ã‚‹  
            - **é‡è¦E2Eãƒ†ã‚¹ãƒˆ**: èªè¨¼ãƒ»æŠ•ç¨¿ãƒ»ç®¡ç†ãƒ»æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ãŒå‹•ä½œã™ã‚‹
            - **é‡è¦APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ**: AIãƒ»åŸ‹ã‚è¾¼ã¿ãƒ»ç›£æŸ»APIãŒå¿œç­”ã™ã‚‹
            
            ### ğŸ”§ ä¿®æ­£æ‰‹é †
            1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è©²å½“ã™ã‚‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
            2. ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ã‚’ä¿®æ­£
            3. PRã‚’æ›´æ–°ï¼ˆpushï¼‰ã—ã¦å†ãƒã‚§ãƒƒã‚¯
            4. ã™ã¹ã¦ç·‘ã«ãªã‚‹ã¾ã§ä¿®æ­£ã‚’ç¹°ã‚Šè¿”ã™
            
            ### âš ï¸ é‡è¦ãªæ³¨æ„
            - **main ãƒ–ãƒ©ãƒ³ãƒã¯æœ¬ç•ªç’°å¢ƒ**ã«ç›´çµã—ã¾ã™
            - å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ãƒ‘ã‚¹ã—ãªã„ã‚³ãƒ¼ãƒ‰ã¯ãƒãƒ¼ã‚¸ã§ãã¾ã›ã‚“
            - ç·Šæ€¥æ™‚ä»¥å¤–ã¯ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–ã—ãªã„ã§ãã ã•ã„
            
            ---
            *ğŸ¤– AIOHub Mandatory Quality Gate*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });