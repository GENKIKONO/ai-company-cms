name: ğŸ” Pre-commit Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pre-commit-check:
    name: ğŸš¨ Pre-commit Validation
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # ãƒ•ãƒ«ãƒ’ã‚¹ãƒˆãƒªãƒ¼ã‚’å–å¾—ï¼ˆå·®åˆ†è§£æã®ãŸã‚ï¼‰
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“² Install dependencies
        run: npm ci

      - name: ğŸ“‹ Get changed files
        id: changed-files
        run: |
          # PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ğŸ” Changed files in this PR:"
          git diff --name-only origin/${{ github.base_ref }}...HEAD

      - name: ğŸ”¤ TypeScript check on changed files
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸTSãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
          CHANGED_TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)
          if [ -n "$CHANGED_TS_FILES" ]; then
            echo "ğŸ” Checking TypeScript for changed files:"
            echo "$CHANGED_TS_FILES"
            # å…¨ä½“ã®typecheckã‚’å®Ÿè¡Œï¼ˆéƒ¨åˆ†ãƒã‚§ãƒƒã‚¯ã¯è¤‡é›‘ãªãŸã‚ï¼‰
            npm run typecheck
          else
            echo "âœ… No TypeScript files changed"
          fi

      - name: ğŸ§¹ ESLint on changed files
        run: |
          CHANGED_JS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|jsx|ts|tsx)$' || true)
          if [ -n "$CHANGED_JS_FILES" ]; then
            echo "ğŸ” Running ESLint on changed files:"
            echo "$CHANGED_JS_FILES" | xargs npx eslint || true
            echo "ğŸ“Š ESLint summary for changed files:"
            echo "$CHANGED_JS_FILES" | xargs npx eslint --format compact || true
          else
            echo "âœ… No JavaScript/TypeScript files changed"
          fi

      - name: ğŸ¨ Prettier check on changed files
        run: |
          CHANGED_FORMATTABLE_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(js|jsx|ts|tsx|json|md|yml|yaml)$' || true)
          if [ -n "$CHANGED_FORMATTABLE_FILES" ]; then
            echo "ğŸ” Checking Prettier formatting for changed files:"
            echo "$CHANGED_FORMATTABLE_FILES" | xargs npx prettier --check || true
          else
            echo "âœ… No formattable files changed"
          fi

      - name: ğŸš« Check for forbidden patterns
        run: |
          echo "ğŸ” Checking for forbidden patterns in changed files:"
          
          # org_id ã®ä½¿ç”¨ãƒã‚§ãƒƒã‚¯
          CHANGED_TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '\.(ts|tsx)$' || true)
          if [ -n "$CHANGED_TS_FILES" ]; then
            echo "Checking for org_id usage in changed files:"
            echo "$CHANGED_TS_FILES" | xargs grep -n "org_id" || echo "âœ… No org_id usage found"
            
            echo "Checking for console statements:"
            echo "$CHANGED_TS_FILES" | xargs grep -n "console\." || echo "âœ… No console statements found"
          fi

      - name: ğŸ§ª Run tests for changed modules
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œ
          CHANGED_FILES="${{ steps.changed-files.outputs.changed-files }}"
          
          # åŸºæœ¬çš„ãªãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã¯å¸¸ã«å®Ÿè¡Œ
          npm run test:unit
          
          # E2Eãƒ†ã‚¹ãƒˆã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦
          if echo "$CHANGED_FILES" | grep -E "(auth|login)" > /dev/null; then
            echo "ğŸ­ Auth-related changes detected, running auth E2E tests"
            npm run test:e2e:critical || true
          fi
          
          if echo "$CHANGED_FILES" | grep -E "(billing|stripe|segment)" > /dev/null; then
            echo "ğŸ’³ Billing-related changes detected, running billing E2E tests"
            npm run test:e2e:billing || true
          fi
          
          if echo "$CHANGED_FILES" | grep -E "(admin|management)" > /dev/null; then
            echo "ğŸ‘‘ Admin-related changes detected, running admin E2E tests"
            npm run test:e2e:admin || true
          fi

      - name: ğŸ“Š Generate PR quality report
        run: |
          echo "# ğŸ“Š PR Quality Report" > pr-quality-report.md
          echo "" >> pr-quality-report.md
          echo "**PR:** #${{ github.event.number }}" >> pr-quality-report.md
          echo "**Branch:** \`${{ github.head_ref }}\`" >> pr-quality-report.md
          echo "**Base:** \`${{ github.base_ref }}\`" >> pr-quality-report.md
          echo "**Commit:** \`${{ github.sha }}\`" >> pr-quality-report.md
          echo "" >> pr-quality-report.md
          echo "## ğŸ“ Changed Files" >> pr-quality-report.md
          echo "\`\`\`" >> pr-quality-report.md
          git diff --name-only origin/${{ github.base_ref }}...HEAD >> pr-quality-report.md
          echo "\`\`\`" >> pr-quality-report.md
          echo "" >> pr-quality-report.md
          echo "## ğŸ” Quality Checks" >> pr-quality-report.md
          echo "- âœ… TypeScript compilation" >> pr-quality-report.md
          echo "- ğŸ” ESLint analysis (see details above)" >> pr-quality-report.md
          echo "- ğŸ¨ Prettier formatting check" >> pr-quality-report.md
          echo "- ğŸš« Forbidden pattern check" >> pr-quality-report.md
          echo "- ğŸ§ª Relevant test execution" >> pr-quality-report.md

      - name: ğŸ“ Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: pr-quality-report
          path: pr-quality-report.md
          retention-days: 7

      - name: ğŸ’¬ Comment PR with quality summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('pr-quality-report.md')) {
              const report = fs.readFileSync('pr-quality-report.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `${report}\n\n---\n*Generated by AIOHub CI/CD Pipeline*`
              });
            }