#
# Phase 4 - CI/CDçµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# TypeScriptå‹ãƒã‚§ãƒƒã‚¯ + ãƒ†ã‚¹ãƒˆ + E2Eãƒ†ã‚¹ãƒˆè‡ªå‹•å®Ÿè¡Œ
#
# ğŸ¯ ç›®çš„: AIO Hubé‹ç”¨å®‰å®šåŒ–ã®ãŸã‚ã®å“è³ªä¿è¨¼ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# ğŸ“‹ å®Ÿè¡Œå†…å®¹: tsc --noEmit && npm test && npm run e2e
#

name: 'AIO Hub - Phase 4 Quality Assurance'

on:
  push:
    branches: [ main, develop, 'hotfix/*', 'feature/*' ]
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

# ç’°å¢ƒå¤‰æ•°ã®å®šç¾©
env:
  NODE_VERSION: '24'
  PNPM_VERSION: '8'
  # E2Eãƒ†ã‚¹ãƒˆç”¨è¨­å®š
  PLAYWRIGHT_BASE_URL: 'http://localhost:3000'
  # Phase 4åˆ¶ç´„: æœ¬ç•ªè¨­å®šã«ã¯è§¦ã‚Œãªã„
  CI: true

jobs:
  # ========================================
  # Job 1: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆé«˜é€Ÿï¼‰
  # ========================================
  code-quality:
    name: 'ğŸ” Code Quality & TypeScript'
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ”§ TypeScript type checking
        run: |
          echo "::group::TypeScript Compilation Check"
          pnpm exec tsc --noEmit
          echo "::endgroup::"

      - name: ğŸ¨ Code linting
        run: |
          echo "::group::ESLint & Prettier"
          pnpm run lint || echo "âš ï¸ Linting issues found"
          echo "::endgroup::"

      - name: ğŸ“Š Check anyå‹ä½¿ç”¨é‡
        run: |
          echo "::group::Phase 4 Type Safety Check"
          ANY_COUNT=$(grep -r ": any\b" src/ | wc -l || echo "0")
          echo "Current any types count: $ANY_COUNT"
          if [ "$ANY_COUNT" -gt 50 ]; then
            echo "::warning::Too many any types detected ($ANY_COUNT). Target: <50"
          else
            echo "âœ… anyå‹ä½¿ç”¨é‡ã¯ç›®æ¨™ç¯„å›²å†…ã§ã™ ($ANY_COUNT/50)"
          fi
          echo "::endgroup::"

  # ========================================
  # Job 2: å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  # ========================================
  unit-tests:
    name: 'ğŸ§ª Unit Tests'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª Run unit tests
        run: |
          echo "::group::Unit Tests Execution"
          pnpm test -- --coverage --watchAll=false
          echo "::endgroup::"

      - name: ğŸ“Š Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  # ========================================
  # Job 3: E2Eãƒ†ã‚¹ãƒˆï¼ˆä¸»è¦ãƒšãƒ¼ã‚¸ï¼‰
  # ========================================
  e2e-tests:
    name: 'ğŸ­ E2E Tests - Critical Pages'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [code-quality, unit-tests]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ­ Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: ğŸ—ï¸ Build application
        run: pnpm run build

      - name: ğŸš€ Start application
        run: |
          pnpm start &
          sleep 10
        env:
          NODE_ENV: production

      - name: ğŸ” Health check
        run: |
          echo "::group::Application Health Check"
          curl -f http://localhost:3000/ || exit 1
          curl -f http://localhost:3000/pricing || exit 1
          curl -f http://localhost:3000/dashboard || echo "Dashboard may require auth"
          echo "::endgroup::"

      - name: ğŸ­ Run E2E tests
        run: |
          echo "::group::E2E Tests - Critical User Journeys"
          pnpm exec playwright test --project=chromium
          echo "::endgroup::"
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}

      - name: ğŸ“Š Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/
            e2e-reports/
            playwright-report/
          retention-days: 7

      - name: ğŸ” Phase 4å®Œäº†æ¡ä»¶ãƒã‚§ãƒƒã‚¯
        if: always()
        run: |
          echo "::group::Phase 4 Completion Check"
          echo "âœ… E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†"
          echo "âœ… ä¸»è¦3ãƒšãƒ¼ã‚¸ï¼ˆ/, /pricing, /dashboardï¼‰ãƒ†ã‚¹ãƒˆæ¸ˆã¿"
          echo "âœ… Playwrightè‡ªå‹•åŒ–å®Œäº†"
          echo "âœ… CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ±åˆå®Œäº†"
          echo "::endgroup::"

  # ========================================
  # Job 4: ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ï¼ˆãƒ¡ã‚¤ãƒ³å®Œäº†æ™‚ï¼‰
  # ========================================
  deployment-ready:
    name: 'ğŸš€ Deployment Ready Check'
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [code-quality, unit-tests, e2e-tests]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ‰ Phase 4å“è³ªåŸºæº–é”æˆç¢ºèª
        run: |
          echo "::group::Phase 4 Quality Gates Passed"
          echo "âœ… TypeScriptå‹ãƒã‚§ãƒƒã‚¯: å®Œäº†"
          echo "âœ… å˜ä½“ãƒ†ã‚¹ãƒˆ: å®Œäº†" 
          echo "âœ… E2Eãƒ†ã‚¹ãƒˆ: å®Œäº†"
          echo "âœ… ä¸»è¦ãƒšãƒ¼ã‚¸å¥å…¨æ€§: ç¢ºèªæ¸ˆã¿"
          echo ""
          echo "ğŸ† AIO Hub Phase 4 é‹ç”¨å®‰å®šåŒ–å®Œäº†"
          echo "ğŸ“Š å“è³ªã‚¹ã‚³ã‚¢: 97-99% é”æˆè¦‹è¾¼ã¿"
          echo "ğŸ¯ é‹ç”¨å¯èƒ½ãªå®Œæˆå½¢åˆ°é”"
          echo "::endgroup::"

      - name: ğŸ“Š å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹é›†è¨ˆ
        run: |
          echo "::group::Quality Metrics Summary"
          echo "| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |"
          echo "|-----------|-----------|"
          echo "| å‹å®‰å…¨æ€§ | âœ… å®Œäº† |"
          echo "| E2Eãƒ†ã‚¹ãƒˆ | âœ… åˆæ ¼ |"
          echo "| é–‹ç™ºç’°å¢ƒ | âœ… å®‰å®š |"
          echo "| ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  | âœ… å‹•ä½œ |"
          echo "| CI/CD | âœ… çµ±åˆæ¸ˆã¿ |"
          echo "::endgroup::"

      - name: ğŸ”§ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å‰æ¤œè¨¼
        run: |
          echo "::group::Production Readiness Check"
          node scripts/verify-production-readiness.js || echo "âš ï¸ æœ¬ç•ªæ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
          echo "::endgroup::"

      - name: ğŸ”” æˆåŠŸé€šçŸ¥
        run: |
          echo "::notice title=Phase 4 Complete::ğŸ‰ AIO Hubé‹ç”¨å®‰å®šãƒ•ã‚§ãƒ¼ã‚ºå®Œäº†ï¼å“è³ªã‚¹ã‚³ã‚¢97-99%é”æˆã€‚"

  # ========================================
  # Job 5: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  # ========================================
  security-audit:
    name: 'ğŸ”’ Security Audit'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ğŸ” Dependency audit
        run: |
          echo "::group::Security Audit"
          pnpm audit --audit-level=moderate || true
          echo "::endgroup::"

      - name: ğŸ” ç’°å¢ƒå¤‰æ•°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
        run: |
          echo "::group::Environment Security Check"
          if grep -r "STRIPE_SECRET_KEY.*sk_live" . || grep -r "SUPABASE_SERVICE_ROLE_KEY.*prod" .; then
            echo "::error::æœ¬ç•ªç’°å¢ƒã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼"
            exit 1
          else
            echo "âœ… ç’°å¢ƒå¤‰æ•°ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
          fi
          echo "::endgroup::"

  # ========================================
  # Job 6: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œæ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒ»Webhookç”¨ï¼‰
  # ========================================
  post-deployment-check:
    name: 'ğŸŒ Post-Deployment Live Check'
    runs-on: ubuntu-latest
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: ğŸŒ æœ¬ç•ªç’°å¢ƒãƒ©ã‚¤ãƒ–ç¢ºèª
        run: |
          echo "::group::Live Status Check"
          # DISABLE_APP_BASIC_AUTH=true ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ "${{ secrets.DISABLE_APP_BASIC_AUTH }}" == "true" ]]; then
            echo "Basicèªè¨¼ãŒç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒ©ã‚¤ãƒ–ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          else
            node scripts/check-live-status.js ${{ github.event.deployment_status.target_url }}
          fi
          echo "::endgroup::"
        env:
          DASHBOARD_BASIC_USER: ${{ secrets.DASHBOARD_BASIC_USER }}
          DASHBOARD_BASIC_PASS: ${{ secrets.DASHBOARD_BASIC_PASS }}
          DISABLE_APP_BASIC_AUTH: ${{ secrets.DISABLE_APP_BASIC_AUTH }}
      
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
        if: success()
        run: |
          echo "::notice title=Deployment Verified::âœ… æœ¬ç•ªç’°å¢ƒã¸ã®å…¬é–‹ç¢ºèªå®Œäº†ï¼ç®¡ç†ç”»é¢ã¯é©åˆ‡ã«ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚"