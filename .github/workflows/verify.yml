name: RLS/API Verification

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

jobs:
  verify-rls-and-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create environment file
        run: |
          cat > .env.local << EOF
          NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          EOF

      - name: Verify environment variables
        run: |
          echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªä¸­..."
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" ]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_URL ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          if [ -z "${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" ]; then
            echo "âŒ NEXT_PUBLIC_SUPABASE_ANON_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          if [ -z "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" ]; then
            echo "âŒ SUPABASE_SERVICE_ROLE_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi
          echo "âœ… å…¨ã¦ã®å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™"

      - name: Create logs directory
        run: mkdir -p logs

      - name: Run RLS Schema Audit
        run: |
          echo "ğŸ” RLS/ã‚¹ã‚­ãƒ¼ãƒç›£æŸ»ã‚’å®Ÿè¡Œä¸­..."
          npm run audit:rls
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Run API Smoke Tests
        run: |
          echo "ğŸ§ª APIã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          npm run smoke:api
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Upload verification logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: verification-logs
          path: logs/
          retention-days: 30

      - name: Verification Summary
        if: always()
        run: |
          echo "ğŸ“Š æ¤œè¨¼çµæœã‚µãƒãƒª:"
          echo "================================"
          
          # RLSç›£æŸ»çµæœã®ç¢ºèª
          RLS_LOGS=$(ls logs/rls-audit-* 2>/dev/null | head -1)
          if [ -n "$RLS_LOGS" ]; then
            echo "ğŸ” RLSç›£æŸ»ãƒ­ã‚°: $RLS_LOGS"
            if grep -q '"ok": true' "$RLS_LOGS"; then
              echo "âœ… RLSç›£æŸ»: æˆåŠŸ"
            else
              echo "âŒ RLSç›£æŸ»: å¤±æ•—"
            fi
          else
            echo "âš ï¸  RLSç›£æŸ»ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          # APIãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèª
          SMOKE_LOGS=$(ls logs/smoke-* 2>/dev/null | head -1)
          if [ -n "$SMOKE_LOGS" ]; then
            echo "ğŸ§ª APIãƒ†ã‚¹ãƒˆãƒ­ã‚°: $SMOKE_LOGS"
            if grep -q '"ok": true' "$SMOKE_LOGS"; then
              echo "âœ… APIãƒ†ã‚¹ãƒˆ: æˆåŠŸ"
            else
              echo "âŒ APIãƒ†ã‚¹ãƒˆ: å¤±æ•—"
            fi
          else
            echo "âš ï¸  APIãƒ†ã‚¹ãƒˆãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
          
          echo "================================"
          echo "ğŸ“‹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:"
          ls -la logs/ 2>/dev/null || echo "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãªã—"

      - name: Check for Critical Issues
        run: |
          echo "ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          
          # RLSç„¡åŠ¹ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ¤œå‡º
          RLS_LOGS=$(ls logs/rls-audit-* 2>/dev/null | head -1)
          if [ -n "$RLS_LOGS" ]; then
            if grep -q '"rls": false' "$RLS_LOGS"; then
              echo "ğŸ”¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«: RLSãŒç„¡åŠ¹ãªãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ"
              echo "ğŸ’¡ å¯¾å‡¦: ALTER TABLE <table> ENABLE ROW LEVEL SECURITY; ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
              exit 1
            fi
          fi
          
          # å¿…é ˆã‚«ãƒ©ãƒ ä¸è¶³ã®æ¤œå‡º
          if [ -n "$RLS_LOGS" ]; then
            if grep -q '"hasColumns": false' "$RLS_LOGS"; then
              echo "ğŸ”¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«: å¿…é ˆã‚«ãƒ©ãƒ ãŒä¸è¶³ã—ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ"
              echo "ğŸ’¡ å¯¾å‡¦: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¦ãã ã•ã„"
              exit 1
            fi
          fi
          
          # APIã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã®æ¤œè¨¼
          SMOKE_LOGS=$(ls logs/smoke-* 2>/dev/null | head -1)
          if [ -n "$SMOKE_LOGS" ]; then
            # åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ãŒæˆåŠŸã—ã¦ã„ã‚‹å ´åˆï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œï¼‰
            if grep -q '"expect": "deny".*"pass": false' "$SMOKE_LOGS"; then
              echo "ğŸ”¥ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«: åŒ¿åã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã™ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰"
              echo "ğŸ’¡ å¯¾å‡¦: RLSãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
              exit 1
            fi
          fi
          
          echo "âœ… ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãªå•é¡Œã¯ç™ºè¦‹ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"

  # é€šçŸ¥ã‚¸ãƒ§ãƒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: verify-rls-and-api
    if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Notify on main branch failure
        run: |
          echo "ğŸš¨ ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã§RLS/APIæ¤œè¨¼ãŒå¤±æ•—ã—ã¾ã—ãŸ"
          echo "ğŸ”— è©³ç´°: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "âš ï¸  æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„"
          
          # Slack/Discordé€šçŸ¥ãªã©ã‚’ã“ã“ã«è¿½åŠ å¯èƒ½
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"RLS/API verification failed on main branch"}' \
          #   YOUR_WEBHOOK_URL