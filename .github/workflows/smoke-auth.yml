name: Auth Smoke Test (Health Only)

on:
  # 本番デプロイ成功後のみ
  deployment_status:

  # 手動実行
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Target URL (default: https://aiohub.jp)'
        required: false
        default: 'https://aiohub.jp'

  # 定期実行（毎時）
  schedule:
    - cron: '0 * * * *'

env:
  BASE_URL: ${{ github.event.inputs.base_url || 'https://aiohub.jp' }}

jobs:
  smoke-auth:
    name: Auth Smoke Test (No Login)
    runs-on: ubuntu-latest

    # deployment_status の場合は success のときだけ実行
    if: |
      github.event_name != 'deployment_status' ||
      github.event.deployment_status.state == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run Auth Health Smoke Test
        env:
          CI: 'true'
        run: |
          set -e
          echo "Running auth health smoke test against $BASE_URL"

          echo "1. GET /api/auth/login (route exists)"
          curl -fsS "$BASE_URL/api/auth/login" > /dev/null

          echo "2. GET /api/health/supabase-env"
          curl -fsS "$BASE_URL/api/health/supabase-env" > /dev/null

          echo "3. GET /api/health/auth-snapshot"
          curl -fsS "$BASE_URL/api/health/auth-snapshot" > /dev/null

          echo "4. GET /api/health/dashboard-probe"
          curl -fsS "$BASE_URL/api/health/dashboard-probe" > /dev/null

          echo "Auth smoke test (health-only) PASSED"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Auth health smoke test failed. Check endpoint availability or server errors."
