name: Auth Smoke Test (Health Only)

on:
  # 本番デプロイ成功後のみ
  deployment_status:

  # 手動実行
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Target URL (default: https://aiohub.jp)'
        required: false
        default: 'https://aiohub.jp'

env:
  BASE_URL: ${{ github.event.inputs.base_url || 'https://aiohub.jp' }}

jobs:
  smoke-auth-health:
    name: Auth Health Check
    runs-on: ubuntu-latest

    # deployment_status の場合は success のときだけ実行
    if: |
      github.event_name != 'deployment_status' ||
      github.event.deployment_status.state == 'success'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Auth Health Smoke Test
        run: |
          set -e
          echo "=== Auth Smoke Test (Health Only) ==="
          echo "Base URL: $BASE_URL"
          echo ""

          # 0. /auth/signin が 308 リダイレクトを返すことを確認
          echo "0. Checking /auth/signin returns 308 redirect..."
          SIGNIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/auth/signin")
          if [ "$SIGNIN_STATUS" = "308" ] || [ "$SIGNIN_STATUS" = "307" ]; then
            echo "   OK: /auth/signin returns $SIGNIN_STATUS"
          else
            echo "   FAIL: /auth/signin returns $SIGNIN_STATUS (expected 307 or 308)"
            exit 1
          fi

          # 1. /api/auth/login ルート存在確認
          echo "1. Checking /api/auth/login route exists..."
          curl -fsS "$BASE_URL/api/auth/login" > /dev/null
          echo "   OK: GET /api/auth/login returns 200"

          # 2. /api/health/supabase-env 確認
          echo "2. Checking /api/health/supabase-env..."
          curl -fsS "$BASE_URL/api/health/supabase-env" > /dev/null
          echo "   OK: GET /api/health/supabase-env returns 200"

          # 3. /api/health/auth-snapshot 確認
          echo "3. Checking /api/health/auth-snapshot..."
          curl -fsS "$BASE_URL/api/health/auth-snapshot" > /dev/null
          echo "   OK: GET /api/health/auth-snapshot returns 200"

          # 4. /api/health/dashboard-probe 確認
          echo "4. Checking /api/health/dashboard-probe..."
          curl -fsS "$BASE_URL/api/health/dashboard-probe" > /dev/null
          echo "   OK: GET /api/health/dashboard-probe returns 200"

          echo ""
          echo "=== Auth Health Check passed ==="

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Auth health smoke test failed. Check endpoint availability or server errors."
