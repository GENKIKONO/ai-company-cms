# =========================================================
# RLS Policy Validation - GitHub Actions Workflow
# AIOHub Phase 3 - EPIC 3-2
# =========================================================

name: RLS Policy Validation

on:
  push:
    branches: [main, develop]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/policies/**'
      - 'supabase/functions/**'
  pull_request:
    branches: [main]
    paths:
      - 'supabase/migrations/**' 
      - 'supabase/policies/**'
      - 'supabase/functions/**'

jobs:
  rls-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´å–å¾—ï¼ˆå·®åˆ†æ¤œå‡ºç”¨ï¼‰
      
      - name: Setup Supabase CLI
        run: |
          curl -fsSL https://github.com/supabase/cli/releases/download/v1.100.0/supabase_linux_amd64.tar.gz | tar -xz
          sudo mv supabase /usr/local/bin/
          supabase --version
      
      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨ï¼ˆå¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
      - name: Apply database migrations
        if: ${{ github.event_name == 'push' || github.event_name == 'pull_request' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ãƒªãƒ³ã‚¯
          supabase link --project-ref ${{ vars.SUPABASE_PROJECT_REF }}
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨
          echo "Applying migrations..."
          supabase db push
          
          # Edge Functions ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆRLS TesterãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆï¼‰
          if git diff --name-only HEAD~1 | grep -q "supabase/functions/rls-tester"; then
            echo "RLS Tester function updated, deploying..."
            supabase functions deploy rls-tester
          fi
      
      # RLS ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: Run RLS Policy Tests
        id: rls-test
        env:
          SUPABASE_URL: ${{ vars.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ vars.SUPABASE_ANON_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Starting RLS policy validation..."
          
          # RLS Tester Edge Function ã‚’å‘¼ã³å‡ºã—
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$SUPABASE_URL/functions/v1/rls-tester" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"trigger_source\": \"github-actions\",
              \"git_commit\": \"$GITHUB_SHA\",
              \"git_branch\": \"$GITHUB_REF_NAME\",
              \"environment\": \"${{ github.event_name == 'push' && 'staging' || 'pr-test' }}\"
            }")
          
          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹åˆ†é›¢ï¼ˆæœ€å¾Œã®è¡ŒãŒHTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼‰
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response Body: $BODY"
          
          # ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ç¢ºèª
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ Edge Function call failed with status $HTTP_CODE"
            echo "::error::RLS Tester Edge Function failed: $BODY"
            exit 1
          fi
          
          # JSON ãƒ‘ãƒ¼ã‚¹ï¼ˆjqä½¿ç”¨ï¼‰
          echo "$BODY" > /tmp/rls_test_result.json
          
          TOTAL=$(echo "$BODY" | jq -r '.total // 0')
          PASSED=$(echo "$BODY" | jq -r '.passed // 0')
          FAILED=$(echo "$BODY" | jq -r '.failed // 0')
          ERROR_COUNT=$(echo "$BODY" | jq -r '.error // 0')
          SUCCESS_RATE=$(echo "$BODY" | jq -r '.success_rate // 0')
          TEST_RUN_ID=$(echo "$BODY" | jq -r '.test_run_id // "unknown"')
          STATUS=$(echo "$BODY" | jq -r '.status // "UNKNOWN"')
          
          # çµæœã‚µãƒãƒªãƒ¼å‡ºåŠ›
          echo "ğŸ” RLS Policy Test Results"
          echo "=========================="
          echo "Test Run ID: $TEST_RUN_ID"
          echo "Total scenarios: $TOTAL"
          echo "âœ… Passed: $PASSED"
          echo "âŒ Failed: $FAILED"
          echo "ğŸ”¥ Errors: $ERROR_COUNT"
          echo "ğŸ“Š Success rate: $SUCCESS_RATE%"
          echo "Status: $STATUS"
          echo "=========================="
          
          # GitHub Step Outputè¨­å®š
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "error_count=$ERROR_COUNT" >> $GITHUB_OUTPUT
          echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
          echo "test_run_id=$TEST_RUN_ID" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          
          # CIåˆ¤å®š: å¤±æ•—ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ CI ã‚’å¤±æ•—ã•ã›ã‚‹
          if [ "$FAILED" -gt 0 ] || [ "$ERROR_COUNT" -gt 0 ] || [ "$STATUS" = "FAILED" ]; then
            echo "::error::RLS Policy validation failed - $FAILED failed scenarios, $ERROR_COUNT errors"
            echo "::notice::Check the Super Admin Console for detailed results: $SUPABASE_URL/admin/console"
            exit 1
          fi
          
          # æˆåŠŸç‡ãŒ90%æœªæº€ã®å ´åˆã‚‚è­¦å‘Š
          if [ "$(echo "$SUCCESS_RATE < 90" | bc -l)" = "1" ]; then
            echo "::warning::RLS Policy success rate is below 90% ($SUCCESS_RATE%)"
          fi
          
          echo "âœ… All RLS policy tests passed successfully!"
      
      # PRã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼ˆPull Requestæ™‚ã®ã¿ï¼‰
      - name: Comment on PR
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        env:
          TOTAL: ${{ steps.rls-test.outputs.total }}
          PASSED: ${{ steps.rls-test.outputs.passed }}
          FAILED: ${{ steps.rls-test.outputs.failed }}
          ERROR_COUNT: ${{ steps.rls-test.outputs.error_count }}
          SUCCESS_RATE: ${{ steps.rls-test.outputs.success_rate }}
          TEST_RUN_ID: ${{ steps.rls-test.outputs.test_run_id }}
          STATUS: ${{ steps.rls-test.outputs.status }}
        with:
          script: |
            const { TOTAL, PASSED, FAILED, ERROR_COUNT, SUCCESS_RATE, TEST_RUN_ID, STATUS } = process.env;
            
            const statusEmoji = STATUS === 'COMPLETED' ? 'âœ…' : 'âŒ';
            const successEmoji = FAILED == 0 && ERROR_COUNT == 0 ? 'ğŸ‰' : 'âš ï¸';
            
            const comment = `
            ## ${statusEmoji} RLS Policy Validation Results
            
            **Test Run ID:** \`${TEST_RUN_ID}\`
            
            | Metric | Value |
            |--------|-------|
            | ğŸ“Š Total Scenarios | ${TOTAL} |
            | âœ… Passed | ${PASSED} |
            | âŒ Failed | ${FAILED} |
            | ğŸ”¥ Errors | ${ERROR_COUNT} |
            | ğŸ“ˆ Success Rate | ${SUCCESS_RATE}% |
            | ğŸ Status | ${STATUS} |
            
            ${FAILED > 0 || ERROR_COUNT > 0 ? 
              'âš ï¸ **Some RLS policies failed validation. Please review the failed scenarios in the Super Admin Console.**' : 
              'ğŸ‰ **All RLS policies are working correctly!**'
            }
            
            <details>
            <summary>ğŸ“– How to investigate issues</summary>
            
            1. Check the [Super Admin Console](${{ vars.SUPABASE_URL }}/admin/console) for detailed test results
            2. Look for scenarios with \`actual_result != expected_result\`
            3. Review RLS policies for the affected tables
            4. Test manually with the specific user roles that failed
            
            </details>
            
            ---
            *This comment was automatically generated by the RLS Policy Validation workflow.*
            `;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€å¤±æ•—æ™‚ã®ã¿ï¼‰
      - name: Notify Slack on failure
        if: ${{ failure() && github.event_name == 'push' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          TOTAL: ${{ steps.rls-test.outputs.total }}
          FAILED: ${{ steps.rls-test.outputs.failed }}
          ERROR_COUNT: ${{ steps.rls-test.outputs.error_count }}
          SUCCESS_RATE: ${{ steps.rls-test.outputs.success_rate }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"ğŸš¨ RLS Policy Validation Failed\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*RLS Policy validation failed on \`$GITHUB_REF_NAME\` branch*\n\nğŸ“Š Results:\nâ€¢ Failed: $FAILED\nâ€¢ Errors: $ERROR_COUNT\nâ€¢ Success Rate: $SUCCESS_RATE%\n\n<$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID|View workflow run>\"
                    }
                  }
                ]
              }" \
              $SLACK_WEBHOOK_URL
          fi