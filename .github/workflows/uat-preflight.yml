name: UAT Preflight Checks

on:
  pull_request:
    branches: [main]
    paths:
      - 'docs/uat/**'
      - 'scripts/uat/**'
      - '.github/workflows/uat-preflight.yml'
      - 'package.json'
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch for UAT verification'
        required: false
        default: 'chore/uat-final'

concurrency:
  group: uat-preflight-${{ github.event.pull_request.head.ref || github.ref }}
  cancel-in-progress: true

jobs:
  preflight-verification:
    name: UAT Preflight Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    env:
      # æœ¬ç•ªç’°å¢ƒè¨­å®šï¼ˆæ©Ÿå¾®æƒ…å ±ã¯Repository Secretsã‹ã‚‰å–å¾—ï¼‰
      NEXT_PUBLIC_APP_URL: "https://aiohub.jp"
      UAT_LOG_DIR: "./scripts/uat/output"
      
    outputs:
      env_check_status: ${{ steps.env-check.outputs.status }}
      dns_check_status: ${{ steps.dns-check.outputs.status }}
      endpoint_check_status: ${{ steps.endpoint-check.outputs.status }}
      overall_status: ${{ steps.summary.outputs.status }}

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: ğŸ”§ Install dependencies
        run: npm ci

      - name: ğŸ“ Create output directory
        run: |
          mkdir -p ${{ env.UAT_LOG_DIR }}
          echo "$(date '+%Y-%m-%d %H:%M:%S') UAT Preflight Started" > ${{ env.UAT_LOG_DIR }}/execution.log

      - name: ğŸ” Environment Variables Check
        id: env-check
        run: |
          echo "ğŸ”§ ç’°å¢ƒå¤‰æ•°æ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          if npm run uat:env-check > ${{ env.UAT_LOG_DIR }}/env-check.log 2>&1; then
            echo "status=PASS" >> $GITHUB_OUTPUT
            echo "âœ… ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯: PASS" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') ENV_CHECK: PASS" >> ${{ env.UAT_LOG_DIR }}/execution.log
          else
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "âŒ ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯: FAIL" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') ENV_CHECK: FAIL" >> ${{ env.UAT_LOG_DIR }}/execution.log
            echo "::error::ç’°å¢ƒå¤‰æ•°ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi
        continue-on-error: true

      - name: ğŸŒ DNS/SSL Verification
        id: dns-check
        run: |
          echo "ğŸŒ DNS/SSLæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          if npm run uat:dns-check > ${{ env.UAT_LOG_DIR }}/dns-check.log 2>&1; then
            echo "status=PASS" >> $GITHUB_OUTPUT
            echo "âœ… DNS/SSL ãƒã‚§ãƒƒã‚¯: PASS" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') DNS_CHECK: PASS" >> ${{ env.UAT_LOG_DIR }}/execution.log
          else
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "âŒ DNS/SSL ãƒã‚§ãƒƒã‚¯: FAIL" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') DNS_CHECK: FAIL" >> ${{ env.UAT_LOG_DIR }}/execution.log
            echo "::error::DNS/SSLè¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi
        continue-on-error: true

      - name: ğŸ”Œ API Endpoint Verification
        id: endpoint-check
        run: |
          echo "ğŸ”Œ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¤œè¨¼ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™..."
          if npm run uat:endpoint-check > ${{ env.UAT_LOG_DIR }}/endpoint-check.log 2>&1; then
            echo "status=PASS" >> $GITHUB_OUTPUT
            echo "âœ… APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ãƒã‚§ãƒƒã‚¯: PASS" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') ENDPOINT_CHECK: PASS" >> ${{ env.UAT_LOG_DIR }}/execution.log
          else
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "âŒ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ãƒã‚§ãƒƒã‚¯: FAIL" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') ENDPOINT_CHECK: FAIL" >> ${{ env.UAT_LOG_DIR }}/execution.log
            echo "::error::APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi
        continue-on-error: true

      - name: ğŸ“Š Generate Summary Report
        id: summary
        run: |
          echo "ğŸ“Š çµæœã‚µãƒãƒªãƒ¼ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
          
          ENV_STATUS="${{ steps.env-check.outputs.status }}"
          DNS_STATUS="${{ steps.dns-check.outputs.status }}"
          ENDPOINT_STATUS="${{ steps.endpoint-check.outputs.status }}"
          
          # ã‚«ã‚¦ãƒ³ãƒˆçµæœ
          PASS_COUNT=0
          FAIL_COUNT=0
          
          if [ "$ENV_STATUS" = "PASS" ]; then PASS_COUNT=$((PASS_COUNT + 1)); else FAIL_COUNT=$((FAIL_COUNT + 1)); fi
          if [ "$DNS_STATUS" = "PASS" ]; then PASS_COUNT=$((PASS_COUNT + 1)); else FAIL_COUNT=$((FAIL_COUNT + 1)); fi
          if [ "$ENDPOINT_STATUS" = "PASS" ]; then PASS_COUNT=$((PASS_COUNT + 1)); else FAIL_COUNT=$((FAIL_COUNT + 1)); fi
          
          # ã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          cat > ${{ env.UAT_LOG_DIR }}/summary.log << EOF
          UAT Preflight æ¤œè¨¼çµæœã‚µãƒãƒªãƒ¼
          ================================
          å®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')
          å®Ÿè¡Œãƒ–ãƒ©ãƒ³ãƒ: ${{ github.event.pull_request.head.ref || github.ref }}
          ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.sha }}
          
          æ¤œè¨¼çµæœ:
          - ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯: $ENV_STATUS
          - DNS/SSLæ¤œè¨¼: $DNS_STATUS
          - APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ¤œè¨¼: $ENDPOINT_STATUS
          
          ç·åˆçµæœ: $PASS_COUNT/3 é …ç›®åˆæ ¼
          EOF
          
          # GitHub Step Summary ã«çµæœã‚’è¿½åŠ 
          echo "## ğŸ“‹ UAT Preflight æ¤œè¨¼çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” ç’°å¢ƒå¤‰æ•° | $ENV_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ DNS/SSL | $DNS_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”Œ APIç–é€š | $ENDPOINT_STATUS |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAIL_COUNT -eq 0 ]; then
            echo "status=PASS" >> $GITHUB_OUTPUT
            echo "ğŸ‰ **å…¨ãƒã‚§ãƒƒã‚¯é …ç›®ãŒåˆæ ¼ã—ã¾ã—ãŸï¼** ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') OVERALL: PASS (3/3)" >> ${{ env.UAT_LOG_DIR }}/execution.log
          else
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "âš ï¸ **$FAIL_COUNT é …ç›®ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚** ä¿®æ­£å¾Œã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "$(date '+%Y-%m-%d %H:%M:%S') OVERALL: FAIL ($PASS_COUNT/3)" >> ${{ env.UAT_LOG_DIR }}/execution.log
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“– æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
          if [ $FAIL_COUNT -eq 0 ]; then
            echo "1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸" >> $GITHUB_STEP_SUMMARY
            echo "2. ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: \`npm run uat:critical\`" >> $GITHUB_STEP_SUMMARY
            echo "3. è©³ç´°æ‰‹é †: [docs/uat/checklists/critical.md](../docs/uat/checklists/critical.md)" >> $GITHUB_STEP_SUMMARY
          else
            echo "1. æ¤œè¨¼ãƒ­ã‚°ã‚’ç¢ºèª: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ \`uat-preflight-logs\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" >> $GITHUB_STEP_SUMMARY
            echo "2. å•é¡Œã‚’ä¿®æ­£" >> $GITHUB_STEP_SUMMARY
            echo "3. å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ CI ã‚’å†å®Ÿè¡Œ" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸ“Š Generate UAT Report
        id: generate-report
        run: |
          echo "ğŸ“Š UAT ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
          if npm run uat:report > ${{ env.UAT_LOG_DIR }}/report-generation.log 2>&1; then
            echo "status=SUCCESS" >> $GITHUB_OUTPUT
            echo "âœ… UAT ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            
            # ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’å–å¾—
            REPORT_DATE=$(date +%Y%m%d)
            REPORT_PATH="docs/uat/logs/$REPORT_DATE/uat-report.md"
            
            if [ -f "$REPORT_PATH" ]; then
              echo "report_path=$REPORT_PATH" >> $GITHUB_OUTPUT
              echo "ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆãƒ‘ã‚¹: $REPORT_PATH" >> $GITHUB_STEP_SUMMARY
              
              # ãƒ¬ãƒãƒ¼ãƒˆã®ä¸€éƒ¨ã‚’CIã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã«ã‚‚ã‚³ãƒ”ãƒ¼
              cp "$REPORT_PATH" "${{ env.UAT_LOG_DIR }}/uat-report.md"
            else
              echo "âš ï¸ ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ: $REPORT_PATH" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "status=FAILED" >> $GITHUB_OUTPUT
            echo "âŒ UAT ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ: å¤±æ•—" >> $GITHUB_STEP_SUMMARY
            echo "::warning::ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™ã€‚"
          fi
        continue-on-error: true

      - name: ğŸ“‚ Upload UAT Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uat-preflight-logs
          path: ${{ env.UAT_LOG_DIR }}/
          retention-days: 30

      - name: ğŸ’¬ Enhanced PR Comment with Release Decision
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const envStatus = '${{ steps.env-check.outputs.status }}';
            const dnsStatus = '${{ steps.dns-check.outputs.status }}';
            const endpointStatus = '${{ steps.endpoint-check.outputs.status }}';
            const overallStatus = '${{ steps.summary.outputs.status }}';
            const reportGenStatus = '${{ steps.generate-report.outputs.status }}';
            const reportPath = '${{ steps.generate-report.outputs.report_path }}';
            
            const statusIcon = (status) => status === 'PASS' || status === 'SUCCESS' ? 'âœ…' : 'âŒ';
            
            // ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
            const criticalTestsPassed = 4; // ãƒ€ãƒŸãƒ¼å€¤ - å®Ÿéš›ã¯æ‰‹å‹•ãƒ†ã‚¹ãƒˆå¾Œã«è¨­å®š
            const criticalTestsRequired = 4;
            const isReleasable = (overallStatus === 'PASS' && criticalTestsPassed >= criticalTestsRequired);
            
            // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ±ºå®š
            let nextActions = '';
            let releaseDecision = '';
            
            if (overallStatus === 'PASS') {
              if (isReleasable) {
                releaseDecision = 'ğŸŸ¢ **æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å¯èƒ½**';
                nextActions = `
            ğŸ“‹ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
            1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸
            2. æ‰‹å‹•ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: \`npm run uat:critical\`
            3. ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ« 4/4 æˆåŠŸå¾Œã€æœ¬ç•ªãƒªãƒªãƒ¼ã‚¹å®Ÿè¡Œ
            
            ğŸ“– **æ‰‹é †è©³ç´°**: [critical.md](../docs/uat/checklists/critical.md)`;
              } else {
                releaseDecision = 'ğŸŸ¡ **äº‹å‰ãƒã‚§ãƒƒã‚¯å®Œäº† - ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå¾…ã¡**';
                nextActions = `
            ğŸ“‹ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—**:
            1. ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒãƒ¼ã‚¸
            2. æ‰‹å‹•ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: \`npm run uat:critical\`
            3. å…¨4é …ç›®æˆåŠŸå¾Œã€ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šæ›´æ–°
            
            âš ï¸ **æ³¨æ„**: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ 4/4 æˆåŠŸã¾ã§ã¯ãƒªãƒªãƒ¼ã‚¹å»¶æœŸ`;
              }
            } else {
              releaseDecision = 'ğŸ”´ **ãƒªãƒªãƒ¼ã‚¹å»¶æœŸ - äº‹å‰ãƒã‚§ãƒƒã‚¯å¤±æ•—**';
              nextActions = `
            ğŸ“‹ **å¿…è¦ãªå¯¾å¿œ**:
            1. æ¤œè¨¼ãƒ­ã‚°ç¢ºèª: Artifacts \`uat-preflight-logs\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            2. å•é¡Œä¿®æ­£ (ç’°å¢ƒå¤‰æ•°/DNS/APIè¨­å®š)
            3. å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦CIå†å®Ÿè¡Œ
            4. å…¨ã¦è§£æ±ºå¾Œã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã«é€²è¡Œ`;
            }
            
            // ãƒ¬ãƒãƒ¼ãƒˆæƒ…å ±
            const reportSection = reportGenStatus === 'SUCCESS' && reportPath ? 
              `
            ## ğŸ“Š è‡ªå‹•ç”Ÿæˆãƒ¬ãƒãƒ¼ãƒˆ
            
            âœ… UATçµæœãƒ¬ãƒãƒ¼ãƒˆãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
            - **ãƒ¬ãƒãƒ¼ãƒˆãƒ‘ã‚¹**: \`${reportPath}\`
            - **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆ**: [uat-preflight-logs](../actions) ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½
            - **ãƒ­ãƒ¼ã‚«ãƒ«ç”Ÿæˆ**: \`npm run uat:report\` ã§æœ€æ–°ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ` 
              : 
              `
            ## ğŸ“Š ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆçŠ¶æ³
            
            ${reportGenStatus === 'FAILED' ? 'âŒ' : 'âš ï¸'} ãƒ¬ãƒãƒ¼ãƒˆè‡ªå‹•ç”Ÿæˆã«å•é¡ŒãŒç™ºç”Ÿ
            - **æ‰‹å‹•ç”Ÿæˆ**: \`npm run uat:report\` ã§ä½œæˆã—ã¦ãã ã•ã„
            - **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: \`docs/uat/templates/report.md\``;
            
            const comment = `## ğŸ§ª UAT Preflight æ¤œè¨¼çµæœ
            
            ### ğŸ“‹ äº‹å‰ãƒã‚§ãƒƒã‚¯çµæœ
            | ãƒã‚§ãƒƒã‚¯é …ç›® | çµæœ | è©³ç´° |
            |-------------|------|------|
            | ${statusIcon(envStatus)} ç’°å¢ƒå¤‰æ•°ãƒã‚§ãƒƒã‚¯ | **${envStatus}** | æœ¬ç•ªç’°å¢ƒè¨­å®šã®æ¤œè¨¼ |
            | ${statusIcon(dnsStatus)} DNS/SSLæ¤œè¨¼ | **${dnsStatus}** | aiohub.jp ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨è¨¼æ˜æ›¸ |
            | ${statusIcon(endpointStatus)} APIç–é€šç¢ºèª | **${endpointStatus}** | å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ç–é€šç¢ºèª |
            
            ### ğŸ¯ ãƒªãƒªãƒ¼ã‚¹åˆ¤å®š
            
            ${releaseDecision}
            
            ${nextActions}
            ${reportSection}
            
            ---
            
            ### ğŸ”§ å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰å‚è€ƒ
            - **äº‹å‰ãƒã‚§ãƒƒã‚¯**: \`npm run uat:preflight\`
            - **ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ**: \`npm run uat:report\`
            - **ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ**: \`npm run uat:critical\`
            
            ### ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
            - [ğŸ“‹ å®Ÿè¡Œã‚¬ã‚¤ãƒ‰](../docs/uat/runner.md)
            - [ğŸ”´ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ](../docs/uat/checklists/critical.md)
            - [ğŸ¯ UATæœ€çµ‚ç‰ˆæ‰‹é †æ›¸](../docs/uat/uat_final.md)
            
            ---
            *ğŸ¤– ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ğŸš¨ Fail job if checks failed
        if: steps.summary.outputs.status == 'FAIL'
        run: |
          echo "::error::UAT Preflight æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          exit 1

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Run security audit
        run: |
          npm audit --audit-level=high
        continue-on-error: true