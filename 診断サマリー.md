# ダッシュボード不整合診断レポート

## 実行概要
- **実行日時**: 2025-10-06
- **実行範囲**: フェーズA診断（実装禁止、調査のみ）
- **対象**: ダッシュボード404、PGRST201エラー、ダミー値、組織取得エラー

## 🔍 調査結果サマリー

### 1. クエリとFKの衝突調査
**🚨 PGRST201エラーの根本原因を特定**

- **問題箇所**: `src/lib/organizations.ts:66`
- **詳細**: `created_by:users(full_name, email)` の embed クエリ
- **原因**: organizationsテーブルに複数のusersテーブルへの外部キー関係が存在
  - `created_by` カラム → `auth.users(id)`
  - embed クエリが複数FK関係で曖昧になりPGRST201エラー

**検出された外部キー関係**:
```sql
-- organizations テーブル内
created_by UUID REFERENCES auth.users(id)

-- 他テーブルでも users への FK 多数検出
-- 78+ 箇所で REFERENCES.*users パターン確認
```

### 2. 404経路調査
**✅ ルート自体は存在、認証・権限で404の可能性**

**存在確認済みルート**:
- `/dashboard/services/new/page.tsx` ✅
- `/dashboard/case-studies/new/page.tsx` ✅ 
- `/dashboard/posts/new/page.tsx` ✅
- `/dashboard/faqs/new/page.tsx` ✅

**middleware.ts 認証フロー**:
- `PROTECTED_PREFIXES = ['/dashboard']` (line 19)
- 未認証で `/dashboard/*` → `/auth/login` にリダイレクト
- 認証エラー時に404に見える可能性

**リンク整合性**: TabbedDashboard.tsx で正しいパス指定確認

### 3. ダミー値の実装箇所特定
**⚠️ 限定的なダミー値が残存**

**主要検出箇所**:
1. **CheckoutSessionManager.tsx:22**
   ```typescript
   setup_fee_amount: 50000, // Default 50,000 JPY
   ```

2. **Ops/Monitoring系**:
   - `/ops/monitoring/page.tsx:65` - `mockData` オブジェクト
   - `/ops/site/page.tsx:38-39` - mock access/refresh tokens
   - `/api/analytics/performance/route.ts` - `generateMockStats` 関数

3. **Testing/Development Helpers**:
   - `/lib/testing/test-utils.ts` - Jest mock functions
   - `/lib/development-helpers.ts` - development mock utilities
   - `/lib/monitoring.ts:333` - mock metrics for fallback

**ダッシュボード本体**: PerformanceMetrics.tsx は実データ使用に移行済み

### 4. 公開/非公開トグルの実態調査
**✅ 実装済み、organizations単位でステータス管理**

**実装箇所**:
- **関数**: `src/lib/organizations.ts:141` - `updateOrganizationStatus`
- **UI**: `src/app/organizations/[id]/page.tsx:204-213` - `handleStatusChange`
- **状態**: `'draft' | 'published' | 'archived'`

**統合確認**:
- getOrganizationBySlug (line 192): `status = 'published'` フィルタ
- globalSearch (line 275): public検索で published のみ
- preflight システム (line 66): `canPublish` 権限チェック

## 🎯 クリティカル問題

### Priority 1: PGRST201 FK衝突
- **影響度**: 🔥 High - 組織データ取得が全面的に失敗
- **対象**: `src/lib/organizations.ts:66` の embed クエリ
- **推定解決策**: FK明示的指定 or embed 分離

### Priority 2: 認証関連404
- **影響度**: ⚠️ Medium - ユーザビリティ低下
- **対象**: middleware.ts の認証フロー
- **推定解決策**: エラーハンドリング改善

### Priority 3: Ops系ダミー値
- **影響度**: 📊 Low - 開発・監視データのみ影響
- **対象**: `/ops/*` と analytics API
- **推定解決策**: 段階的実データ移行

## 📋 Phase B 修正計画案

1. **FK衝突解決** (最優先)
   - organizations.ts embed クエリの修正
   - PGRST201エラー検証

2. **認証404改善**
   - middleware のエラーハンドリング強化
   - 適切な認証状態表示

3. **残存ダミー値クリーンアップ**
   - CheckoutSessionManager の default値設定可能化
   - Ops系 mock→real data 移行

## 🔧 技術詳細

### 検索実行コマンド履歴
```bash
# FK関係調査
grep -r "REFERENCES.*users\|users.*REFERENCES" supabase/**/*.sql

# 404ルート確認  
find src/app/dashboard -name "page.tsx" -path "*/new/*"

# ダミー値検出
grep -r "dummy\|mock\|fake" src/ --include="*.tsx"

# 状態管理調査
grep -r "updateOrganizationStatus\|status.*toggle" src/
```

### 環境情報
- **Next.js**: App Router
- **Supabase**: PostgREST API + RLS
- **認証**: middleware.ts による保護
- **状態管理**: organizations テーブル中心設計

---
**Phase A 診断完了** - 実装フェーズ B への移行準備完了