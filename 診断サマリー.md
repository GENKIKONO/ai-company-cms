# ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ä¸æ•´åˆè¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

## å®Ÿè¡Œæ¦‚è¦
- **å®Ÿè¡Œæ—¥æ™‚**: 2025-10-06
- **å®Ÿè¡Œç¯„å›²**: ãƒ•ã‚§ãƒ¼ã‚ºAè¨ºæ–­ï¼ˆå®Ÿè£…ç¦æ­¢ã€èª¿æŸ»ã®ã¿ï¼‰
- **å¯¾è±¡**: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰404ã€PGRST201ã‚¨ãƒ©ãƒ¼ã€ãƒ€ãƒŸãƒ¼å€¤ã€çµ„ç¹”å–å¾—ã‚¨ãƒ©ãƒ¼

## ğŸ” èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼

### 1. ã‚¯ã‚¨ãƒªã¨FKã®è¡çªèª¿æŸ»
**ğŸš¨ PGRST201ã‚¨ãƒ©ãƒ¼ã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š**

- **å•é¡Œç®‡æ‰€**: `src/lib/organizations.ts:66`
- **è©³ç´°**: `created_by:users(full_name, email)` ã® embed ã‚¯ã‚¨ãƒª
- **åŸå› **: organizationsãƒ†ãƒ¼ãƒ–ãƒ«ã«è¤‡æ•°ã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®å¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚ãŒå­˜åœ¨
  - `created_by` ã‚«ãƒ©ãƒ  â†’ `auth.users(id)`
  - embed ã‚¯ã‚¨ãƒªãŒè¤‡æ•°FKé–¢ä¿‚ã§æ›–æ˜§ã«ãªã‚ŠPGRST201ã‚¨ãƒ©ãƒ¼

**æ¤œå‡ºã•ã‚ŒãŸå¤–éƒ¨ã‚­ãƒ¼é–¢ä¿‚**:
```sql
-- organizations ãƒ†ãƒ¼ãƒ–ãƒ«å†…
created_by UUID REFERENCES auth.users(id)

-- ä»–ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚ users ã¸ã® FK å¤šæ•°æ¤œå‡º
-- 78+ ç®‡æ‰€ã§ REFERENCES.*users ãƒ‘ã‚¿ãƒ¼ãƒ³ç¢ºèª
```

### 2. 404çµŒè·¯èª¿æŸ»
**âœ… ãƒ«ãƒ¼ãƒˆè‡ªä½“ã¯å­˜åœ¨ã€èªè¨¼ãƒ»æ¨©é™ã§404ã®å¯èƒ½æ€§**

**å­˜åœ¨ç¢ºèªæ¸ˆã¿ãƒ«ãƒ¼ãƒˆ**:
- `/dashboard/services/new/page.tsx` âœ…
- `/dashboard/case-studies/new/page.tsx` âœ… 
- `/dashboard/posts/new/page.tsx` âœ…
- `/dashboard/faqs/new/page.tsx` âœ…

**middleware.ts èªè¨¼ãƒ•ãƒ­ãƒ¼**:
- `PROTECTED_PREFIXES = ['/dashboard']` (line 19)
- æœªèªè¨¼ã§ `/dashboard/*` â†’ `/auth/login` ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã«404ã«è¦‹ãˆã‚‹å¯èƒ½æ€§

**ãƒªãƒ³ã‚¯æ•´åˆæ€§**: TabbedDashboard.tsx ã§æ­£ã—ã„ãƒ‘ã‚¹æŒ‡å®šç¢ºèª

### 3. ãƒ€ãƒŸãƒ¼å€¤ã®å®Ÿè£…ç®‡æ‰€ç‰¹å®š
**âš ï¸ é™å®šçš„ãªãƒ€ãƒŸãƒ¼å€¤ãŒæ®‹å­˜**

**ä¸»è¦æ¤œå‡ºç®‡æ‰€**:
1. **CheckoutSessionManager.tsx:22**
   ```typescript
   setup_fee_amount: 50000, // Default 50,000 JPY
   ```

2. **Ops/Monitoringç³»**:
   - `/ops/monitoring/page.tsx:65` - `mockData` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
   - `/ops/site/page.tsx:38-39` - mock access/refresh tokens
   - `/api/analytics/performance/route.ts` - `generateMockStats` é–¢æ•°

3. **Testing/Development Helpers**:
   - `/lib/testing/test-utils.ts` - Jest mock functions
   - `/lib/development-helpers.ts` - development mock utilities
   - `/lib/monitoring.ts:333` - mock metrics for fallback

**ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æœ¬ä½“**: PerformanceMetrics.tsx ã¯å®Ÿãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ã«ç§»è¡Œæ¸ˆã¿

### 4. å…¬é–‹/éå…¬é–‹ãƒˆã‚°ãƒ«ã®å®Ÿæ…‹èª¿æŸ»
**âœ… å®Ÿè£…æ¸ˆã¿ã€organizationså˜ä½ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†**

**å®Ÿè£…ç®‡æ‰€**:
- **é–¢æ•°**: `src/lib/organizations.ts:141` - `updateOrganizationStatus`
- **UI**: `src/app/organizations/[id]/page.tsx:204-213` - `handleStatusChange`
- **çŠ¶æ…‹**: `'draft' | 'published' | 'archived'`

**çµ±åˆç¢ºèª**:
- getOrganizationBySlug (line 192): `status = 'published'` ãƒ•ã‚£ãƒ«ã‚¿
- globalSearch (line 275): publicæ¤œç´¢ã§ published ã®ã¿
- preflight ã‚·ã‚¹ãƒ†ãƒ  (line 66): `canPublish` æ¨©é™ãƒã‚§ãƒƒã‚¯

## ğŸ¯ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«å•é¡Œ

### Priority 1: PGRST201 FKè¡çª
- **å½±éŸ¿åº¦**: ğŸ”¥ High - çµ„ç¹”ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå…¨é¢çš„ã«å¤±æ•—
- **å¯¾è±¡**: `src/lib/organizations.ts:66` ã® embed ã‚¯ã‚¨ãƒª
- **æ¨å®šè§£æ±ºç­–**: FKæ˜ç¤ºçš„æŒ‡å®š or embed åˆ†é›¢

### Priority 2: èªè¨¼é–¢é€£404
- **å½±éŸ¿åº¦**: âš ï¸ Medium - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ä½ä¸‹
- **å¯¾è±¡**: middleware.ts ã®èªè¨¼ãƒ•ãƒ­ãƒ¼
- **æ¨å®šè§£æ±ºç­–**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„

### Priority 3: Opsç³»ãƒ€ãƒŸãƒ¼å€¤
- **å½±éŸ¿åº¦**: ğŸ“Š Low - é–‹ç™ºãƒ»ç›£è¦–ãƒ‡ãƒ¼ã‚¿ã®ã¿å½±éŸ¿
- **å¯¾è±¡**: `/ops/*` ã¨ analytics API
- **æ¨å®šè§£æ±ºç­–**: æ®µéšçš„å®Ÿãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

## ğŸ“‹ Phase B ä¿®æ­£è¨ˆç”»æ¡ˆ

1. **FKè¡çªè§£æ±º** (æœ€å„ªå…ˆ)
   - organizations.ts embed ã‚¯ã‚¨ãƒªã®ä¿®æ­£
   - PGRST201ã‚¨ãƒ©ãƒ¼æ¤œè¨¼

2. **èªè¨¼404æ”¹å–„**
   - middleware ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
   - é©åˆ‡ãªèªè¨¼çŠ¶æ…‹è¡¨ç¤º

3. **æ®‹å­˜ãƒ€ãƒŸãƒ¼å€¤ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**
   - CheckoutSessionManager ã® defaultå€¤è¨­å®šå¯èƒ½åŒ–
   - Opsç³» mockâ†’real data ç§»è¡Œ

## ğŸ”§ æŠ€è¡“è©³ç´°

### æ¤œç´¢å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰å±¥æ­´
```bash
# FKé–¢ä¿‚èª¿æŸ»
grep -r "REFERENCES.*users\|users.*REFERENCES" supabase/**/*.sql

# 404ãƒ«ãƒ¼ãƒˆç¢ºèª  
find src/app/dashboard -name "page.tsx" -path "*/new/*"

# ãƒ€ãƒŸãƒ¼å€¤æ¤œå‡º
grep -r "dummy\|mock\|fake" src/ --include="*.tsx"

# çŠ¶æ…‹ç®¡ç†èª¿æŸ»
grep -r "updateOrganizationStatus\|status.*toggle" src/
```

### ç’°å¢ƒæƒ…å ±
- **Next.js**: App Router
- **Supabase**: PostgREST API + RLS
- **èªè¨¼**: middleware.ts ã«ã‚ˆã‚‹ä¿è­·
- **çŠ¶æ…‹ç®¡ç†**: organizations ãƒ†ãƒ¼ãƒ–ãƒ«ä¸­å¿ƒè¨­è¨ˆ

---
**Phase A è¨ºæ–­å®Œäº†** - å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º B ã¸ã®ç§»è¡Œæº–å‚™å®Œäº†