'use client';

/**
 * ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŸ‹ã‚è¾¼ã¿çµ±è¨ˆè¡¨ç¤ºã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
 * ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ³ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç›£è¦–
 */

import React, { useState, useEffect, useRef } from 'react';
import { logger } from '@/lib/utils/logger';

interface RealtimeStats {
  totalActiveWidgets: number;
  currentOnlineUsers: number;
  todayTotalViews: number;
  todayTotalClicks: number;
  todayErrorCount: number;
  averageResponseTime: number;
  topPerformingOrg: {
    name: string;
    views: number;
  } | null;
  systemStatus: 'healthy' | 'warning' | 'critical';
  lastUpdated: string;
}

interface PerformanceMetric {
  timestamp: string;
  responseTime: number;
  errorRate: number;
  requestCount: number;
}

export function EmbedRealtimeStats() {
  const [stats, setStats] = useState<RealtimeStats>({
    totalActiveWidgets: 0,
    currentOnlineUsers: 0,
    todayTotalViews: 0,
    todayTotalClicks: 0,
    todayErrorCount: 0,
    averageResponseTime: 0,
    topPerformingOrg: null,
    systemStatus: 'healthy',
    lastUpdated: new Date().toISOString()
  });
  
  const [performanceHistory, setPerformanceHistory] = useState<PerformanceMetric[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const intervalRef = useRef<NodeJS.Timeout | null>(null);

  useEffect(() => {
    fetchRealtimeStats();
    
    // 30ç§’ã”ã¨ã«æ›´æ–°
    intervalRef.current = setInterval(fetchRealtimeStats, 30000);
    
    return () => {
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
    };
  }, []);

  const fetchRealtimeStats = async () => {
    try {
      const response = await fetch('/api/admin/embed/realtime-stats');
      
      if (!response.ok) {
        throw new Error('ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const result = await response.json();
      setStats(result.stats);
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å±¥æ­´ã‚’æ›´æ–°ï¼ˆæœ€æ–°20ä»¶ã¾ã§ä¿æŒï¼‰
      const newMetric: PerformanceMetric = {
        timestamp: new Date().toISOString(),
        responseTime: result.stats.averageResponseTime,
        errorRate: result.stats.todayErrorCount / Math.max(result.stats.todayTotalViews, 1) * 100,
        requestCount: result.stats.todayTotalViews
      };
      
      setPerformanceHistory(prev => 
        [...prev, newMetric].slice(-20)
      );
      
      setError(null);
      setLoading(false);
    } catch (err) {
      setError(err instanceof Error ? err.message : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
      logger.error('Failed to fetch realtime stats:', { data: err });
      setLoading(false);
    }
  };

  const getStatusColor = (status: RealtimeStats['systemStatus']) => {
    switch (status) {
      case 'healthy': return 'text-green-600 bg-green-50 border-green-200';
      case 'warning': return 'text-yellow-600 bg-yellow-50 border-yellow-200';
      case 'critical': return 'text-red-600 bg-red-50 border-red-200';
    }
  };

  const getStatusIcon = (status: RealtimeStats['systemStatus']) => {
    switch (status) {
      case 'healthy': return 'âœ…';
      case 'warning': return 'âš ï¸';
      case 'critical': return 'ğŸš¨';
    }
  };

  const formatResponseTime = (ms: number): string => {
    if (ms < 100) return `${ms.toFixed(0)}ms`;
    if (ms < 1000) return `${ms.toFixed(0)}ms`;
    return `${(ms / 1000).toFixed(1)}s`;
  };

  const calculateTrend = (history: PerformanceMetric[], key: keyof PerformanceMetric): 'up' | 'down' | 'stable' => {
    if (history.length < 2) return 'stable';
    
    const recent = history.slice(-3);
    const values = recent.map(h => typeof h[key] === 'number' ? h[key] as number : 0);
    
    if (values.length < 2) return 'stable';
    
    const trend = values[values.length - 1] - values[0];
    if (Math.abs(trend) < 0.1) return 'stable';
    
    return trend > 0 ? 'up' : 'down';
  };

  const getTrendIcon = (trend: 'up' | 'down' | 'stable', isGoodWhenUp: boolean = true) => {
    if (trend === 'stable') return 'â¡ï¸';
    if (trend === 'up') return isGoodWhenUp ? 'ğŸ“ˆ' : 'ğŸ“‰';
    return isGoodWhenUp ? 'ğŸ“‰' : 'ğŸ“ˆ';
  };

  if (loading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {[1, 2, 3, 4].map((i) => (
          <div key={i} className="bg-white border border-gray-200 rounded-lg p-6">
            <div className="animate-pulse">
              <div className="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
              <div className="h-8 bg-gray-200 rounded w-3/4"></div>
            </div>
          </div>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <div className="bg-white border border-gray-200 rounded-lg p-6">
        <div className="text-center py-8">
          <div className="text-red-500 mb-2">âš ï¸</div>
          <p className="text-gray-600 mb-4">{error}</p>
          <button
            onClick={fetchRealtimeStats}
            className="px-4 py-2 bg-[var(--aio-primary)] text-white rounded-md hover:bg-[var(--aio-primary-hover)] transition-colors"
          >
            å†è©¦è¡Œ
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ */}
      <div className={`p-4 rounded-lg border ${getStatusColor(stats.systemStatus)}`}>
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-2">
            <span className="text-xl">{getStatusIcon(stats.systemStatus)}</span>
            <span className="font-semibold">
              ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: {stats.systemStatus === 'healthy' ? 'æ­£å¸¸' : 
                              stats.systemStatus === 'warning' ? 'è­¦å‘Š' : 'ç•°å¸¸'}
            </span>
          </div>
          <div className="text-sm">
            æœ€çµ‚æ›´æ–°: {new Date(stats.lastUpdated).toLocaleTimeString('ja-JP')}
          </div>
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³çµ±è¨ˆ */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Widgetæ•° */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-medium text-gray-600">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–Widget</h3>
            <span className="text-2xl">ğŸ¯</span>
          </div>
          <div className="text-3xl font-bold text-[var(--aio-primary)] mb-1">
            {stats.totalActiveWidgets.toLocaleString()}
          </div>
          <div className="text-sm text-gray-500">
            ç¾åœ¨ç¨¼åƒä¸­
          </div>
        </div>

        {/* ä»Šæ—¥ã®ç·ãƒ“ãƒ¥ãƒ¼æ•° */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-medium text-gray-600">ä»Šæ—¥ã®ãƒ“ãƒ¥ãƒ¼</h3>
            <span className="text-xl">{getTrendIcon(calculateTrend(performanceHistory, 'requestCount'))}</span>
          </div>
          <div className="text-3xl font-bold text-green-600 mb-1">
            {stats.todayTotalViews.toLocaleString()}
          </div>
          <div className="text-sm text-gray-500">
            ã‚¯ãƒªãƒƒã‚¯: {stats.todayTotalClicks.toLocaleString()}
          </div>
        </div>

        {/* ã‚¨ãƒ©ãƒ¼ç‡ */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-medium text-gray-600">ã‚¨ãƒ©ãƒ¼ç‡</h3>
            <span className="text-xl">{getTrendIcon(calculateTrend(performanceHistory, 'errorRate'), false)}</span>
          </div>
          <div className="text-3xl font-bold text-red-600 mb-1">
            {stats.todayTotalViews > 0 ? 
              ((stats.todayErrorCount / stats.todayTotalViews) * 100).toFixed(2) : '0.00'
            }%
          </div>
          <div className="text-sm text-gray-500">
            ã‚¨ãƒ©ãƒ¼: {stats.todayErrorCount.toLocaleString()}ä»¶
          </div>
        </div>

        {/* å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ */}
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <div className="flex items-center justify-between mb-2">
            <h3 className="text-sm font-medium text-gray-600">å¿œç­”é€Ÿåº¦</h3>
            <span className="text-xl">{getTrendIcon(calculateTrend(performanceHistory, 'responseTime'), false)}</span>
          </div>
          <div className="text-3xl font-bold text-purple-600 mb-1">
            {formatResponseTime(stats.averageResponseTime)}
          </div>
          <div className="text-sm text-gray-500">
            å¹³å‡ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“
          </div>
        </div>
      </div>

      {/* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰ */}
      {performanceHistory.length > 0 && (
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒˆãƒ¬ãƒ³ãƒ‰ï¼ˆéå»10åˆ†ï¼‰
          </h3>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            {/* ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ */}
            <div>
              <h4 className="text-sm font-medium text-gray-600 mb-2">ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“</h4>
              <div className="h-20 flex items-end space-x-1">
                {performanceHistory.slice(-10).map((metric, index) => {
                  const height = Math.max((metric.responseTime / 1000) * 100, 2);
                  return (
                    <div
                      key={index}
                      className="flex-1 bg-purple-500 rounded-t progress-bar"
                      style={{ height: `${Math.min(height, 100)}%` }}
                      title={`${formatResponseTime(metric.responseTime)} at ${new Date(metric.timestamp).toLocaleTimeString()}`}
                    />
                  );
                })}
              </div>
            </div>

            {/* ã‚¨ãƒ©ãƒ¼ç‡ */}
            <div>
              <h4 className="text-sm font-medium text-gray-600 mb-2">ã‚¨ãƒ©ãƒ¼ç‡</h4>
              <div className="h-20 flex items-end space-x-1">
                {performanceHistory.slice(-10).map((metric, index) => {
                  const height = Math.max(metric.errorRate * 10, 2);
                  return (
                    <div
                      key={index}
                      className="flex-1 bg-red-500 rounded-t progress-bar"
                      style={{ height: `${Math.min(height, 100)}%` }}
                      title={`${metric.errorRate.toFixed(2)}% at ${new Date(metric.timestamp).toLocaleTimeString()}`}
                    />
                  );
                })}
              </div>
            </div>

            {/* ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•° */}
            <div>
              <h4 className="text-sm font-medium text-gray-600 mb-2">ç´¯ç©ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</h4>
              <div className="h-20 flex items-end space-x-1">
                {performanceHistory.slice(-10).map((metric, index) => {
                  const maxRequests = Math.max(...performanceHistory.map(h => h.requestCount));
                  const height = maxRequests > 0 ? (metric.requestCount / maxRequests) * 100 : 2;
                  return (
                    <div
                      key={index}
                      className="flex-1 bg-blue-500 rounded-t progress-bar"
                      style={{ height: `${Math.max(height, 2)}%` }}
                      title={`${metric.requestCount.toLocaleString()} requests at ${new Date(metric.timestamp).toLocaleTimeString()}`}
                    />
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼ */}
      {stats.topPerformingOrg && (
        <div className="bg-white border border-gray-200 rounded-lg p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">
            ğŸ† ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ¼
          </h3>
          <div className="flex items-center justify-between p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div>
              <div className="font-semibold text-gray-900">
                {stats.topPerformingOrg.name}
              </div>
              <div className="text-sm text-gray-600">
                æœ¬æ—¥ {stats.topPerformingOrg.views.toLocaleString()} ãƒ“ãƒ¥ãƒ¼
              </div>
            </div>
            <div className="text-green-600">
              <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}