import { logger } from '@/lib/log';

/**
 * AI Bot Detection Utility
 * AI/æ¤œç´¢ã‚¯ãƒ­ãƒ¼ãƒ©ã®User-Agentã‚’åˆ¤å®šã—ã¦ãƒœãƒƒãƒˆç¨®åˆ¥ã‚’è¿”ã™
 */

export interface BotDetectionResult {
  isBot: boolean;
  botName: string | null;
  category: 'ai' | 'search' | 'unknown' | null;
}

// æ—¢çŸ¥ã®AI Botãƒ‘ã‚¿ãƒ¼ãƒ³
const AI_BOT_PATTERNS = [
  { name: 'GPTBot', pattern: /GPTBot/i, category: 'ai' as const },
  { name: 'ChatGPT', pattern: /ChatGPT-User/i, category: 'ai' as const },
  { name: 'Bingbot', pattern: /bingbot/i, category: 'ai' as const },
  { name: 'PerplexityBot', pattern: /PerplexityBot/i, category: 'ai' as const },
  { name: 'Google-Extended', pattern: /Google-Extended/i, category: 'ai' as const },
  { name: 'ClaudeBot', pattern: /ClaudeBot/i, category: 'ai' as const },
  { name: 'FacebookBot', pattern: /facebookexternalhit/i, category: 'ai' as const },
  { name: 'TwitterBot', pattern: /Twitterbot/i, category: 'search' as const },
  { name: 'LinkedInBot', pattern: /LinkedInBot/i, category: 'search' as const },
  { name: 'Googlebot', pattern: /Googlebot/i, category: 'search' as const },
] as const;

/**
 * User-Agentã‹ã‚‰AI Botã‚’æ¤œçŸ¥
 */
export function detectAIBot(userAgent: string): BotDetectionResult {
  logger.info('ğŸ” [AI Bot Detection] Analyzing User-Agent:', { data: userAgent });
  
  if (!userAgent) {
    logger.info('âŒ [AI Bot Detection] No User-Agent provided');
    return { isBot: false, botName: null, category: null };
  }

  for (const bot of AI_BOT_PATTERNS) {
    if (bot.pattern.test(userAgent)) {
      logger.info('âœ… [AI Bot Detection] Bot detected:', { 
        name: bot.name, 
        category: bot.category, 
        pattern: bot.pattern.toString(),
        userAgent 
      });
      return {
        isBot: true,
        botName: bot.name,
        category: bot.category,
      };
    }
  }

  logger.info('âŒ [AI Bot Detection] No bot pattern matched for:', { data: userAgent });
  return { isBot: false, botName: null, category: null };
}

/**
 * Request Headersã‹ã‚‰Botæƒ…å ±ã‚’æŠ½å‡º
 * NextRequest.headersã¾ãŸã¯æ¨™æº–ã®Headersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾å¿œ
 */
export function extractBotInfoFromHeaders(headers: any): BotDetectionResult {
  let userAgent = '';
  
  try {
    if (headers && typeof headers.get === 'function') {
      // æ¨™æº–ã®Headersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      userAgent = headers.get('user-agent') || '';
    } else if (headers && typeof headers === 'object') {
      // NextRequest.headers (ReadonlyHeaders) - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
      userAgent = headers['user-agent'] || 
                  headers.get?.('user-agent') || 
                  '';
    }
  } catch (error) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¿”ã™
    logger.warn('Failed to extract user-agent from headers:', { data: error });
  }
  
  return detectAIBot(userAgent);
}

/**
 * ãƒ­ã‚°å¯¾è±¡ã®Botã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆAIã‚«ãƒ†ã‚´ãƒªã®ã¿ãƒ­ã‚°ï¼‰
 */
export function shouldLogBot(botResult: BotDetectionResult): boolean {
  return botResult.isBot && botResult.category === 'ai';
}

/**
 * IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆNextJSã®Headersã‹ã‚‰ï¼‰
 * NextRequest.headersã¾ãŸã¯æ¨™æº–ã®Headersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾å¿œ
 */
export function extractClientIP(headers: any): string | null {
  let forwardedFor = '';
  let realIP = '';
  let clientIP = '';
  
  try {
    if (headers && typeof headers.get === 'function') {
      // æ¨™æº–ã®Headersã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      forwardedFor = headers.get('x-forwarded-for') || '';
      realIP = headers.get('x-real-ip') || '';
      clientIP = headers.get('x-client-ip') || '';
    } else if (headers && typeof headers === 'object') {
      // NextRequest.headers (ReadonlyHeaders) - ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’è©¦è¡Œ
      forwardedFor = headers['x-forwarded-for'] || headers.get?.('x-forwarded-for') || '';
      realIP = headers['x-real-ip'] || headers.get?.('x-real-ip') || '';
      clientIP = headers['x-client-ip'] || headers.get?.('x-client-ip') || '';
    }
  } catch (error) {
    // ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯nullã‚’è¿”ã™
    logger.warn('Failed to extract IP from headers:', { data: error });
    return null;
  }

  if (forwardedFor) {
    // x-forwarded-forã¯è¤‡æ•°IPãŒã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§å…¥ã‚‹å ´åˆãŒã‚ã‚‹
    return forwardedFor.split(',')[0].trim();
  }

  return realIP || clientIP || null;
}