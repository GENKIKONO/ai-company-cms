/**
 * å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•° - SSRã§throwã—ãªã„å®Ÿè£…
 */

import { unstable_cache } from 'next/cache';
import { serverFetch } from './serverFetch';
import { logger } from '@/lib/utils/logger';

// ğŸš« ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãªã„çµ„ç¹”å–å¾—ã‚’ re-export
export { getCurrentUserOrganization } from './organizations-server';

interface SafeOrganizationData {
  id: string;
  name: string;
  is_published: boolean;
  slug?: string;
  updated_at: string;
  created_at: string;
  logo_url?: string;
}

interface SafeStatsData {
  total: number;
  draft: number;
  published: number;
  archived: number;
}

interface SafeCaseStudiesStats {
  total: number;
  published: number;
}

interface SafeDataResult<T> {
  data: T | null;
  error?: string;
  errorId?: string;
}

/**
 * è¨ºæ–­ãƒ­ã‚°ã‚’ /api/diag/ui ã«é€ä¿¡ï¼ˆå¤±æ•—ã—ã¦ã‚‚ç„¡è¦–ï¼‰
 */
async function logToDiag(errorInfo: { errorId: string; at: string; note: string }) {
  try {
    await serverFetch('/api/diag/ui', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'error',
        timestamp: new Date().toISOString(),
        ...errorInfo
      })
    });
  } catch {
    // è¨ºæ–­ãƒ­ã‚°é€ä¿¡å¤±æ•—ã¯ç„¡è¦–
  }
}

/**
 * âŒ DEPRECATED: Use getCurrentUserOrganization() from organizations-server.ts instead
 * This function is kept only for backward compatibility and will be removed
 */
export async function getMyOrganizationSafe(): Promise<SafeDataResult<SafeOrganizationData>> {
  return { 
    data: null, 
    error: 'Function deprecated - use getCurrentUserOrganization() instead' 
  };
}

/**
 * å®‰å…¨ãªçµ±è¨ˆãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å€¤ä»˜ãï¼‰
 */
export async function getOrganizationStatsSafe(): Promise<SafeDataResult<SafeStatsData>> {
  try {
    // Single-Org ãƒ¢ãƒ¼ãƒ‰ã§ã¯çµ±è¨ˆã¯å˜ç´”åŒ–
    const defaultStats: SafeStatsData = {
      total: 0,
      draft: 0,
      published: 0,
      archived: 0
    };

    return { data: defaultStats };

  } catch (error) {
    const errorId = `stats-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const errorNote = error instanceof Error ? error.message : 'Unknown error';
    
    logger.error('[getOrganizationStatsSafe] Error', { data: error instanceof Error ? error : new Error(String(error)));
    
    await logToDiag({
      errorId,
      at: 'getOrganizationStatsSafe', 
      note: errorNote
    });

    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
    return { 
      data: { total: 0, draft: 0, published: 0, archived: 0 },
      error: errorNote,
      errorId
    };
  }
}

/**
 * å®‰å…¨ãªå°å…¥äº‹ä¾‹çµ±è¨ˆå–å¾—
 */
export async function getCaseStudiesStatsSafe(orgId?: string): Promise<SafeDataResult<SafeCaseStudiesStats>> {
  try {
    if (!orgId) {
      return { data: { total: 0, published: 0 } };
    }

    const result = await serverFetch(`/api/dashboard/case-studies-stats?orgId=${orgId}`);
    
    if (!result.ok) {
      logger.warn('[getCaseStudiesStatsSafe] API returned non-ok status', { data: result.status });
      return { data: { total: 0, published: 0 } };
    }

    const stats = await result.json();
    return { data: stats };

  } catch (error) {
    const errorId = `case-studies-stats-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const errorNote = error instanceof Error ? error.message : 'Unknown error';
    
    logger.error('[getCaseStudiesStatsSafe] Error', { data: error instanceof Error ? error : new Error(String(error)));
    
    await logToDiag({
      errorId,
      at: 'getCaseStudiesStatsSafe', 
      note: errorNote
    });

    // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¿”ã™
    return { 
      data: { total: 0, published: 0 },
      error: errorNote,
      errorId
    };
  }
}

/**
 * å®‰å…¨ãªæ–‡å­—åˆ—ãƒãƒƒãƒãƒ³ã‚° - undefined.match() ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã
 */
export function safeMatch(str: unknown, regex: RegExp): RegExpMatchArray | null {
  if (typeof str !== 'string') {
    return null;
  }
  return str.match(regex);
}

/**
 * å®‰å…¨ãªãƒ†ã‚¹ãƒˆé–¢æ•° - undefined.test() ã‚¨ãƒ©ãƒ¼ã‚’é˜²ã  
 */
export function safeTest(regex: RegExp, str: unknown): boolean {
  if (typeof str !== 'string') {
    return false;
  }
  return regex.test(str);
}